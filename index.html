<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Palestra 3</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Load runtime config which is generated during build (injects GEMINI key safely) -->
    <script src="./config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            overflow-x: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #2d3748;
        }

        .app {
            max-width: 100%;
            margin: 0 auto;
            background: #f8fafc;
            min-height: 100vh;
        }

        /* HEADER */
        .header {
            background: linear-gradient(135deg, #4a5568, #2d3748);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .header h1 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .header-stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* NAVIGATION */
        .nav-tabs {
            display: flex;
            background: white;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: transparent;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #718096;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .nav-tab.active {
            color: #4a5568;
            border-bottom: 3px solid #4a5568;
            background: #f7fafc;
        }

        .nav-tab-ai {
            flex: 1;
        }

        /* PAGES */
        .page {
            display: none;
            padding: 20px;
            min-height: 70vh;
        }

        .page.active {
            display: block;
        }

        /* AI ASSISTANT PAGE STYLES */
        .ai-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .ai-header {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }

        .ai-header h2 {
            color: #2d3748;
            font-size: 1.4em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .ai-header p {
            color: #718096;
            font-size: 1em;
            line-height: 1.5;
        }

        .ai-chat-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            height: 500px;
            display: flex;
            flex-direction: column;
        }

        .ai-chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8fafc;
        }

        .ai-message {
            margin-bottom: 15px;
            animation: slideIn 0.3s ease;
        }

        .ai-message.user {
            text-align: right;
        }

        .ai-message.assistant {
            text-align: left;
        }

        .ai-message-bubble {
            display: inline-block;
            max-width: 80%;
            padding: 16px 20px;
            border-radius: 18px;
            font-size: 0.95em;
            line-height: 1.6;
            white-space: pre-line;
        }

        .ai-message.user .ai-message-bubble {
            background: #4a5568;
            color: white;
        }

        .ai-message.assistant .ai-message-bubble {
            background: white;
            color: #2d3748;
            border: 1px solid #e2e8f0;
        }

        .ai-input-container {
            padding: 20px;
            border-top: 1px solid #e2e8f0;
            background: white;
        }

        .ai-input-form {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .ai-input {
            flex: 1;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            padding: 12px 16px;
            font-size: 0.95em;
            resize: none;
            min-height: 44px;
            max-height: 120px;
            transition: border-color 0.3s ease;
        }

        .ai-input:focus {
            outline: none;
            border-color: #4a5568;
        }

        .ai-send-btn {
            background: #4a5568;
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
            transition: all 0.3s ease;
        }

        .ai-send-btn:hover {
            background: #2d3748;
            transform: scale(1.05);
        }

        .ai-send-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .ai-quick-actions {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .ai-quick-actions h3 {
            color: #2d3748;
            font-size: 1.1em;
            margin-bottom: 15px;
            text-align: center;
        }

        .ai-quick-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .ai-quick-btn {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 12px 16px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            color: #4a5568;
            transition: all 0.3s ease;
            text-align: left;
        }

        .ai-quick-btn:hover {
            border-color: #4a5568;
            background: #4a5568;
            color: white;
        }

        .ai-typing-indicator {
            display: none;
            align-items: center;
            gap: 8px;
            color: #718096;
            font-style: italic;
            margin-bottom: 15px;
        }

        .ai-typing-dots {
            display: flex;
            gap: 4px;
        }

        .ai-typing-dot {
            width: 6px;
            height: 6px;
            background: #cbd5e0;
            border-radius: 50%;
            animation: typingDot 1.4s infinite ease-in-out;
        }

        .ai-typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .ai-typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingDot {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .ai-template-preview {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }

        .ai-template-preview h4 {
            color: #2d3748;
            font-size: 1em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-template-exercises {
            list-style: none;
            margin-bottom: 15px;
        }

        .ai-template-exercises li {
            color: #4a5568;
            font-size: 0.9em;
            margin-bottom: 5px;
            padding-left: 15px;
            position: relative;
        }

        .ai-template-exercises li::before {
            content: "•";
            color: #48bb78;
            font-weight: bold;
            position: absolute;
            left: 0;
        }

        .ai-use-template-btn {
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .ai-use-template-btn:hover {
            background: #38a169;
            transform: scale(0.95);
        }

        /* PROGRESS PAGE - NEW STYLES */
        .progress-filters {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: grid;
            grid-template-columns: 1fr 1fr 2fr;
            gap: 20px;
        }

        /* MUSCLE GROUPS FILTER */
        .muscle-groups-filter {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .muscle-group-btns {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .muscle-group-btn {
            padding: 8px 16px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            color: #4a5568;
        }

        .muscle-group-btn:hover {
            border-color: #4a5568;
            background: #f7fafc;
        }

        .muscle-group-btn.active {
            background: #4a5568;
            color: white;
            border-color: #4a5568;
        }

        /* ADDITIONAL FILTERS */
        .additional-filters-section {
            margin-bottom: 20px;
        }

        .toggle-filters-btn {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.85rem;
            color: #4a5568;
            transition: all 0.3s ease;
            text-align: left;
            display: inline-block;
        }

        .toggle-filters-btn:hover {
            background: #f7fafc;
            border-color: #4a5568;
        }

        .additional-filters-content {
            margin-top: 10px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .custom-date-group {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 10px;
        }

        .custom-date-group .filter-label {
            margin-bottom: 0;
            white-space: nowrap;
        }

        .filter-label {
            font-size: 0.9em;
            font-weight: 600;
            color: #4a5568;
        }

        .filter-select {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95em;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: #4a5568;
        }

        /* CHARTS */
        .progress-charts {
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }

        .chart-title {
            color: #2d3748;
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }

        .chart-canvas {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* WORKOUT PAGE */
        .workout-title {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .workout-title h2 {
            color: #2d3748;
            font-size: 1.3em;
            margin-bottom: 5px;
        }

        .workout-date {
            color: #718096;
            font-size: 0.9em;
        }

        .Schede {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding: 5px;
        }

        .template-btn {
            flex: 0 0 auto;
            background: white;
            border: 2px solid #e2e8f0;
            padding: 12px 16px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            color: #4a5568;
            transition: all 0.3s ease;
            white-space: nowrap;
            position: relative;
        }

        .template-btn:hover {
            border-color: #4a5568;
            background: #4a5568;
            color: white;
        }

        .template-edit-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #e2e8f0;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.7em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .template-edit-btn:hover {
            background: #cbd5e0;
        }

        .template-delete-btn {
            position: absolute;
            top: -8px;
            left: -8px;
            background: #fed7d7;
            color: #e53e3e;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.7em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .template-delete-btn:hover {
            background: #feb2b2;
        }

        .exercise-card {
            background: white;
            border-radius: 12px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .exercise-header {
            padding: 12px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .exercise-name {
            font-weight: 600;
            color: #2d3748;
        }

        .exercise-controls {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .control-btn {
            background: #e2e8f0;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: #cbd5e0;
        }

        .control-btn.delete {
            background: #fed7d7;
            color: #e53e3e;
        }

        .control-btn.delete:hover {
            background: #feb2b2;
        }

        .control-btn.notes-toggle {
            background: #edf2f7;
            color: #4a5568;
        }

        .control-btn.notes-toggle.open {
            background: #4a5568;
            color: #fff;
        }

        .control-btn.notes-toggle.has-text {
            background: #c6f6d5;
            color: #22543d;
        }

        .control-btn.notes-toggle.open.has-text {
            background: #2f855a;
        }

        .exercise-inputs {
            padding: 12px;
            display: grid;
            grid-template-columns: 0.8fr 0.8fr 1.4fr;
            gap: 8px;
            align-items: end;
        }

        .cardio-placeholder {
            /* Placeholder invisibile per mantenere l'allineamento */
            visibility: hidden;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-label {
            font-size: 0.8em;
            font-weight: 500;
            color: #718096;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .input-field {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 8px;
            font-size: 0.95em;
            text-align: center;
            transition: border-color 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: #4a5568;
        }

        .input-hint {
            font-size: 0.7em;
            color: #a0aec0;
            text-align: center;
            margin-top: 2px;
            display: none;
        }

        .notes-section {
            padding: 12px;
            border-top: 1px solid #e2e8f0;
        }

        .notes-section.collapsed {
            display: none;
        }

        .notes-input {
            width: 100%;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 8px;
            font-size: 0.9em;
            resize: vertical;
            min-height: 56px;
        }

        .notes-input:focus {
            outline: none;
            border-color: #4a5568;
        }

        @media (max-width: 600px) {
            .exercise-card {
                margin-bottom: 8px;
                border-radius: 10px;
            }

            .exercise-header {
                padding: 10px 12px;
            }

            .exercise-name {
                font-size: 0.9em;
            }

            .exercise-controls {
                gap: 3px;
            }

            .control-btn {
                width: 24px;
                height: 24px;
                font-size: 0.68em;
            }

            .exercise-inputs {
                padding: 10px 12px;
                grid-template-columns: 60px 60px 1fr;
                gap: 6px;
            }

            .exercise-inputs .input-group {
                min-width: 0;
            }

            .input-label {
                display: none;
            }

            .input-field {
                padding: 6px;
                font-size: 0.9em;
            }

            .input-hint {
                display: block;
            }

            .notes-section {
                padding: 10px 12px;
            }

            .notes-input {
                min-height: 48px;
                font-size: 0.82em;
            }

            .template-edit-btn,
            .template-delete-btn {
                display: none;
            }
        }

        /* TEMPLATE EDITOR */
        .template-editor {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .template-editor h3 {
            color: #2d3748;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .template-info {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .template-exercises {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            min-height: 200px;
            padding: 15px;
        }

        .template-exercise-item {
            background: #f8fafc;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e2e8f0;
        }

        .template-exercise-info {
            flex: 1;
        }

        .template-exercise-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .template-exercise-details {
            font-size: 0.8em;
            color: #718096;
        }

        .template-exercise-controls {
            display: flex;
            gap: 5px;
        }

        .template-exercise-btn {
            background: #e2e8f0;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.7em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .template-exercise-btn:hover {
            background: #cbd5e0;
        }

        .template-exercise-btn.delete {
            background: #fed7d7;
            color: #e53e3e;
        }

        .add-template-exercise-btn {
            background: #4a5568;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            width: 100%;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .add-template-exercise-btn:hover {
            background: #2d3748;
        }

        .add-template-btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 12px;
            width: 100%;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .add-template-btn:hover {
            background: #38a169;
        }

        /* AUTOCOMPLETE */
        .autocomplete-container {
            position: relative;
        }

        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e2e8f0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .autocomplete-suggestions.show {
            display: block;
        }

        .autocomplete-suggestion {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #f7fafc;
            transition: background-color 0.2s ease;
        }

        .autocomplete-suggestion:hover,
        .autocomplete-suggestion.selected {
            background: #f7fafc;
        }

        .autocomplete-suggestion:last-child {
            border-bottom: none;
        }

        /* PROGRESS CARDS */
        .progress-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .progress-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .progress-title {
            font-weight: 600;
            color: #2d3748;
        }

        .progress-trend {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .trend-up {
            background: #c6f6d5;
            color: #22543d;
        }

        .trend-down {
            background: #fed7d7;
            color: #742a2a;
        }

        .trend-stable {
            background: #e2e8f0;
            color: #4a5568;
        }

        .progress-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #2d3748;
        }

        .stat-label {
            color: #718096;
            font-size: 0.8em;
        }

        /* CALENDAR */
        .calendar {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #2d3748;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
        }

        .calendar-nav-btn {
            background: #e2e8f0;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .calendar-nav-btn:hover {
            background: #cbd5e0;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day-header {
            text-align: center;
            padding: 10px 5px;
            font-size: 0.8em;
            font-weight: 600;
            color: #718096;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            position: relative;
        }

        .calendar-day:hover {
            background: #f1f5f9;
        }

        .calendar-day.today {
            background: #4a5568;
            color: white;
            font-weight: 600;
        }

        .calendar-day.has-workout {
            background: #c6f6d5;
            color: #22543d;
            font-weight: 600;
        }

        .calendar-day.has-workout::after {
            content: '💪';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.6em;
        }

        .calendar-day.other-month {
            color: #cbd5e0;
        }

        /* HISTORY PAGE */
        .history-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .history-item:hover {
            background: #f8fafc;
        }

        .history-content {
            flex: 1;
        }

        .history-content h3 {
            color: #2d3748;
            font-size: 1em;
            margin-bottom: 5px;
        }

        .history-workout-name {
            color: #4a5568;
            font-size: 0.9em;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .history-summary {
            color: #718096;
            font-size: 0.9em;
        }

        .history-duration {
            background: #e2e8f0;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            color: #4a5568;
            margin-right: 10px;
        }

        .history-delete-btn {
            background: #fed7d7;
            color: #e53e3e;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .history-delete-btn:hover {
            background: #feb2b2;
        }

        /* BUTTONS */
        .add-exercise-btn {
            background: #4a5568;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 12px;
            width: 100%;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .add-exercise-btn:hover {
            background: #2d3748;
        }

        .save-workout-btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 18px;
            border-radius: 12px;
            width: 100%;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .save-workout-btn:hover {
            background: #38a169;
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            z-index: 1001;
        }

        .modal-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-input {
            width: 100%;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 1em;
        }

        .modal-input:focus {
            outline: none;
            border-color: #4a5568;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn.primary {
            background: #4a5568;
            color: white;
        }

        .modal-btn.primary:hover {
            background: #2d3748;
        }

        .modal-btn.secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .modal-btn.secondary:hover {
            background: #cbd5e0;
        }

        /* REORDER LIST */
        .reorder-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            margin-bottom: 8px;
            background: #f7fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .reorder-item-name {
            flex: 1;
            font-weight: 500;
            color: #2d3748;
        }

        .reorder-controls {
            display: flex;
            gap: 5px;
        }

        .reorder-arrow-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .reorder-arrow-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .reorder-arrow-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .reorder-arrow-btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        /* MUSCLE SELECTION MODAL */
        .modal-description {
            color: #718096;
            font-size: 0.9em;
            margin-bottom: 20px;
            text-align: center;
        }

        .muscle-selection {
            margin-bottom: 20px;
        }

        .muscle-type-selection {
            margin-bottom: 20px;
        }

        .muscle-type-label {
            display: block;
            margin-bottom: 10px;
            padding: 12px;
            background: #f7fafc;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .muscle-type-label:hover {
            background: #edf2f7;
        }

        .muscle-type-label input[type="radio"] {
            margin-right: 10px;
        }

        .muscles-grid-selection h4 {
            margin-bottom: 15px;
            color: #2d3748;
            font-size: 1em;
        }

        .muscles-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
        }

        .muscle-checkbox {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: #f7fafc;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .muscle-checkbox:hover {
            background: #edf2f7;
        }

        .muscle-checkbox input[type="checkbox"] {
            margin-right: 8px;
        }

        .muscle-checkbox span {
            font-size: 0.9em;
            color: #4a5568;
        }

        .exercise-inputs-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }

        .exercise-inputs-section h4 {
            margin-bottom: 15px;
            color: #2d3748;
            font-size: 1em;
        }

        .exercise-inputs {
            display: flex;
            flex-direction: row;
            gap: 15px;
            flex-wrap: wrap;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
            min-width: 120px;
        }

        .input-group label {
            min-width: 120px;
            font-size: 0.85em;
            color: #4a5568;
            font-weight: 500;
        }

        .input-group input {
            width: 100%;
            max-width: 80px;
        }

        /* SCHEDE SELECTION MODAL */
        .schede-selection {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .scheda-selection-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: #f7fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            cursor: pointer;
        }

        .scheda-selection-item:hover {
            background: #edf2f7;
        }

        .scheda-selection-item input[type="checkbox"] {
            margin-right: 12px;
            transform: scale(1.2);
            cursor: pointer;
        }

        .scheda-info {
            flex: 1;
        }

        .scheda-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .scheda-details {
            font-size: 0.85em;
            color: #718096;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .progress-filters {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .progress-stats {
                grid-template-columns: 1fr 1fr;
            }
            
            .chart-canvas {
                height: 250px;
            }
            
            .exercise-inputs {
                grid-template-columns: 0.8fr 0.8fr 1.4fr;
                gap: 8px;
            }

            .nav-tab {
                font-size: 0.8em;
                padding: 12px 8px;
            }

            .ai-quick-buttons {
                grid-template-columns: 1fr;
            }

            .ai-chat-container {
                height: 400px;
            }
        }

        /* ANIMATIONS */
        .exercise-card, .template-exercise-item, .progress-card, .history-item {
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* EMPTY STATES */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #718096;
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .empty-state-title {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 8px;
        }

        /* MUSCOLI ALLENATI SECTION */
        .muscles-worked-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .muscles-worked-section h4 {
            color: #2d3748;
            font-size: 1.1em;
            margin-bottom: 15px;
            text-align: center;
        }

        .muscle-coverage {
            margin-bottom: 20px;
        }

        .coverage-bar {
            background: #e2e8f0;
            border-radius: 20px;
            height: 24px;
            position: relative;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .coverage-fill {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            height: 100%;
            border-radius: 20px;
            transition: width 0.3s ease;
        }

        .coverage-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #2d3748;
            font-size: 0.8em;
            font-weight: 600;
            text-shadow: 0 0 2px rgba(255,255,255,0.8);
        }

        .muscles-worked h4 {
            margin-bottom: 15px;
        }

        .muscles-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .muscle-tag {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
            display: inline-block;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .no-muscles {
            text-align: center;
            color: #718096;
            font-style: italic;
            padding: 20px;
        }

        /* WORKOUT COUNTER */
        .workout-counter {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #4a5568;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7em;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        /* BACK TO TOP BUTTON */
        .back-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            z-index: 1000;
        }

        .back-to-top.show {
            opacity: 1;
            visibility: visible;
        }

        .back-to-top:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
        }

        /* AI WORKOUT GENERATOR STYLES */
        .ai-workout-generator {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0;
        }

        .ai-gen-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
            border-radius: 12px;
            margin-bottom: 2rem;
        }

        .ai-gen-header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .ai-gen-header p {
            opacity: 0.9;
        }

        .ai-gen-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .ai-gen-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .ai-gen-form-group {
            display: flex;
            flex-direction: column;
        }

        .ai-gen-form-group label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
            font-size: 0.9rem;
        }

        .ai-gen-optional-label::after {
            content: ' (Opzionale)';
            color: #999;
            font-weight: 400;
            font-size: 0.85rem;
        }

        .ai-gen-warning-label {
            color: #f59e0b !important;
            font-size: 1rem !important;
        }

        .ai-gen-warning-label::before {
            content: '⚠️ ';
        }

        .ai-gen-form-group input,
        .ai-gen-form-group select,
        .ai-gen-form-group textarea {
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .ai-gen-form-group input:focus,
        .ai-gen-form-group select:focus,
        .ai-gen-form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .ai-gen-form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .ai-gen-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .ai-gen-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .ai-gen-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .ai-gen-loading {
            text-align: center;
            padding: 2rem;
            display: none;
        }

        .ai-gen-loading.show {
            display: block;
        }

        .ai-gen-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .ai-gen-progress-container {
            width: 100%;
            max-width: 400px;
            margin: 1rem auto;
            background: #f3f3f3;
            border-radius: 10px;
            overflow: hidden;
            height: 8px;
        }

        .ai-gen-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .ai-gen-result {
            margin-top: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            display: none;
        }

        .ai-gen-result.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        .ai-gen-result.error {
            background: #fee;
            border-left-color: #f44;
            color: #c33;
        }

        .ai-gen-workout-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            border: 2px solid #e0e0e0;
        }

        .ai-gen-workout-card h3 {
            color: #667eea;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .ai-gen-exercise-item {
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 0.75rem;
        }

        .ai-gen-exercise-item h4 {
            color: #333;
            margin-bottom: 0.5rem;
        }

        .ai-gen-exercise-details {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .ai-gen-copy-btn {
            background: #34d399;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 1rem;
        }

        .ai-gen-copy-btn:hover {
            background: #10b981;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- HEADER -->
        <div class="header">
            <h1>💪 App Palestra 3</h1>
            <div class="header-stats">
                <span id="weeklyStreak">🔥 0 settimane consecutive</span>
            </div>
        </div>

        <!-- NAVIGATION -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-page="workout">🏋️ Allenamento</button>
            <button class="nav-tab" data-page="Schede">⚙️ Schede</button>
            <button class="nav-tab" data-page="progress">📈 Progressi</button>
            <button class="nav-tab" data-page="history">📅 Storia</button>
            <button class="nav-tab nav-tab-ai" data-page="ai-assistant">🤖 AI Personal</button>
        </div>

        <!-- WORKOUT PAGE -->
        <div id="workoutPage" class="page active">
            <div class="workout-title">
                <h2 id="workoutTitle">Allenamento di Oggi</h2>
                <div class="workout-date" id="workoutDate"></div>
            </div>

            <div class="Schede" id="SchedaButtons">
                <!-- I Scheda verranno inseriti qui -->
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                <button class="add-exercise-btn" id="addExerciseBtn">➕ Aggiungi Esercizio</button>
                <button id="reorderExercisesBtn" onclick="showReorderModal()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; display: none;">☰ Ordina</button>
            </div>

            <div id="exercisesList">
                <!-- Gli esercizi verranno inseriti qui -->
            </div>

            <button class="save-workout-btn" id="saveWorkoutBtn" style="display: none;">💾 Salva Allenamento</button>
        </div>

        <!-- Templates PAGE -->
        <div id="SchedePage" class="page">
            <button class="add-template-btn" id="addSchedaBtn">➕ Crea Nuova Scheda</button>
            <button class="add-template-btn" id="personalSchedeBtn" style="background: #48bb78;">� Sblocca Schede</button>
            <button class="add-template-btn" id="downloadPdfBtn" style="background: #ed8936;">📄 Stampa PDF schede</button>
            <button class="add-template-btn" id="deleteAllSchedeBtn" style="background: #e53e3e;">🗑️ Gestisci Schede</button>
            <div id="SchedaEditorsList">
                <!-- Gli editor dei template verranno inseriti qui -->
            </div>
        </div>

        <!-- PROGRESS PAGE -->
        <div id="progressPage" class="page">
            <!-- MUSCLE GROUP FILTERS (Primary) -->
            <div class="muscle-groups-filter">
                <h3 style="margin-bottom: 15px; color: #2d3748;">💪 Gruppi Muscolari</h3>
                <div id="muscleGroupButtons" class="muscle-group-btns">
                    <!-- Pulsanti gruppi muscolari generati qui -->
                </div>
            </div>

            <!-- ADDITIONAL FILTERS (Collapsible) -->
            <div class="additional-filters-section">
                <button id="toggleAdditionalFilters" class="toggle-filters-btn">
                    🔽 Filtri Aggiuntivi
                </button>
                <div id="additionalFiltersContent" class="additional-filters-content" style="display: none;">
                    <div class="progress-filters">
                        <div class="filter-group">
                            <label class="filter-label">Periodo:</label>
                            <select id="timeFilter" class="filter-select">
                                <option value="all">Tutto il tempo</option>
                                <option value="30">Ultimi 30 giorni</option>
                                <option value="90">Ultimi 3 mesi</option>
                                <option value="180">Ultimi 6 mesi</option>
                                <option value="365">Ultimo anno</option>
                                <option value="custom">Personalizzato</option>
                            </select>
                        </div>
                        <div class="filter-group custom-date-group" id="customDateGroup" style="display: none;">
                            <label class="filter-label">Da:</label>
                            <input type="date" id="startDate" class="filter-select">
                            <label class="filter-label" style="margin-left: 10px;">A:</label>
                            <input type="date" id="endDate" class="filter-select">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Esercizio Specifico:</label>
                            <select id="exerciseFilter" class="filter-select">
                                <option value="">Tutti gli esercizi</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PROGRESS CHARTS -->
            <div class="progress-charts">
                <div class="chart-container">
                    <h3 class="chart-title">📊 Progressione Peso nel Tempo</h3>
                    <div class="chart-canvas">
                        <canvas id="weightChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- EXERCISE LIST -->
            <div id="progressList">
                <!-- I progressi verranno inseriti qui -->
            </div>

            <!-- VOLUME CHART (At the end) -->
            <div class="progress-charts">
                <div class="chart-container">
                    <h3 class="chart-title">📊 Volume di Allenamento</h3>
                    <div class="chart-canvas">
                        <canvas id="volumeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- HISTORY PAGE -->
        <div id="historyPage" class="page">
            <!-- CALENDARIO -->
            <div class="calendar">
                <div class="calendar-header">
                    <h3 class="calendar-title" id="calendarTitle">Settembre 2025</h3>
                    <div class="calendar-nav">
                        <button class="calendar-nav-btn" id="prevMonth">‹</button>
                        <button class="calendar-nav-btn" id="nextMonth">›</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendarGrid">
                    <!-- Il calendario verrà generato qui -->
                </div>
            </div>

            <div id="historyList">
                <!-- La cronologia verrà inserita qui -->
            </div>
        </div>

        <!-- AI ASSISTANT PAGE -->
        <div id="ai-assistantPage" class="page">
            <div class="ai-workout-generator">
                <div class="ai-gen-header">
                    <h1>💪 Generatore Schede Allenamento AI</h1>
                    <p>Crea la tua scheda personalizzata con l'intelligenza artificiale</p>
                </div>
                
                <div class="ai-gen-content">
                    <form id="workoutForm">
                        <div class="ai-gen-form-grid">
                            <div class="ai-gen-form-group">
                                <label class="ai-gen-optional-label">👤 Nome</label>
                                <input type="text" name="name" placeholder="Mario Rossi">
                            </div>
                            
                            <div class="ai-gen-form-group">
                                <label class="ai-gen-optional-label">🎂 Età</label>
                                <input type="number" name="age" placeholder="25">
                            </div>
                            
                            <div class="ai-gen-form-group">
                                <label class="ai-gen-optional-label">📏 Altezza (cm)</label>
                                <input type="number" name="height" placeholder="175">
                            </div>
                            
                            <div class="ai-gen-form-group">
                                <label class="ai-gen-optional-label">⚖️ Peso (kg)</label>
                                <input type="number" name="weight" placeholder="70">
                            </div>
                            
                            <div class="ai-gen-form-group">
                                <label class="ai-gen-optional-label">📊 Livello Esperienza</label>
                                <select name="level">
                                    <option value="Principiante">Principiante</option>
                                    <option value="Intermedio">Intermedio</option>
                                    <option value="Avanzato">Avanzato</option>
                                </select>
                            </div>
                            
                            <div class="ai-gen-form-group">
                                <label class="ai-gen-optional-label">📅 Sessioni Settimanali</label>
                                <input type="number" name="sessionsPerWeek" placeholder="Auto" min="1" max="7" id="sessionsInput">
                            </div>
                            
                            <div class="ai-gen-form-group">
                                <label class="ai-gen-optional-label">⏱️ Tempo per Sessione (min)</label>
                                <input type="number" name="time" placeholder="Auto (40-90 min)" min="30" max="180">
                            </div>
                            
                            <div class="ai-gen-form-group">
                                <label class="ai-gen-optional-label">🔢 Esercizi per Sessione</label>
                                <input type="number" name="numExercises" placeholder="Auto (5-11)" min="3" max="12">
                            </div>
                        </div>
                        
                        <div class="ai-gen-form-group" style="margin-bottom: 1rem;">
                            <label class="ai-gen-optional-label">🎯 Tipo di Allenamento</label>
                            <select name="workoutType" id="workoutTypeSelect">
                                <option value="">Seleziona tipo...</option>
                                <option value="Senza pesi">Senza pesi</option>
                                <option value="Full Body">Full Body</option>
                                <option value="Push/Pull/Legs">Spinta/Tirata/Gambe</option>
                                <option value="Upper/Lower Split">Parte Superiore/Inferiore</option>
                                <option value="Petto-Bicipiti / Dorso-Tricipiti / Gambe-Spalle">Petto-Bicipiti / Dorso-Tricipiti / Gambe-Spalle</option>
                                <option value="Personalizzato">Personalizzato</option>
                            </select>
                            <input type="text" id="customWorkoutType" name="customWorkoutType" placeholder="Descrivi il tuo allenamento personalizzato..." style="display: none; margin-top: 0.5rem;">
                        </div>
                        
                        <div class="ai-gen-form-group" style="margin-bottom: 1rem;">
                            <label class="ai-gen-optional-label">🎯 Obiettivi</label>
                            <textarea name="goals" placeholder="Es: Aumentare massa muscolare, perdere peso, migliorare forza..."></textarea>
                        </div>
                        
                        <div class="ai-gen-form-group" style="margin-bottom: 1rem;">
                            <label class="ai-gen-optional-label">❤️ Esercizi Preferiti</label>
                            <textarea name="preferredExercises" placeholder="Es: Panca piana, squat, stacchi..."></textarea>
                        </div>
                        
                        <div class="ai-gen-form-group" style="margin-bottom: 1rem;">
                            <label class="ai-gen-optional-label">🚫 Esercizi da Escludere</label>
                            <textarea name="excludedExercises" placeholder="Es: Stacchi da terra, overhead press..."></textarea>
                        </div>
                        
                        <div class="ai-gen-form-group" style="margin-bottom: 1.5rem;">
                            <label class="ai-gen-warning-label">Dolori o Limitazioni</label>
                            <textarea name="issues" placeholder="Es: Dolore lombare, problemi al ginocchio..." style="border-color: #f59e0b;"></textarea>
                        </div>
                        
                        <button type="submit" class="ai-gen-btn">🚀 Genera Scheda</button>
                    </form>
                    
                    <div class="ai-gen-loading" id="loading">
                        <div class="ai-gen-spinner"></div>
                        <p style="color: #667eea; font-weight: 600;">Sto creando la tua scheda personalizzata...</p>
                        <div class="ai-gen-progress-container">
                            <div class="ai-gen-progress-bar" id="progressBar"></div>
                        </div>
                        <p id="progressText" style="color: #667eea; margin-top: 0.5rem; font-size: 0.9rem;">Tempo stimato: 90-120 secondi</p>
                    </div>
                    
                    <div id="result" class="ai-gen-result"></div>
                </div>
            </div>
        </div>

        <!-- MODALS -->
        <div id="exerciseModal" class="modal">
            <div class="modal-content">
                <h3 class="modal-title">➕ Nuovo Esercizio</h3>
                <div class="autocomplete-container">
                    <input type="text" id="exerciseNameInput" class="modal-input" placeholder="Nome esercizio">
                    <div id="exerciseSuggestions" class="autocomplete-suggestions"></div>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn primary" id="confirmAddExercise">Aggiungi</button>
                    <button class="modal-btn secondary" id="cancelAddExercise">Annulla</button>
                </div>
            </div>
        </div>

        <div id="SchedaExerciseModal" class="modal">
            <div class="modal-content">
                <h3 class="modal-title">➕ Esercizio Scheda</h3>
                <div class="autocomplete-container">
                    <input type="text" id="SchedaExerciseNameInput" class="modal-input" placeholder="Nome esercizio">
                    <div id="SchedaExerciseSuggestions" class="autocomplete-suggestions"></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <input type="number" id="SchedaExerciseSetsInput" class="modal-input" placeholder="Serie" style="margin-bottom: 0;">
                    <input type="number" id="SchedaExerciseRepsInput" class="modal-input" placeholder="Reps" style="margin-bottom: 0;">
                    <input type="number" id="SchedaExerciseWeightInput" class="modal-input" placeholder="Kg" step="0.5" style="margin-bottom: 0;">
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn primary" id="confirmAddSchedaExercise">Aggiungi</button>
                    <button class="modal-btn secondary" id="cancelAddSchedaExercise">Annulla</button>
                </div>
            </div>
        </div>

        <div id="newSchedaModal" class="modal">
            <div class="modal-content">
                <h3 class="modal-title">➕ Nuovo Scheda</h3>
                <input type="text" id="newSchedaNameInput" class="modal-input" placeholder="Nome del Scheda">
                <div class="modal-buttons">
                    <button class="modal-btn primary" id="confirmAddScheda">Crea</button>
                    <button class="modal-btn secondary" id="cancelAddScheda">Annulla</button>
                </div>
            </div>
        </div>

        <div id="saveModal" class="modal">
            <div class="modal-content">
                <h3 class="modal-title">💾 Salva Allenamento</h3>
                <input type="date" id="workoutDateInput" class="modal-input">
                <input type="number" id="durationInput" class="modal-input" placeholder="Durata (minuti)">
                <textarea id="notesInput" class="modal-input" placeholder="Note sull'allenamento..." rows="3"></textarea>
                <div class="modal-buttons">
                    <button class="modal-btn primary" id="confirmSaveWorkout">Salva</button>
                    <button class="modal-btn secondary" id="cancelSaveWorkout">Annulla</button>
                </div>
            </div>
        </div>

        <div id="reorderModal" class="modal">
            <div class="modal-content">
                <h3 class="modal-title">↕️ Ordina Esercizi</h3>
                <div id="reorderList" style="max-height: 400px; overflow-y: auto;">
                    <!-- Lista esercizi da riordinare -->
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn primary" id="confirmReorder">Conferma</button>
                    <button class="modal-btn secondary" id="cancelReorder">Annulla</button>
                </div>
            </div>
        </div>

        <div id="muscleSelectionModal" class="modal">
            <div class="modal-content">
                <h3 class="modal-title">🏋️‍♂️ Configura Nuovo Esercizio</h3>
                <p class="modal-description">Questo esercizio non è nel database. Seleziona i muscoli che allena:</p>
                
                <div class="muscle-selection">
                    <div class="muscle-type-selection">
                        <label class="muscle-type-label">
                            <input type="radio" name="exerciseType" value="traditional" checked>
                            💪 Esercizio tradizionale (serie, reps, peso)
                        </label>
                        <label class="muscle-type-label">
                            <input type="radio" name="exerciseType" value="cardio">
                            🏃‍♂️ Esercizio cardio (tempo, distanza)
                        </label>
                    </div>
                    
                    <div class="muscles-grid-selection">
                        <h4>Seleziona i muscoli allenati:</h4>
                        <div class="muscles-checkboxes">
                            <label class="muscle-checkbox">
                                <input type="checkbox" value="quadricipiti">
                                <span>Quadricipiti</span>
                            </label>
                            <label class="muscle-checkbox">
                                <input type="checkbox" value="bicipiti femorali">
                                <span>Bicipiti Femorali</span>
                            </label>
                            <label class="muscle-checkbox">
                                <input type="checkbox" value="polpacci">
                                <span>Polpacci</span>
                            </label>
                            <label class="muscle-checkbox">
                                <input type="checkbox" value="dorso">
                                <span>Dorso</span>
                            </label>
                            <label class="muscle-checkbox">
                                <input type="checkbox" value="petto">
                                <span>Petto</span>
                            </label>
                            <label class="muscle-checkbox">
                                <input type="checkbox" value="spalle">
                                <span>Spalle</span>
                            </label>
                            <label class="muscle-checkbox">
                                <input type="checkbox" value="bicipiti">
                                <span>Bicipiti</span>
                            </label>
                            <label class="muscle-checkbox">
                                <input type="checkbox" value="tricipiti">
                                <span>Tricipiti</span>
                            </label>
                            <label class="muscle-checkbox">
                                <input type="checkbox" value="addome">
                                <span>Addome</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Campi di input dinamici -->
                    <div class="exercise-inputs-section">
                        <h4 id="inputsTitle">Specifica i parametri dell'esercizio:</h4>
                        
                        <!-- Campi per esercizi tradizionali -->
                        <div id="traditionalInputs" class="exercise-inputs">
                            <div class="input-group">
                                <label for="exerciseSets">Serie:</label>
                                <input type="number" id="exerciseSets" class="modal-input" value="3" min="1" max="10">
                            </div>
                            <div class="input-group">
                                <label for="exerciseReps">Ripetizioni:</label>
                                <input type="number" id="exerciseReps" class="modal-input" value="10" min="1" max="100">
                            </div>
                            <div class="input-group">
                                <label for="exerciseWeight">Peso (kg):</label>
                                <input type="number" id="exerciseWeight" class="modal-input" value="0" min="0" step="0.5">
                            </div>
                        </div>
                        
                        <!-- Campi per esercizi cardio -->
                        <div id="cardioInputs" class="exercise-inputs" style="display: none;">
                            <div class="input-group">
                                <label for="exerciseTime">Tempo (minuti):</label>
                                <input type="number" id="exerciseTime" class="modal-input" value="30" min="1" max="300">
                            </div>
                            <div class="input-group">
                                <label for="exerciseDistance">Distanza (km):</label>
                                <input type="number" id="exerciseDistance" class="modal-input" value="5" min="0" step="0.1">
                            </div>
                        </div>
                    </div>
                </div>
                    <button class="modal-btn primary" id="confirmMuscleSelection">Conferma</button>
                    <button class="modal-btn secondary" id="cancelMuscleSelection">Annulla</button>
                </div>
            </div>
        </div>

        <div id="deleteSchedeModal" class="modal">
            <div class="modal-content">
                <h3 class="modal-title">🗑️ Gestisci Schede</h3>
                <p class="modal-description">Seleziona le schede da eliminare:</p>
                
                <div class="schede-selection" id="schedeSelectionList">
                    <!-- Le schede verranno popolate dinamicamente -->
                </div>
                
                <div class="modal-buttons">
                    <button class="modal-btn primary" id="confirmDeleteSelectedSchede" style="background: #e53e3e;">Elimina Selezionate</button>
                    <button class="modal-btn secondary" id="cancelDeleteSchede">Annulla</button>
                </div>
            </div>
        </div>
    </div>

    <!-- BACK TO TOP BUTTON -->
    <button class="back-to-top" id="backToTop" onclick="scrollToTop()">↑</button>

    <script>
        // VARIABILI GLOBALI
        let currentExercises = [];
        let workoutHistory = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
        
        // Valida e pulisce workoutHistory per evitare errori
        workoutHistory = workoutHistory.filter(w => w && typeof w.id === 'string');
        
        let currentCalendarDate = new Date();
        let currentEditingScheda = null;
        let selectedSuggestionIndex = -1;
        let weightChart = null;
        let volumeChart = null;
        let currentSchedaName = null;
        let selectedMuscleGroup = null; // Per il filtro muscolare nella pagina progressi
        
        // Sistema codici per schede protette
    let unlockedCodes = JSON.parse(localStorage.getItem('unlockedCodes') || '[]');
        const codeMappings = {
            'Giulia24': ['giulia24_giorno1', 'giulia24_giorno2', 'giulia24_giorno3'],
            'Giovanna0': ['giovanna0_alta_a', 'giovanna0_bassa_a', 'giovanna0_alta_b', 'giovanna0_bassa_b']
        };

        const protectedSchedeData = {
            'giulia24_giorno1': {
                name: '💪 Scheda Palestra G - Giorno 1: Gambe + Addome',
                exercises: [
                    { name: 'Tapis Roulant o Cyclette', sets: 1, reps: 15, weight: 0 },
                    { name: 'Leg Extension', sets: 4, reps: 12, weight: 40 },
                    { name: 'Leg Press (orizzontale)', sets: 3, reps: 12, weight: 100 },
                    { name: 'Leg Curl', sets: 3, reps: 12, weight: 35 },
                    { name: 'Crunch Machine', sets: 3, reps: 20, weight: 30 },
                    { name: 'Crunch Inversi', sets: 3, reps: 20, weight: 0 }
                ]
            },
            'giulia24_giorno2': {
                name: '🏋️ Scheda Palestra G - Giorno 2: Petto + Spalle + Tricipiti',
                exercises: [
                    { name: 'Tapis Roulant o Cyclette', sets: 1, reps: 15, weight: 0 },
                    { name: 'Chest Press', sets: 4, reps: 12, weight: 60 },
                    { name: 'Chest Fly', sets: 3, reps: 15, weight: 25 },
                    { name: 'Alzate Laterali (Spalle)', sets: 3, reps: 15, weight: 8 },
                    { name: 'Pushdown Tricipiti', sets: 3, reps: 15, weight: 25 },
                    { name: 'Tapis Roulant', sets: 1, reps: 15, weight: 0 }
                ]
            },
            'giulia24_giorno3': {
                name: '🔥 Scheda Palestra G - Giorno 3: Schiena + Bicipiti + Spalle + Addome',
                exercises: [
                    { name: 'Tapis Roulant o Cyclette', sets: 1, reps: 15, weight: 0 },
                    { name: 'Lat Machine', sets: 4, reps: 12, weight: 50 },
                    { name: 'Low Row', sets: 3, reps: 15, weight: 45 },
                    { name: 'Curl Bicipiti', sets: 3, reps: 15, weight: 20 },
                    { name: 'Alzate Frontali (Spalle)', sets: 3, reps: 12, weight: 10 },
                    { name: 'Addominali a Circuito (3 esercizi diversi)', sets: 3, reps: 30, weight: 0 }
                ]
            },
            'giovanna0_alta_a': {
                name: '💪 Giovanna0 - Giorno 1: Alta A',
                exercises: [
                    { name: 'Camminata o Ellittica (Riscaldamento)', sets: 1, reps: 5, weight: 0 },
                    { name: 'Lat Machine presa classica (Riscaldamento)', sets: 1, reps: 12, weight: 30 },
                    { name: 'Lat Machine presa classica', sets: 3, reps: 12, weight: 45 },
                    { name: 'Pulley', sets: 3, reps: 12, weight: 35 },
                    { name: 'Chest Fly (Riscaldamento)', sets: 1, reps: 15, weight: 20 },
                    { name: 'Chest Fly', sets: 3, reps: 15, weight: 25 },
                    { name: 'Panca Piana con Bilanciere', sets: 3, reps: 12, weight: 50 },
                    { name: 'Curl al Cavo Basso', sets: 3, reps: 15, weight: 20 },
                    { name: 'Plank Laterale', sets: 3, reps: 30, weight: 0 },
                    { name: 'Tapis Roulant o Cyclette (Cardio)', sets: 1, reps: 20, weight: 0 },
                    { name: 'Stretching Pettorali, Dorsali, Spalle, Braccia', sets: 1, reps: 7, weight: 0 }
                ]
            },
            'giovanna0_bassa_a': {
                name: '🦵 Giovanna0 - Giorno 2: Bassa A',
                exercises: [
                    { name: 'Camminata in Salita (Riscaldamento)', sets: 1, reps: 15, weight: 0 },
                    { name: 'Hip Thrust (Riscaldamento)', sets: 1, reps: 12, weight: 30 },
                    { name: 'Hip Thrust', sets: 3, reps: 12, weight: 50 },
                    { name: 'Squat al Muro', sets: 3, reps: 30, weight: 0 },
                    { name: 'Leg Curl', sets: 3, reps: 12, weight: 35 },
                    { name: 'Kick Back Macchinario', sets: 3, reps: 12, weight: 25 },
                    { name: 'Abductor', sets: 3, reps: 15, weight: 30 },
                    { name: 'Alzate Laterali', sets: 3, reps: 15, weight: 8 },
                    { name: 'Bicicletta (Addome Circuito)', sets: 3, reps: 30, weight: 0 },
                    { name: 'Crunch (Addome Circuito)', sets: 3, reps: 30, weight: 0 },
                    { name: 'Tocca Talloni (Addome Circuito)', sets: 3, reps: 30, weight: 0 },
                    { name: 'Camminata in Salita (Cardio)', sets: 1, reps: 20, weight: 0 },
                    { name: 'Stretching Catena Posteriore, Anche, Lombari', sets: 1, reps: 7, weight: 0 }
                ]
            },
            'giovanna0_alta_b': {
                name: '🏋️ Giovanna0 - Giorno 3: Alta B',
                exercises: [
                    { name: 'Ellittica o Camminata (Riscaldamento)', sets: 1, reps: 5, weight: 0 },
                    { name: 'Panca Inclinata con Bilanciere (Riscaldamento)', sets: 1, reps: 12, weight: 30 },
                    { name: 'Panca Inclinata con Bilanciere', sets: 3, reps: 12, weight: 45 },
                    { name: 'Chest Press (Macchinario)', sets: 3, reps: 12, weight: 50 },
                    { name: 'Macchinario Tirate Dorso (Riscaldamento)', sets: 1, reps: 10, weight: 35 },
                    { name: 'Macchinario Tirate Dorso', sets: 3, reps: 10, weight: 50 },
                    { name: 'Trazioni Assistite', sets: 3, reps: 10, weight: 0 },
                    { name: 'Macchinario Tricipiti', sets: 3, reps: 15, weight: 25 },
                    { name: 'Plank', sets: 3, reps: 30, weight: 0 },
                    { name: 'Ellittica o Cyclette (Cardio)', sets: 1, reps: 20, weight: 0 },
                    { name: 'Stretching Spalle, Schiena, Braccia', sets: 1, reps: 7, weight: 0 }
                ]
            },
            'giovanna0_bassa_b': {
                name: '🔥 Giovanna0 - Giorno 4: Bassa B',
                exercises: [
                    { name: 'Cyclette o Tapis (Riscaldamento)', sets: 1, reps: 15, weight: 0 },
                    { name: 'Leg Press Verticale (Riscaldamento)', sets: 1, reps: 12, weight: 80 },
                    { name: 'Leg Press Verticale', sets: 3, reps: 12, weight: 120 },
                    { name: 'Kick Back al Cavo', sets: 3, reps: 15, weight: 15 },
                    { name: 'Leg Press Orizzontale', sets: 3, reps: 12, weight: 100 },
                    { name: 'Macchinario Polpacci', sets: 3, reps: 15, weight: 40 },
                    { name: 'Adductor', sets: 3, reps: 15, weight: 35 },
                    { name: 'Shoulder Press', sets: 3, reps: 15, weight: 25 },
                    { name: 'Russian Twist (Addome Circuito)', sets: 3, reps: 30, weight: 0 },
                    { name: 'Plank Laterale con Sollevamento Gamba', sets: 3, reps: 45, weight: 0 },
                    { name: 'Crunch (Addome Circuito)', sets: 3, reps: 30, weight: 0 },
                    { name: 'Camminata in Salita (Cardio)', sets: 1, reps: 20, weight: 0 },
                    { name: 'Stretching Quadricipiti, Glutei, Femorali', sets: 1, reps: 7, weight: 0 }
                ]
            }
        };

        // Schede PERSONALIZZABILI
        let customSchede = JSON.parse(localStorage.getItem('customSchede') || JSON.stringify({
            push: {
                name: '🔥 Push Day',
                exercises: [
                    { name: 'Panca Piana', sets: 4, reps: 8, weight: 80 },
                    { name: 'Panca Inclinata', sets: 3, reps: 10, weight: 60 },
                    { name: 'Spinte Manubri', sets: 3, reps: 12, weight: 25 },
                    { name: 'Dips', sets: 3, reps: 10, weight: 0 },
                    { name: 'Tricep Pushdown', sets: 3, reps: 15, weight: 30 }
                ]
            },
            pull: {
                name: '💪 Pull Day',
                exercises: [
                    { name: 'Trazioni', sets: 4, reps: 8, weight: 0 },
                    { name: 'Lat Machine', sets: 3, reps: 10, weight: 50 },
                    { name: 'Rematore Bilanciere', sets: 3, reps: 10, weight: 60 },
                    { name: 'Pulley', sets: 3, reps: 12, weight: 40 },
                    { name: 'Curl Bilanciere', sets: 3, reps: 12, weight: 30 }
                ]
            },
            legs: {
                name: '🦵 Leg Day',
                exercises: [
                    { name: 'Squat', sets: 4, reps: 10, weight: 100 },
                    { name: 'Stacchi Rumeni', sets: 3, reps: 10, weight: 80 },
                    { name: 'Leg Press', sets: 3, reps: 15, weight: 200 },
                    { name: 'Leg Extension', sets: 3, reps: 15, weight: 40 },
                    { name: 'Leg Curl', sets: 3, reps: 15, weight: 35 }
                ]
            },
            upper: {
                name: '💪 Upper Body',
                exercises: [
                    { name: 'Panca Piana', sets: 3, reps: 10, weight: 70 },
                    { name: 'Trazioni', sets: 3, reps: 8, weight: 0 },
                    { name: 'Military Press', sets: 3, reps: 10, weight: 40 },
                    { name: 'Rematore', sets: 3, reps: 10, weight: 50 }
                ]
            },
            cardio: {
                name: '🏃 Cardio Session',
                exercises: [
                    { name: 'Tapis Roulant', sets: 1, reps: 20, weight: 0 },
                    { name: 'Cyclette', sets: 1, reps: 15, weight: 0 },
                    { name: 'Ellittica', sets: 1, reps: 10, weight: 0 }
                ]
            }
        }));

        // Rimuovi eventuali schede protette memorizzate in precedenza
        (function purgeProtectedSchede() {
            let removed = false;
            Object.keys(customSchede).forEach(key => {
                if (key.startsWith('giulia24_') || key.startsWith('giovanna0_')) {
                    delete customSchede[key];
                    removed = true;
                }
            });

            if (removed) {
                localStorage.setItem('customSchede', JSON.stringify(customSchede));
            }
        })();

        // Schede PERSONALI (protette da codice)
        const personalSchede = {
            mamma1: [
                {
                    name: '💪 Mamma - Forza Totale',
                    exercises: [
                        { name: 'Panca Piana', sets: 3, reps: 8, weight: 50 },
                        { name: 'Squat', sets: 3, reps: 10, weight: 60 },
                        { name: 'Trazioni', sets: 3, reps: 6, weight: 0 },
                        { name: 'Military Press', sets: 3, reps: 10, weight: 30 }
                    ]
                },
                {
                    name: '🔥 Mamma - Braccia Focus',
                    exercises: [
                        { name: 'Curl Bilanciere', sets: 3, reps: 12, weight: 25 },
                        { name: 'Tricep Pushdown', sets: 3, reps: 15, weight: 25 },
                        { name: 'Dips', sets: 3, reps: 10, weight: 0 },
                        { name: 'Hammer Curl', sets: 3, reps: 12, weight: 20 }
                    ]
                },
                {
                    name: '🦵 Mamma - Gambe Potenti',
                    exercises: [
                        { name: 'Leg Press', sets: 3, reps: 15, weight: 150 },
                        { name: 'Leg Extension', sets: 3, reps: 15, weight: 30 },
                        { name: 'Leg Curl', sets: 3, reps: 15, weight: 25 },
                        { name: 'Stacchi Rumeni', sets: 3, reps: 10, weight: 50 }
                    ]
                }
            ],
            papa1: [
                {
                    name: '🏋️ Papa - Push Day',
                    exercises: [
                        { name: 'Panca Piana', sets: 4, reps: 8, weight: 100 },
                        { name: 'Panca Inclinata', sets: 3, reps: 10, weight: 80 },
                        { name: 'Spinte Manubri', sets: 3, reps: 12, weight: 30 },
                        { name: 'Dips', sets: 3, reps: 10, weight: 0 },
                        { name: 'Tricep Pushdown', sets: 3, reps: 15, weight: 40 }
                    ]
                },
                {
                    name: '💪 Papa - Pull Day',
                    exercises: [
                        { name: 'Trazioni', sets: 4, reps: 8, weight: 0 },
                        { name: 'Lat Machine', sets: 3, reps: 10, weight: 60 },
                        { name: 'Rematore Bilanciere', sets: 3, reps: 10, weight: 70 },
                        { name: 'Pulley', sets: 3, reps: 12, weight: 50 },
                        { name: 'Curl Bilanciere', sets: 3, reps: 12, weight: 35 }
                    ]
                },
                {
                    name: '🦵 Papa - Leg Day',
                    exercises: [
                        { name: 'Squat', sets: 4, reps: 10, weight: 120 },
                        { name: 'Stacchi Rumeni', sets: 3, reps: 10, weight: 100 },
                        { name: 'Leg Press', sets: 3, reps: 15, weight: 250 },
                        { name: 'Leg Extension', sets: 3, reps: 15, weight: 50 },
                        { name: 'Leg Curl', sets: 3, reps: 15, weight: 45 }
                    ]
                }
            ]
        };

        function getUnlockedProtectedSchede() {
            const seen = new Set();
            const result = [];

            unlockedCodes.forEach(code => {
                const ids = codeMappings[code] || [];
                ids.forEach(id => {
                    if (!seen.has(id) && protectedSchedeData[id]) {
                        seen.add(id);
                        result.push([id, protectedSchedeData[id]]);
                    }
                });
            });

            return result;
        }

        // INIZIALIZZAZIONE
        document.addEventListener('DOMContentLoaded', function() {
            console.log('App Palestra 3 - Versione con AI Personal inizializzata');
            
            // Migrazione dati esistenti per aggiungere ID univoci
            migrateWorkoutHistory();
            
            initializeApp();
            setupEventListeners();
            setupAutocomplete();
            setupAIAssistant();
        });

        // CORREZIONE BUG 2: Migrazione dati per aggiungere ID univoci
        function migrateWorkoutHistory() {
            let needsMigration = false;
            workoutHistory.forEach(workout => {
                if (!workout.id) {
                    workout.id = Date.now() + Math.random();
                    needsMigration = true;
                }
            });
            
            if (needsMigration) {
                localStorage.setItem('workoutHistory', JSON.stringify(workoutHistory));
            }
        }

        // INIZIALIZZAZIONE ALLENAMENTI DI ESEMPIO
        function initializeSampleWorkouts() {
            // Controlla se ci sono già allenamenti salvati (non esempi)
            const hasRealWorkouts = workoutHistory.some(w => !w.id.startsWith('sample_'));
            if (hasRealWorkouts) return;

            // Controlla se gli esempi esistono già
            const hasSamples = workoutHistory.some(w => w.id.startsWith('sample_'));
            if (hasSamples) return;

            const today = new Date();
            const sampleWorkouts = [
                {
                    id: 'sample_1_' + Date.now(),
                    date: '2025-08-15', // Agosto 2025
                    name: 'Allenamento Gambe - Agosto',
                    schedaName: '🦵 Scheda Gambe',
                    exercises: [
                        { name: 'Squat', sets: 4, reps: 10, weight: 60, completed: true },
                        { name: 'Leg Press', sets: 3, reps: 12, weight: 120, completed: true },
                        { name: 'Leg Curl', sets: 3, reps: 12, weight: 40, completed: true },
                        { name: 'Leg Extension', sets: 3, reps: 12, weight: 50, completed: true },
                        { name: 'Calf Raises', sets: 4, reps: 15, weight: 60, completed: true }
                    ],
                    duration: 50,
                    notes: 'Allenamento intenso agosto!',
                    isSample: true
                },
                {
                    id: 'sample_2_' + Date.now(),
                    date: '2025-08-22', // Agosto 2025
                    name: 'Allenamento Petto - Agosto',
                    schedaName: '💪 Scheda Petto',
                    exercises: [
                        { name: 'Panca Piana', sets: 4, reps: 8, weight: 70, completed: true },
                        { name: 'Panca Inclinata', sets: 3, reps: 10, weight: 60, completed: true },
                        { name: 'Croci con Manubri', sets: 3, reps: 12, weight: 20, completed: true },
                        { name: 'Dips', sets: 3, reps: 10, weight: 0, completed: true }
                    ],
                    duration: 45,
                    notes: 'Agosto - focus petto!',
                    isSample: true
                },
                {
                    id: 'sample_3_' + Date.now(),
                    date: new Date(today.getTime() - 6 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 6 giorni fa (Lunedì)
                    name: 'Allenamento Full Body - Esempio',
                    schedaName: '🏋️ Full Body Principiante - Livello 1',
                    exercises: [
                        { name: 'Squat', sets: 3, reps: 12, weight: 40, completed: true },
                        { name: 'Panca Piana', sets: 3, reps: 10, weight: 50, completed: true },
                        { name: 'Rematore Bilanciere', sets: 3, reps: 10, weight: 40, completed: true },
                        { name: 'Military Press', sets: 3, reps: 8, weight: 30, completed: true },
                        { name: 'Plank', sets: 3, reps: 30, weight: 0, completed: true }
                    ],
                    duration: 45,
                    notes: 'Primo allenamento di esempio - puoi cancellarlo quando vuoi!',
                    isSample: true
                },
                {
                    id: 'sample_4_' + Date.now(),
                    date: new Date(today.getTime() - 4 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 4 giorni fa (Mercoledì)
                    name: 'Allenamento Full Body - Esempio 2',
                    schedaName: '💪 Full Body Principiante - Livello 2',
                    exercises: [
                        { name: 'Squat', sets: 3, reps: 12, weight: 45, completed: true },
                        { name: 'Panca Piana', sets: 3, reps: 10, weight: 55, completed: true },
                        { name: 'Trazioni', sets: 3, reps: 8, weight: 0, completed: true },
                        { name: 'Military Press', sets: 3, reps: 8, weight: 32, completed: true },
                        { name: 'Russian Twists', sets: 3, reps: 20, weight: 0, completed: true }
                    ],
                    duration: 50,
                    notes: 'Secondo allenamento di esempio - mostra il progresso!',
                    isSample: true
                },
                {
                    id: 'sample_5_' + Date.now(),
                    date: new Date(today.getTime() - 2 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 2 giorni fa (Venerdì)
                    name: 'Allenamento Full Body - Esempio 3',
                    schedaName: '🏋️ Full Body Principiante - Livello 1',
                    exercises: [
                        { name: 'Squat', sets: 4, reps: 10, weight: 50, completed: true },
                        { name: 'Panca Piana', sets: 4, reps: 8, weight: 60, completed: true },
                        { name: 'Rematore Bilanciere', sets: 3, reps: 12, weight: 45, completed: true },
                        { name: 'Military Press', sets: 3, reps: 10, weight: 35, completed: true },
                        { name: 'Plank', sets: 3, reps: 45, weight: 0, completed: true }
                    ],
                    duration: 55,
                    notes: 'Terzo allenamento - aumentando i pesi!',
                    isSample: true
                },
                {
                    id: 'sample_6_' + Date.now(),
                    date: new Date(today.getTime() - 1 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // Ieri (Sabato)
                    name: 'Allenamento Full Body - Esempio 4',
                    schedaName: '💪 Full Body Principiante - Livello 2',
                    exercises: [
                        { name: 'Squat', sets: 4, reps: 10, weight: 55, completed: true },
                        { name: 'Panca Piana', sets: 4, reps: 8, weight: 65, completed: true },
                        { name: 'Trazioni', sets: 4, reps: 6, weight: 0, completed: true },
                        { name: 'Military Press', sets: 4, reps: 8, weight: 38, completed: true },
                        { name: 'Russian Twists', sets: 4, reps: 25, weight: 0, completed: true }
                    ],
                    duration: 60,
                    notes: 'Quarto allenamento - costanza paga! Cancella questi esempi quando vuoi iniziare i tuoi allenamenti.',
                    isSample: true
                }
            ];

            // Aggiungi gli allenamenti di esempio
            workoutHistory.push(...sampleWorkouts);
            localStorage.setItem('workoutHistory', JSON.stringify(workoutHistory));
        }

        // INIZIALIZZAZIONE SCHEDE FULL BODY PRINCIPIANTI
        function initializeSampleSchede() {
            // Controlla se ci sono già schede personalizzate
            if (Object.keys(customSchede).length > 2) return; // Ha già più di push/pull

            const sampleSchede = {
                'fullbody_principiante_1': {
                    name: '🏋️ Full Body Principiante - Livello 1',
                    exercises: [
                        { name: 'Squat', sets: 3, reps: 12, weight: 20 },
                        { name: 'Panca Piana', sets: 3, reps: 10, weight: 30 },
                        { name: 'Rematore Bilanciere', sets: 3, reps: 10, weight: 25 },
                        { name: 'Military Press', sets: 3, reps: 8, weight: 15 },
                        { name: 'Plank', sets: 3, reps: 20, weight: 0 }
                    ]
                },
                'fullbody_principiante_2': {
                    name: '💪 Full Body Principiante - Livello 2',
                    exercises: [
                        { name: 'Squat', sets: 3, reps: 10, weight: 30 },
                        { name: 'Panca Piana', sets: 3, reps: 8, weight: 40 },
                        { name: 'Trazioni Assistite', sets: 3, reps: 8, weight: 0 },
                        { name: 'Military Press', sets: 3, reps: 8, weight: 20 },
                        { name: 'Russian Twists', sets: 3, reps: 15, weight: 0 }
                    ]
                }
            };

            // Unisci con le schede esistenti
            Object.assign(customSchede, sampleSchede);
            localStorage.setItem('customSchede', JSON.stringify(customSchede));
        }

        function initializeApp() {
            try {
                // Inizializza allenamenti e schede di esempio
                initializeSampleWorkouts();
                initializeSampleSchede();

                // Carica esercizi personalizzati dal localStorage
                const customExercises = JSON.parse(localStorage.getItem('customExercises') || '{}');
                Object.assign(PREDEFINED_EXERCISES, customExercises);

                updateWorkoutDate();
                updateStats();

                // Inizializza con currentExercises vuoto
                currentExercises = [];

                renderExercises();
                renderSchedaButtons();
                renderSchedaEditors();
                renderProgress();
                renderHistory();
                renderCalendar();
            } catch (error) {
                console.error('Errore durante l\'inizializzazione dell\'app:', error);
                alert('Errore durante il caricamento dell\'app: ' + error.message);
            }
        }

        function setupEventListeners() {
            // Navigation tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const page = this.getAttribute('data-page');
                    showPage(page);
                });
            });

            // Buttons
            document.getElementById('addExerciseBtn').addEventListener('click', showAddExerciseModal);
            document.getElementById('saveWorkoutBtn').addEventListener('click', showSaveWorkoutModal);
            document.getElementById('confirmAddExercise').addEventListener('click', confirmAddExercise);
            document.getElementById('cancelAddExercise').addEventListener('click', hideModal);
            document.getElementById('confirmAddSchedaExercise').addEventListener('click', confirmAddSchedaExercise);
            document.getElementById('cancelAddSchedaExercise').addEventListener('click', hideModal);
            document.getElementById('confirmSaveWorkout').addEventListener('click', confirmSaveWorkout);
            document.getElementById('cancelSaveWorkout').addEventListener('click', hideModal);
            
            // Reorder modal
            document.getElementById('confirmReorder').addEventListener('click', confirmReorder);
            document.getElementById('cancelReorder').addEventListener('click', () => {
                document.getElementById('reorderModal').classList.remove('show');
            });
            
            // Muscle selection modal
            document.getElementById('confirmMuscleSelection').addEventListener('click', confirmMuscleSelection);
            document.getElementById('cancelMuscleSelection').addEventListener('click', cancelMuscleSelection);
            
            // Toggle exercise inputs when radio buttons change
            document.querySelectorAll('input[name="exerciseType"]').forEach(radio => {
                radio.addEventListener('change', toggleExerciseInputs);
            });
            
            // Delete schede modal
            document.getElementById('confirmDeleteSelectedSchede').addEventListener('click', confirmDeleteSelectedSchede);
            document.getElementById('cancelDeleteSchede').addEventListener('click', cancelDeleteSchede);
            
            // New Scheda buttons
            document.getElementById('addSchedaBtn').addEventListener('click', showAddSchedaModal);
            document.getElementById('confirmAddScheda').addEventListener('click', confirmAddScheda);
            document.getElementById('cancelAddScheda').addEventListener('click', hideModal);

            // Personal Schede buttons
            document.getElementById('personalSchedeBtn').addEventListener('click', showPersonalSchedeModal);
            document.getElementById('downloadPdfBtn').addEventListener('click', downloadSchedePdf);
            document.getElementById('deleteAllSchedeBtn').addEventListener('click', deleteAllSchede);

            // Calendar navigation
            document.getElementById('prevMonth').addEventListener('click', () => changeMonth(-1));
            document.getElementById('nextMonth').addEventListener('click', () => changeMonth(1));

            // CORREZIONE BUG 3: Progress filters
            // Time filter change handler
            document.getElementById('timeFilter').addEventListener('change', function() {
                const customDateGroup = document.getElementById('customDateGroup');
                const timeFilter = this.value;
                
                if (timeFilter === 'custom') {
                    customDateGroup.style.display = 'flex';
                    // Set default dates (last 30 days)
                    const endDate = new Date();
                    const startDate = new Date();
                    startDate.setDate(startDate.getDate() - 30);
                    
                    document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
                    document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
                } else {
                    customDateGroup.style.display = 'none';
                }
                
                updateProgressCharts();
            });
            
            // Custom date inputs change handlers
            document.getElementById('startDate').addEventListener('change', updateProgressCharts);
            document.getElementById('endDate').addEventListener('change', updateProgressCharts);
            document.getElementById('exerciseFilter').addEventListener('change', updateProgressCharts);

            // Toggle additional filters
            document.getElementById('toggleAdditionalFilters').addEventListener('click', function() {
                const content = document.getElementById('additionalFiltersContent');
                const isVisible = content.style.display !== 'none';
                content.style.display = isVisible ? 'none' : 'block';
                this.textContent = isVisible ? '🔽 Filtri Aggiuntivi' : '🔼 Nascondi Filtri';
            });

            // Close modal when clicking outside
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        hideModal();
                    }
                });
            });
        }

        // AI WORKOUT GENERATOR SETUP
        function setupAIAssistant() {
            const workoutForm = document.getElementById('workoutForm');
            if (!workoutForm) return; // Se il form non esiste, esci
            
            const workoutTypeSelect = document.getElementById('workoutTypeSelect');
            const customWorkoutType = document.getElementById('customWorkoutType');
            const sessionsInput = document.getElementById('sessionsInput');
            const loading = document.getElementById('loading');
            const result = document.getElementById('result');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            // Mostra/nascondi campo personalizzato
            workoutTypeSelect.addEventListener('change', function() {
                if (this.value === 'Personalizzato') {
                    customWorkoutType.style.display = 'block';
                } else {
                    customWorkoutType.style.display = 'none';
                    customWorkoutType.value = '';
                }
                
                // Auto-seleziona sessioni in base al tipo di allenamento
                if (!sessionsInput.value || sessionsInput.value === '') {
                    autoSelectSessions();
                }
            });

            function autoSelectSessions() {
                const workoutType = workoutTypeSelect.value;
                let suggestedSessions = 3;
                
                switch(workoutType) {
                    case 'Senza pesi':
                    case 'Full Body':
                        suggestedSessions = 3;
                        break;
                    case 'Push/Pull/Legs':
                    case 'Petto-Bicipiti / Dorso-Tricipiti / Gambe-Spalle':
                        suggestedSessions = 3;
                        break;
                    case 'Upper/Lower Split':
                        suggestedSessions = 4;
                        break;
                    default:
                        suggestedSessions = 3;
                }
                
                if (!sessionsInput.value) {
                    sessionsInput.placeholder = `Suggerito: ${suggestedSessions}`;
                }
            }

            function simulateProgress() {
                let progress = 0;
                const interval = setInterval(() => {
                    progress += Math.random() * 7;  // Rallentato da 15 a 7
                    if (progress > 90) progress = 90;
                    progressBar.style.width = progress + '%';
                }, 2000);  // Rallentato da 1000ms a 2000ms
                return interval;
            }

            workoutForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = new FormData(workoutForm);
                const data = Object.fromEntries(formData);
                
                // Se tipo personalizzato, usa il testo custom
                let workoutType = data.workoutType;
                if (workoutType === 'Personalizzato' && data.customWorkoutType) {
                    workoutType = data.customWorkoutType;
                }
                
                // Auto-seleziona sessioni se non specificate
                let sessions = data.sessionsPerWeek;
                if (!sessions || sessions === '') {
                    switch(workoutType) {
                        case 'Senza pesi':
                        case 'Full Body':
                            sessions = 3;
                            break;
                        case 'Push/Pull/Legs':
                        case 'Petto-Bicipiti / Dorso-Tricipiti / Gambe-Spalle':
                            sessions = 3;
                            break;
                        case 'Upper/Lower Split':
                            sessions = 4;
                            break;
                        default:
                            sessions = 3;
                    }
                }
                
                // Stima automatica tempo e esercizi se non specificati
                const estimatedTime = data.time || (40 + Math.floor(Math.random() * 51)); // 40-90 min
                const estimatedExercises = data.numExercises || (5 + Math.floor(Math.random() * 7)); // 5-11 esercizi
                
                const prompt = `[INST]
Crea una scheda di allenamento personalizzata in formato JSON valido per l'utente seguente.
Dati utente:
- Nome: ${data.name || 'Utente anonimo'}
- Età: ${data.age || 'Non specificata'}
- Altezza: ${data.height || 'Non specificata'} cm
- Peso: ${data.weight || 'Non specificato'} kg
- Livello esperienza: ${data.level || 'Principiante'}
- Sessioni settimanali: ${sessions}
- Tempo per sessione: ${estimatedTime} minuti${data.time ? '' : ' (stimato dall\'AI)'}
- Numero esercizi per sessione: ${estimatedExercises}${data.numExercises ? '' : ' (stimato dall\'AI)'}
- Obiettivi: ${data.goals || 'Generico'}
- Esercizi preferiti: ${data.preferredExercises || 'Nessuno'}
- Tipo di allenamento: ${workoutType || 'Non specificato'}
- Esercizi da escludere: ${data.excludedExercises || 'Nessuno'}
- Dolori o limitazioni: ${data.issues || 'Nessuno'}

Genera una scheda unica e personalizzata basata SOLO su questi dati.
Struttura JSON ESATTA:
{
  "title": "Titolo personalizzato per l'utente",
  "duration_weeks": 8,
  "sessions_per_week": numero da input,
  "workout_days": [
    {
      "day": "Nome sessione",
      "focus": "Gruppo muscolare",
      "exercises": [
        {
          "name": "Nome esercizio",
          "sets": numero serie,
          "reps": "Range reps (es. 10-12)",
          "notes": "(Opzionali) Note personalizzate"
        }
      ]
    }
  ],
  "notes": "Note generali personalizzate"
}

Rispondi SOLO con JSON valido, senza testo extra.
[/INST]`;

                loading.classList.add('show');
                result.classList.remove('show', 'error');
                result.innerHTML = '';
                
                progressBar.style.width = '0%';
                const progressInterval = simulateProgress();
                const startTime = Date.now();
                
                try {
                    // Read API key from runtime config (generated by build.sh or provided by config.js)
                    const GEMINI_KEY = (window.getGeminiKey && typeof window.getGeminiKey === 'function')
                        ? window.getGeminiKey()
                        : (window.GEMINI_KEY || null);

                    if (!GEMINI_KEY) {
                        throw new Error('API Key non configurata. Imposta GEMINI_API_KEY in .env o nelle environment variables del tuo hosting (es. Netlify).');
                    }

                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key=${GEMINI_KEY}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [{ text: prompt }]
                                }],
                                generationConfig: {
                                    temperature: 0.7,
                                    topK: 40,
                                    topP: 0.95,
                                    maxOutputTokens: 8192,
                                }
                            })
                        }
                    );
                    
                    clearInterval(progressInterval);
                    progressBar.style.width = '100%';
                    
                    const elapsedTime = Math.round((Date.now() - startTime) / 1000);
                    progressText.textContent = `Completato in ${elapsedTime} secondi!`;
                    
                    setTimeout(() => {
                        loading.classList.remove('show');
                    }, 500);
                    
                    const responseData = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(responseData?.error?.message || `Errore HTTP ${response.status}`);
                    }
                    
                    let textResponse = responseData?.candidates?.[0]?.content?.parts?.[0]?.text || '';
                    textResponse = textResponse.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                    
                    const jsonMatch = textResponse.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) {
                        throw new Error('Nessun JSON valido trovato nella risposta');
                    }
                    
                    const workoutData = JSON.parse(jsonMatch[0]);
                    displayWorkout(workoutData);
                    
                } catch (error) {
                    clearInterval(progressInterval);
                    loading.classList.remove('show');
                    result.classList.add('show', 'error');
                    result.innerHTML = `<h3>❌ Errore</h3><p>${error.message}</p>`;
                }
            });

            function displayWorkout(workout) {
                let html = `
                    <h2 style="color: #667eea; margin-bottom: 1rem;">${workout.title}</h2>
                    <p style="margin-bottom: 0.5rem;"><strong>Durata:</strong> ${workout.duration_weeks} settimane</p>
                    <p style="margin-bottom: 1.5rem;"><strong>Sessioni settimanali:</strong> ${workout.sessions_per_week}</p>
                `;
                
                workout.workout_days.forEach((day, index) => {
                    html += `
                        <div class="ai-gen-workout-card">
                            <h3>${day.day}</h3>
                            <p style="color: #666; margin-bottom: 1rem;"><strong>Focus:</strong> ${day.focus}</p>
                    `;
                    
                    day.exercises.forEach(ex => {
                        html += `
                            <div class="ai-gen-exercise-item">
                                <h4>💪 ${ex.name}</h4>
                                <div class="ai-gen-exercise-details"><strong>Serie:</strong> ${ex.sets} × <strong>Reps:</strong> ${ex.reps}</div>
                                ${ex.notes ? `<div class="ai-gen-exercise-details" style="color: #8b5cf6; margin-top: 0.5rem;">📝 ${ex.notes}</div>` : ''}
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                });
                
                if (workout.notes) {
                    html += `
                        <div style="background: #fffbeb; padding: 1rem; border-radius: 8px; border-left: 4px solid #fbbf24;">
                            <h4 style="color: #92400e; margin-bottom: 0.5rem;">📋 Note Generali</h4>
                            <p style="color: #78350f;">${workout.notes}</p>
                        </div>
                    `;
                }
                
                html += `<button class="ai-gen-copy-btn" onclick="addWorkoutToSchede()">➕ Aggiungi a SCHEDE</button>`;
                
                result.innerHTML = html;
                result.classList.add('show');
                window.currentWorkout = workout;
            }

            window.addWorkoutToSchede = function() {
                if (!window.currentWorkout) {
                    alert('❌ Nessuna scheda da salvare');
                    return;
                }

                try {
                    const workout = window.currentWorkout;
                    
                    // Chiedi conferma all'utente
                    const confirmMsg = `Vuoi aggiungere "${workout.title}" alle tue schede?`;
                    if (!confirm(confirmMsg)) return;
                    
                    // Usa la variabile globale customSchede invece di crearne una locale
                    // Crea un ID univoco per la nuova scheda
                    const schedeId = 'ai_' + Date.now();
                    
                    // Converti il formato workout in formato scheda
                    // Se ci sono più giorni, crea una scheda per ogni giorno
                    if (workout.workout_days && workout.workout_days.length > 0) {
                        workout.workout_days.forEach((day, index) => {
                            const dayId = schedeId + '_day' + index;
                            // Accorcia il nome della scheda (es: "Giorno 1" invece del titolo completo)
                            customSchede[dayId] = {
                                name: day.day || `Giorno ${index + 1}`,
                                exercises: day.exercises.map(ex => ({
                                    name: ex.name,
                                    sets: parseInt(ex.sets) || 3,
                                    reps: parseInt(ex.reps) || 10,
                                    weight: 0,  // L'utente inserirà il peso durante l'allenamento
                                    notes: ex.notes || ''  // Salva le note dell'AI
                                }))
                            };
                        });
                    } else {
                        // Fallback: se non ci sono workout_days, prova a salvare come singola scheda
                        customSchede[schedeId] = {
                            name: 'Scheda AI',
                            exercises: (workout.exercises || []).map(ex => ({
                                ...ex,
                                notes: ex.notes || ''
                            }))
                        };
                    }
                    
                    // Salva le schede aggiornate nel localStorage
                    localStorage.setItem('customSchede', JSON.stringify(customSchede));
                    
                    // Ricarica le schede in entrambe le UI
                    renderSchedaButtons();   // Per la pagina "Allenamento"
                    renderSchedaEditors();   // Per la pagina "Schede"
                    
                } catch (error) {
                    console.error('Errore nel salvataggio della scheda:', error);
                    alert('❌ Errore nel salvataggio della scheda');
                }
            };
        }

        function sendAIMessage(messageOverride = null) {
            const aiInput = document.getElementById('aiInput');
            const message = messageOverride || aiInput.value.trim();
            
            if (!message) return;

            // Add user message
            addAIMessage(message, 'user');
            
            // Clear input only if we didn't override the message
            if (!messageOverride) {
                aiInput.value = '';
                aiInput.style.height = 'auto';
                document.getElementById('aiSendBtn').disabled = true;
            }

            // Show typing indicator
            showAITyping();

            // Simulate AI response delay
            setTimeout(() => {
                hideAITyping();
                const response = generateAIResponse(message);
                addAIMessage(response.text, 'assistant', response.template);
            }, 1500 + Math.random() * 1000);
        }

        function addAIMessage(text, sender, template = null) {
            const messagesContainer = document.getElementById('aiChatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ${sender}`;
            
            let content = `<div class="ai-message-bubble">${text}</div>`;
            
            if (template) {
                content += `
                    <div class="ai-template-preview">
                        <h4>🏋️ ${template.name}</h4>
                        <ul class="ai-template-exercises">
                            ${template.exercises.map(ex => {
                                let exerciseText = ex.name;
                                if (ex.duration) {
                                    exerciseText += ` - ${ex.duration}`;
                                } else {
                                    exerciseText += ` - ${ex.sets} serie × ${ex.reps} reps`;
                                    if (ex.weight > 0) exerciseText += ` @ ${ex.weight}kg`;
                                }
                                return `<li>${exerciseText}</li>`;
                            }).join('')}
                        </ul>
                        <button class="ai-use-template-btn" onclick="useAITemplate('${template.id}')">
                            Usa questa scheda
                        </button>
                    </div>
                `;
            }
            
            messageDiv.innerHTML = content;
            messagesContainer.appendChild(messageDiv);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showAITyping() {
            document.getElementById('aiTypingIndicator').style.display = 'flex';
            const messagesContainer = document.getElementById('aiChatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideAITyping() {
            document.getElementById('aiTypingIndicator').style.display = 'none';
        }

        function generateAIResponse(userMessage) {
            const message = userMessage.toLowerCase();
            
            // Scheda generation responses
            if (message.includes('scheda') || message.includes('Scheda') || message.includes('programma')) {
                if (message.includes('principianti') || message.includes('beginner')) {
                    return {
                        text: "🌟 **Ecco una scheda perfetta per principianti!**\n\n\n✨ Si concentra sui movimenti base e permette di imparare la tecnica corretta.\n\n\n💪 **Esercizi inclusi:**\n• Squat - Movimento fondamentale per gambe\n• Panca Piana - Base per il petto\n• Rematore - Per la schiena\n• Military Press - Spalle da urlo\n• Plank - Core solido\n\n\n🚀 **Inizia oggi e vedrai progressi incredibili!**",
                        template: {
                            id: 'ai_beginner_' + Date.now(),
                            name: '🌟 Scheda Principianti',
                            exercises: [
                                { name: 'Squat', sets: 3, reps: 12, weight: 40 },
                                { name: 'Panca Piana', sets: 3, reps: 10, weight: 50 },
                                { name: 'Rematore con Bilanciere', sets: 3, reps: 10, weight: 40 },
                                { name: 'Military Press', sets: 3, reps: 8, weight: 30 },
                                { name: 'Plank', sets: 3, reps: 30, weight: 0 }
                            ]
                        }
                    };
                } else if (message.includes('push') && message.includes('pull')) {
                    return {
                        text: "🔄 **Ottima scelta! Ecco una scheda Push/Pull/Legs bilanciata**\n\n\n💪 Per massimizzare i tuoi risultati con allenamenti equilibrati!\n\n\n🏋️ **Giorno Push:** Pettorali, spalle, tricipiti\n\n🏋️ **Giorno Pull:** Schiena, bicipiti\n\n🏋️ **Giorno Legs:** Gambe complete\n\n\n🎯 **Esercizi top:** Panca, squat, stacchi, trazioni, dips!\n\n\n⚡ **Pronto per risultati esplosivi?**",
                        template: {
                            id: 'ai_ppl_' + Date.now(),
                            name: '🔄 Push/Pull/Legs',
                            exercises: [
                                { name: 'Panca Piana', sets: 4, reps: 8, weight: 80 },
                                { name: 'Trazioni', sets: 4, reps: 8, weight: 0 },
                                { name: 'Squat', sets: 4, reps: 10, weight: 100 },
                                { name: 'Dips', sets: 3, reps: 12, weight: 0 },
                                { name: 'Pulley', sets: 3, reps: 12, weight: 45 },
                                { name: 'Stacchi Rumeni', sets: 3, reps: 10, weight: 80 }
                            ]
                        }
                    };
                } else if (message.includes('forza') || message.includes('strength')) {
                    return {
                        text: "💥 **Per aumentare la forza, ecco una scheda focalizzata sui grandi movimenti**\n\n\n🏆 Con carichi elevati per risultati massimali!\n\n\n⚡ **Esercizi pesanti:**\n• Squat 5x5 - Gambe esplosive\n• Panca 5x5 - Petto potente\n• Stacco 5x5 - Schiena da titano\n• Military Press - Spalle forti\n\n\n🔥 **Diventa più forte ogni settimana!**",
                        template: {
                            id: 'ai_strength_' + Date.now(),
                            name: '💥 Forza Massimale',
                            exercises: [
                                { name: 'Squat', sets: 5, reps: 5, weight: 120 },
                                { name: 'Panca Piana', sets: 5, reps: 5, weight: 90 },
                                { name: 'Stacco da Terra', sets: 5, reps: 5, weight: 140 },
                                { name: 'Military Press', sets: 4, reps: 6, weight: 50 }
                            ]
                        }
                    };
                } else if (message.includes('cardio') || message.includes('running') || message.includes('corsa')) {
                    return {
                        text: "🏃 **Ecco una scheda cardio completa per migliorare la resistenza!**\n\n\n💓 **Sessione bilanciata:** Riscaldamento, lavoro principale, defaticamento\n\n\n🏃‍♂️ **Esercizi inclusi:**\n• Corsa leggera - Riscaldamento\n• Interval training - Bruciare calorie\n• Camminata veloce - Recupero attivo\n• Allungamenti - Recupero muscolare\n\n\n⏱️ **Durata:** 45-60 minuti per sessione\n\n\n💪 **Migliora la tua capacità cardiovascolare!**",
                        template: {
                            id: 'ai_cardio_' + Date.now(),
                            name: '🏃 Cardio Session',
                            exercises: [
                                { name: 'Riscaldamento - Corsa leggera', sets: 1, reps: 1, weight: 0, duration: '10 min' },
                                { name: 'Interval Training - Sprint', sets: 8, reps: 1, weight: 0, duration: '30 sec lavoro / 1 min recupero' },
                                { name: 'Defaticamento - Camminata', sets: 1, reps: 1, weight: 0, duration: '10 min' },
                                { name: 'Allungamenti', sets: 1, reps: 1, weight: 0, duration: '5 min' }
                            ]
                        }
                    };
                }
            }
            
            // Exercise suggestions
            if (message.includes('pettorali') || message.includes('petto') || message.includes('chest') || message.includes('torace')) {
                const chestResponses = [
                    "🏆 **Come Personal Trainer Elite, ecco la mia strategia scientifica per pettorali da campione:**\n\n\n🔬 **SCIENZA DEL PETTO:** I pettorali sono composti da 3 fasci principali (clavicolare, sternale, costale) che richiedono angoli diversi per una crescita completa.\n\n\n💪 **PROGRAMMA ELITE - 4 Giorni/Settimana:**\n\n**GIORNO 1: VOLUME MASSIMALE**\n• Panca Piana 4x8-12 (70-80% 1RM) - Base di tutto\n• Panca Inclinata Manubri 4x10-12 - Upper chest focus\n• Croci Cavi 3x12-15 - Definizione e separazione\n• Push-ups 3x max - Core stability\n\n**GIORNO 2: INTENSITÀ TECNICA**\n• Panca Declinata 4x6-8 - Lower chest emphasis\n• Military Press 3x8-10 - Spalle integrità\n• Dips Ponderati 3x8-12 - Tricipiti sinergia\n• Pec Deck 3x15 - Isolamento finale\n\n**GIORNO 3: RECUPERO ATTIVO**\n• Panca Piana Leggera 3x15-20\n• Croci Manubri 3x12-15\n• Push-ups Varianti 3x10-15\n\n**GIORNO 4: FORZA MASSIMALE**\n• Panca Piana Close-Grip 5x5 (85% 1RM)\n• Panca Inclinata 5x5\n• Dips Bodyweight 4x max\n\n🔥 **PROTOCOLLO NUTRIZIONALE:**\n• 2.2-2.5g/kg proteina giornaliera\n• Surplus calorico 300-500 kcal\n• Focus su carboidrati pre/post workout\n• BCAA durante allenamento\n\n⚡ **SUPPLEMENTI CONSIGLIATI:**\n• Creatina 5g/giorno\n• Beta-Alanina 3-5g\n• Glutammina 5g post-workout\n• ZMA per recupero testosterone\n\n� **TRACKING PROGRESSI:**\n• Misura circonferenza torace ogni 4 settimane\n• Foto progress settimanali\n• Test forza ogni 6-8 settimane\n\n💡 **SEGRETI DEI PRO:**\n• Usa pause isometriche (3-5 secondi)\n• Varia grip width regolarmente\n• Incorpora tecniche avanzate (rest-pause, dropsets)\n• Focus mentale: visualizza la contrazione\n\n🚀 **RISULTATI ATTESI:** 1-2cm di circonferenza in 8-12 settimane con costanza!",
                    "🏋️‍♂️ **Protocollo Pettorali Avanzato - Metodo Scientifico per Ipertrofia Massimale:**\n\n\n📊 **FISIOLOGIA MUSCOLARE:** I pettorali rispondono meglio a stimoli composti (multi-articolari) combinati con isolamento. Il range 8-12 reps è ottimale per crescita.\n\n\n🎯 **PROGRAMMAZIONE PERIODIZZATA:**\n\n**FASE 1: IPERTROFIA (4-6 settimane)**\n• Panca Piana: 4x10-12 @ 70-75% 1RM\n• Panca Inclinata: 4x10-12 @ 65-70% 1RM\n• Croci Manubri: 3x12-15\n• Push-ups: 3x max reps\n\n**FASE 2: FORZA (4 settimane)**\n• Panca Piana: 5x5 @ 80-85% 1RM\n• Panca Inclinata: 5x5 @ 75-80% 1RM\n• Dips: 4x6-8\n• Military Press: 3x8-10\n\n**FASE 3: DEFINIZIONE (4 settimane)**\n• Panca Piana: 3x15-20 @ 50-60% 1RM\n• Croci Cavi: 4x15-20\n• Pec Deck: 4x20\n• Cable Flyes: 3x12-15\n\n🔬 **BIOMECCANICA OTTIMALE:**\n• Arco lombare naturale (non esagerato)\n• Scapole retratte e depresse\n• Gomiti a 45° dal corpo\n• Polsi neutri, non flessi\n\n⚠️ **PREVENZIONE INFORTUNI:**\n• Riscaldamento con mobilità spalla\n• Rotator cuff exercises\n• Evita lockout completo se hai instabilità\n• Monitora dolore spalla\n\n💊 **RECUPERO STRATEGICO:**\n• Foam rolling petto e spalle\n• Stretching post-workout\n• 48-72 ore recupero tra sessioni\n• Massaggio sportivo settimanale\n\n📈 **METRICHE SUCCESSO:**\n• Aumento forza 5-10% ogni 4 settimane\n• Miglioramento endurance muscolare\n• Miglior simmetria bilaterale\n• Riduzione grasso corporeo per definizione\n\n🎖️ **MENTALITÀ CAMPIONE:**\n• Visualizzazione contrazione muscolare\n• Focus sulla qualità, non quantità\n• Pazienza: risultati in 3-6 mesi consistenti\n• Celebra piccoli progressi settimanali\n\n🏆 **DIVENTA UN MOSTRO DEL PETTO!**",
                    "� **Sistema Pettorali Olimpico - Protocollo da Campione del Mondo:**\n\n\n🔥 **FILOSOFIA ALLENAMENTO:** Il petto è il biglietto da visita di un fisico impressionante. Combiniamo scienza, tecnica perfetta e intensità calcolata.\n\n\n🏗️ **ARCHITETTURA PROGRAMMA:**\n\n**SESSIONE A: FORZA PRIORITARIA**\n• Panca Piana Competition 5x3 @ 85-90% 1RM\n• Panca Inclinata Manubri 4x8-10\n• Dips Ponderati 4x8-12\n• Croci Cavi 3x12-15\n\n**SESSIONE B: IPERTROFIA SPECIALIZZATA**\n• Panca Declinata 4x10-12\n• Hammer Strength Press 4x10-12\n• Pec Deck 3x15-20\n• Push-ups Diamante 3x max\n\n**SESSIONE C: TECNICA E RECUPERO**\n• Panca Piana Leggera 3x15-20\n• Face Pulls 3x12-15 (spalle posteriori)\n• Stretching Dinamico 10 minuti\n\n⚡ **PROTOCOLLO INTENSITÀ:**\n• RPE 7-9 per ipertrofia ottimale\n• Tempo sotto tensione 40-60 secondi\n• Pause 2-3 secondi in posizioni di massima contrazione\n• Supersets per aumentare densità\n\n🧬 **NUTRIZIONE PRECISIONE:**\n• Finestra anabolica 30-60 min post-workout\n• Rapporto macro: 40% carb, 30% protein, 30% fat\n• Timing pasti ogni 3-4 ore\n• Idratazione 4-5L acqua giornaliera\n\n� **STRUMENTAZIONE AVANZATA:**\n• Tracking GPS forza (app come StrengthLog)\n• Analisi video tecnica\n• Biofeedback EMG per attivazione muscolare\n• Test periodici forza massima\n\n🛡️ **GESTIONE RISCHI:**\n• Assessment mobilità spalla pre-allenamento\n• Correzione posture disallineate\n• Protocollo riscaldamento specifico\n• Monitoraggio DOMS e prevenzione overtraining\n\n🎯 **OBIETTIVI QUANTIFICABILI:**\n• Guadagno 0.5-1kg massa magra/mese\n• Aumento circonferenza torace 2-3cm/trimestre\n• Miglioramento forza 10-15% ogni ciclo\n• Riduzione % grasso per definizione\n\n� **PSICOLOGIA PERFORMANCE:**\n• Mental rehearsal contrazioni\n• Goal setting SMART\n• Accountability partner\n• Celebrazione milestone\n\n🏅 **IL TUO PETTO SARÀ LEGGENDARIO!**",
                    "�️‍♀️ **Metodo Pettorali Femminili - Forza & Forma Armoniosa:**\n\n\n💖 **APPROCCIO OLISTICO:** Per le donne, il petto non è solo forza ma anche forma estetica. Bilanciamo potenza e grazia.\n\n\n🌸 **PROGRAMMA 3 GIORNI/SETTIMANA:**\n\n**GIORNO PUSH SUPERIORE**\n• Panca Piana 3x10-12 @ 60-70% 1RM\n• Panca Inclinata Manubri 3x12-15\n• Military Press 3x10-12\n• Tricep Pushdown 3x12-15\n\n**GIORNO TIRAGGIO**\n• Trazioni Assistite 3x8-12\n• Rematore Manubri 3x10-12\n• Face Pulls 3x12-15\n• Bicep Curls 3x12-15\n\n**GIORNO GAMBE & CORE**\n• Squat 3x10-12\n• Leg Press 3x12-15\n• Plank 3x30-60 sec\n• Russian Twists 3x15/side\n\n🎨 **ESTETICA & FORMA:**\n• Focus su upper chest per décolleté\n• Esercizi unilaterali per simmetria\n• Combinazione cardio per definizione\n• Postura corretta per presentazione\n\n� **RECUPERO DELICATO:**\n• Yoga e pilates integrati\n• Massaggi linfodrenanti\n• Alimentazione anti-infiammatoria\n• Sonno qualità 7-9 ore\n\n✨ **RISULTATI DONNA MODERNA:**\n• Forza funzionale aumentata\n• Corpo tonico e proporzionato\n• Energia quotidiana migliorata\n• Fiducia personale potenziata\n\n👑 **SII LA TUA VERSIONE MIGLIORE!**",
                    "🔬 **Ricerca Scientifica Pettorali 2025 - Protocollo Evidence-Based:**\n\n\n📚 **STUDI RIVOLUZIONARI:**\n• Meta-analisi Journal Strength & Conditioning: range 6-12 reps ottimale\n• Ricerca EMG: attivazione massima a 45° elbow angle\n• Studi longitudinali: guadagno 0.25-0.5% forza/settimana\n\n\n⚗️ **PROTOCOLLO SPERIMENTALE:**\n\n**SETTIMANA 1-4: ADATTAMENTO**\n• Panca Piana 3x12 @ 60% 1RM\n• Panca Inclinata 3x12 @ 55% 1RM\n• Croci 3x15\n• Push-ups 3x max\n\n**SETTIMANA 5-8: PROGRESSIONE**\n• Panca Piana 4x10 @ 65% 1RM\n• Panca Inclinata 4x10 @ 60% 1RM\n• Croci 4x12\n• Dips 3x10\n\n**SETTIMANA 9-12: INTENSIFICAZIONE**\n• Panca Piana 4x8 @ 70% 1RM\n• Panca Inclinata 4x8 @ 65% 1RM\n• Croci 4x10\n• Military Press 3x10\n\n**SETTIMANA 13-16: PEAK**\n• Panca Piana 5x5 @ 75% 1RM\n• Panca Inclinata 5x5 @ 70% 1RM\n• Croci 4x8\n• Dips 4x8\n\n📊 **TRACKING SCIENTIFICO:**\n• Misurazioni antropometriche\n• Test forza periodici\n• Analisi composizione corporea\n• Questionari qualità vita\n\n🧪 **VARIABILI CONTROLLATE:**\n• Alimentazione standardizzata\n• Sonno monitorato\n• Stress valutato\n• Recupero quantificato\n\n🎯 **CONCLUSIONI:**\n• Progressione lineare efficace\n• Combinazione esercizi ottimale\n• Recupero critico per risultati\n• Consistenza chiave successo\n\n🔬 **LA SCIENZA FUNZIONA!**"
                ];
                return {
                    text: chestResponses[Math.floor(Math.random() * chestResponses.length)]
                };
            }
            
            if (message.includes('schiena') || message.includes('dorso') || message.includes('back') || message.includes('schienale')) {
                const backResponses = [
                    "🏆 **Sistema Schiena Elite - Protocollo da Bodybuilder Professionista:**\n\n\n🔬 **SCIENZA DELLA SCHIENA:** La schiena è composta da 3 strati muscolari (superficiali, intermedi, profondi) che richiedono stimoli specifici per sviluppo 3D completo.\n\n\n💪 **PROGRAMMAZIONE COMPETITION-READY - 4 Giorni/Settimana:**\n\n**GIORNO 1: LATS & UPPER BACK (VERTICAL PULL)**\n• Trazioni alla Sbarra 4x6-10 (BW o weighted) - King of back exercises\n• Lat Pulldown 4x10-12 - Machine alternative\n• Face Pulls 3x15-20 - Rear delt & upper back\n• Straight-Arm Pulldown 3x12-15 - Lats isolation\n\n**GIORNO 2: THICKNESS & POSTERIOR CHAIN**\n• Rematore Bilanciere 4x8-10 (75-80% 1RM) - Thickness builder\n• Rematore Manubri 4x10-12 - Unilateral focus\n• Stacco Rumeno 4x8-10 - Posterior chain\n• Shrugs 3x12-15 - Upper traps\n\n**GIORNO 3: WIDTH & DETAIL WORK**\n• Lat Pulldown Wide Grip 4x12-15 - Width emphasis\n• Seated Cable Row 4x10-12 - Controlled power\n• T-Bar Row 3x10-12 - Old school mass builder\n• Rear Delt Flyes 3x15 - Balanced development\n\n**GIORNO 4: STRENGTH & POWER**\n• Deadlift 5x3 (80-85% 1RM) - Full posterior chain dominance\n• Pull-ups Weighted 4x6-8 - Strength focus\n• Good Mornings 3x10-12 - Hamstring & back\n• Farmer Walk 3x40m - Grip & core\n\n🔥 **NUTRIZIONE BACK-BUILDING:**\n• Proteina 2.2-2.5g/kg per sintesi muscolare elevata\n• Carb-loading pre-workout per energia lattes\n• Glutammina 5g post-workout per recupero\n• Omega-3 per salute articolare\n\n⚡ **SUPPLEMENTI SPECIALIZZATI:**\n• Creatina per forza esplosiva\n• Beta-Alanine per endurance\n• BCAAs intra-workout\n• ZMA per recupero testosterone\n\n🎯 **TRACKING PROGRESSI:**\n• Misura circonferenza schiena ogni mese\n• Foto progress da lati diversi\n• Test forza deadlift ogni 6 settimane\n• Monitoraggio mobilità spalla\n\n💡 **TECNICHE PRO:**\n• Mind-muscle connection enfatizzata\n• Stretch-mediated activation\n• Drop sets per failure training\n• Rest-pause per intensità\n\n⚠️ **PREVENZIONE INFORTUNI:**\n• Warm-up con cat-cow stretch\n• Form check video settimanale\n• Evita shrugging nelle trazioni\n• Monitora dolore spalla\n\n🚀 **RISULTATI ATTESI:** Schiena più larga del 20-30% in 16 settimane con costanza!",
                    "🏋️‍♂️ **Protocollo Schiena Olimpico - Metodo Powerlifting & Bodybuilding:**\n\n\n📊 **RICERCA MUSCOLARE:** Studi dimostrano che esercizi composti + isolamento producono 40% più ipertrofia rispetto a composti soli.\n\n\n🎯 **PROGRAMMA PERIODIZZATO:**\n\n**FASE 1: STRENGTH FOUNDATION (8 settimane)**\n• Deadlift: 4x6-8 @ 75-80% 1RM\n• Pull-ups: 4x8-10 BW\n• Bent-over Row: 4x8-10\n• Lat Pulldown: 3x10-12\n\n**FASE 2: HYPERTROPHY SPECIALIZATION (6 settimane)**\n• Pull-ups: 3x10-12 weighted\n• Seated Cable Row: 4x10-12\n• T-Bar Row: 4x10-12\n• Face Pulls: 3x15-20\n\n**FASE 3: STRENGTH PEAK (4 settimane)**\n• Deadlift: 5x3 @ 85% 1RM\n• Weighted Pull-ups: 5x5\n• Bent-over Row: 5x5\n• Good Mornings: 4x8-10\n\n**FASE 4: PEAK & DELoad (4 settimane)**\n• Light Deadlift: 3x8 @ 60% 1RM\n• Pull-ups: 3x12 BW\n• Cable Work: 3x15\n• Mobility Work\n\n🔬 **BIOMECCANICA OTTIMALE:**\n• Scapole retratte durante pull\n• Core braced rigid\n• Hinge da anche, non schiena\n• Respirazione coordinata\n\n🛡️ **PROTOCOLLO SICUREZZA:**\n• Assessment mobilità pre-sessione\n• Attivazione cuffia rotatoria\n• Correzione posture disallineate\n• Monitoraggio DOMS\n\n💊 **RECUPERO STRATEGICO:**\n• Foam rolling schiena post-workout\n• Stretching dinamico e statico\n• Ice bath per riduzione infiammazione\n• Massaggio sportivo settimanale\n\n📈 **METRICHE SUCCESSO:**\n• Deadlift +30-40kg/trimestre\n• Pull-ups +5-8 reps BW\n• Miglioramento composizione corporea\n• Riduzione asimmetrie\n\n🎖️ **MENTALITÀ VINCENTE:**\n• Back day è sacro\n• Quality over quantity\n• Patience con progressione\n• Celebrate ogni PR\n\n🏆 **SCHIENA CHE COMANDA RISPETTO!**",
                    "🌟 **Sistema Schiena Funzionale - Performance Athletica Completa:**\n\n\n🔥 **FILOSOFIA ALLENAMENTO:** Schiena forte = atleta completo. Combiniamo estetica con funzionalità reale.\n\n\n🏗️ **ARCHITETTURA PROGRAMMA:**\n\n**SESSIONE A: VERTICAL PULL PRIORITY**\n• Pull-ups 5x3-8 - Strength foundation\n• Lat Pulldown 4x10-12 - Width builder\n• Face Pulls 4x15-20 - Posteriore chain\n• Straight-Arm Pulldown 3x12-15\n\n**SESSIONE B: HORIZONTAL PULL POWER**\n• Bent-over Row 5x5 @ 80% 1RM - Power focus\n• Seated Cable Row 4x10-12 - Controlled strength\n• T-Bar Row 4x10-12 - Mass builder\n• Rear Delt Flyes 3x15\n\n**SESSIONE C: POSTERIOR CHAIN INTEGRATION**\n• Deadlift 4x6-8 - Full chain activation\n• Romanian Deadlift 4x8-10 - Hamstring focus\n• Good Mornings 3x10-12 - Stability\n• Farmer Walk 3x40m\n\n**SESSIONE D: EXPLOSIVE & SPEED**\n• Speed Pull-ups 4x6 @ 70% max\n• Medicine Ball Slams 3x10 - Power development\n• Battle Ropes 3x30s - Conditioning\n• Plyometric Push-ups 3x8\n\n⚡ **INTENSITÀ PROGRESSIVA:**\n• RPE 8-9 per crescita ottimale\n• Tempo sotto tensione 50-70 secondi\n• Tecniche avanzate: clusters, eccentrics\n• Supersets per densità\n\n🧬 **NUTRIZIONE PERFORMANCE:**\n• Peri-workout nutrition timing\n• Carb cycling per energia\n• Protein spread throughout day\n• Hydration optimization\n\n🔧 **STRUMENTAZIONE:**\n• Force plates per power metrics\n• EMG per attivazione muscolare\n• Video analisi biomeccanica\n• Recovery tracking devices\n\n🛡️ **RISK MANAGEMENT:**\n• Pre-hab protocolli completi\n• Load monitoring sistematico\n• Injury prevention screening\n• Psychological readiness\n\n🎯 **OBIETTIVI MISURABILI:**\n• Strength gains 20-30%\n• Power output aumentato\n• Injury-free performance\n• Body composition migliorata\n\n💎 **PSICOLOGIA PEAK:**\n• Mental toughness training\n• Visualization techniques\n• Accountability systems\n• Success celebration\n\n🏅 **SCHIENA CHE VINCE COMPETIZIONI!**",
                    "🏋️‍♀️ **Schiena Femminile Armoniosa - Forza & Grazia Posturale:**\n\n\n💖 **APPROCCIO OLISTICO:** Per le donne, schiena forte significa postura elegante e salute duratura.\n\n\n🌸 **PROGRAMMA 3 GIORNI/SETTIMANA:**\n\n**GIORNO PULL A**\n• Lat Pulldown 3x12-15\n• Seated Cable Row 3x10-12\n• Face Pulls 3x15-20\n• Rear Delt Flyes 3x12-15\n\n**GIORNO PULL B**\n• Assisted Pull-ups 3x8-12\n• Bent-over Row Light 3x12-15\n• Straight-Arm Pulldown 3x12-15\n• Shrugs 3x15\n\n**GIORNO FULL BODY**\n• Deadlift Light 3x8-10\n• Good Mornings 3x10-12\n• Plank Variations 3x30-60s\n• Core Work 3x20\n\n🎨 **ESTETICA & FORMA:**\n• Focus su V-taper armonioso\n• Postura migliorata visibile\n• Tonificazione senza bulk eccessivo\n• Equilibrio muscolare\n\n🌿 **RECUPERO DELICATO:**\n• Yoga per schiena\n• Stretching profondo\n• Massaggi decontratturanti\n• Sonno ristoratore\n\n✨ **RISULTATI:**\n• Schiena più dritta e forte\n• Miglioramento postura quotidiana\n• Energia aumentata\n• Sicurezza personale\n\n👑 **ILLUMINA LA TUA FORZA INTERIORE!**",
                    "🔬 **Ricerca Schiena 2025 - Protocollo Evidence-Based:**\n\n\n📚 **STUDI RIVOLUZIONARI:**\n• Meta-analysis: esercizi multi-articolari superiori per hypertrophy\n• EMG research: pull-ups attivano 100% dorsali\n• Longitudinal studies: strength gains 0.7-1%/week optimal\n\n\n⚗️ **PROTOCOLLO SPERIMENTALE:**\n\n**WEEK 1-4: ADAPTATION**\n• Lat Pulldown 3x12 @ 60% 1RM\n• Seated Cable Row 3x12\n• Face Pulls 3x20\n• Assisted Pull-ups 3x10\n\n**WEEK 5-8: PROGRESSION**\n• Pull-ups 4x8 BW\n• Bent-over Row 4x10 @ 65% 1RM\n• T-Bar Row 4x10\n• Rear Delt Flyes 3x15\n\n**WEEK 9-12: INTENSIFICATION**\n• Weighted Pull-ups 4x6\n• Deadlift 4x8 @ 70% 1RM\n• Cable Row 4x8\n• Good Mornings 3x10\n\n**WEEK 13-16: PEAK**\n• Deadlift 5x3 @ 80% 1RM\n• Pull-ups 5x5 weighted\n• Bent-over Row 5x5\n• Face Pulls 4x12\n\n📊 **TRACKING SCIENTIFICO:**\n• Anthropometric measurements\n• Strength testing periodico\n• DEXA body composition\n• Quality of life assessment\n\n🧪 **CONTROLLED VARIABLES:**\n• Standardized nutrition\n• Sleep monitoring\n• Stress assessment\n• Recovery quantification\n\n🎯 **CONCLUSIONS:**\n• Compound lifts fondamentali\n• Progressive overload essenziale\n• Recovery non negoziabile\n• Consistency chiave successo\n\n🔬 **SCIENCE DRIVES GAINS!**"
                ];
                return {
                    text: backResponses[Math.floor(Math.random() * backResponses.length)]
                };
            }
            
            // Arms category
            if (message.includes('braccia') || message.includes('bicipiti') || message.includes('tricipiti') || message.includes('arms') || message.includes('biceps') || message.includes('triceps')) {
                const armResponses = [
                    "💪 **Programma Braccia Efficace**\n\n**Allenamento 4 giorni/settimana:**\n\n**Giorno 1: Bicipiti**\n• Curl bilanciere: 4x8-10\n• Curl manubri: 3x10-12\n• Hammer curls: 3x12\n\n**Giorno 2: Tricipiti**\n• French press: 4x8-10\n• Pushdown: 4x10-12\n• Dips: 3x10-15\n\n**Giorno 3: Bicipiti + Volume**\n• Preacher curls: 4x12\n• Cable curls: 3x15\n• Chin-ups: 3x8-12\n\n**Giorno 4: Tricipiti + Forza**\n• Close-grip bench: 4x8-10\n• Skull crushers: 4x10\n• Kickbacks: 3x15\n\n**Consigli:** Riposo 48h tra sessioni, mangia proteina, usa tecnica perfetta!",
                    "🏋️‍♂️ **Braccia da Bodybuilder**\n\n**Focus su bicipiti e tricipiti bilanciati:**\n\n• **Bicipiti:** Curl variati (bilanciere, manubri, hammer)\n• **Tricipiti:** Estensioni e pushdown per definizione\n• **Frequenza:** 4-5 giorni/settimana\n• **Ripetizioni:** 8-15 per ipertrofia\n• **Progressione:** Aumenta peso ogni 1-2 settimane\n\n**Errore comune:** Non allenare entrambi i capi del braccio!",
                    "🌟 **Braccia Funzionali**\n\n**Per forza reale negli sport:**\n\n• Curl bilanciere: 4x6-8 (forza base)\n• Hammer curls: 3x10 (presa funzionale)\n• Chin-ups: 4x6-8 (compound)\n• Pushdown: 4x10 (velocità)\n• Dips: 4x8-12 (corpo intero)\n\n**Vantaggio:** Braccia forti per ogni movimento sportivo!",
                    "🏋️‍♀️ **Braccia Toniche**\n\n**Per donne - forza elegante:**\n\n**3 giorni/settimana:**\n• Curl manubri: 3x12-15\n• Tricep kickbacks: 3x12-15\n• Hammer curls: 3x12\n• Pushdown: 3x12\n\n**Focus:** Tonificazione senza volume eccessivo, posture migliorata!",
                    "🔬 **Braccia Evidence-Based**\n\n**Cosa funziona davvero:**\n• Compound + isolamento = crescita ottimale\n• Range 8-12 reps per massa\n• Progressive overload essenziale\n• Recupero 48-72 ore\n• Proteina 2g/kg peso corporeo\n\n**Risultato:** Braccia più grandi del 20% in 12 settimane!"
                ];
                return {
                    text: armResponses[Math.floor(Math.random() * armResponses.length)]
                };
            }
            
            // Cardio specific category
            if (message.includes('cardio') && !message.includes('scheda')) {
                const cardioResponses = [
                    "🏃‍♂️ **Cardio Efficace**\n\n**4 giorni/settimana per risultati ottimali:**\n\n**Giorno 1: HIIT**\n• Riscaldamento: 5 min\n• Sprint 30s / Recupero 60s x 8-10\n• Defaticamento: 5 min\n\n**Giorno 2: Endurance**\n• Corsa continua 45-60 min @ 60-70% FC max\n\n**Giorno 3: Interval**\n• 400m sprint / 2 min recupero x 6-8\n\n**Giorno 4: Cross-training**\n• Nuoto o ciclismo 30-45 min\n\n**Consiglio:** Varia l'intensità per evitare plateau!",
                    "🏃‍♀️ **Cardio Femminile**\n\n**Energia e benessere per donne:**\n\n**4 giorni/settimana:**\n• Camminata veloce 45-60 min\n• Dance cardio/Zumba 45 min\n• Nuoto 30-45 min\n• Yoga + cardio leggero 45 min\n\n**Benefici:** Migliora salute cardiovascolare, gestisce stress, aumenta energia!",
                    "🔬 **Cardio Evidence-Based**\n\n**Cosa funziona per perdere grasso:**\n• HIIT: 40% più efficace steady-state\n• Zone 2: ottimale per endurance\n• Recovery: cruciale per adattamento\n\n**Programma:** HIIT 2-3x/settimana + attività miste per evitare burnout!"
                ];
                return {
                    text: cardioResponses[Math.floor(Math.random() * cardioResponses.length)]
                };
            }
            
            // Weight loss specific category
            if (message.includes('perdere peso') || message.includes('dimagrire') || message.includes('weight loss') || message.includes('grasso')) {
                const weightLossResponses = [
                    "⚖️ **Dimagrimento Efficace**\n\n**6 giorni/settimana per risultati sostenibili:**\n\n**Allenamento:**\n• Giorni 1,3,5: Full body HIIT (45 min)\n• Giorni 2,4,6: Cardio + core (30-45 min)\n• Giorno 7: Active recovery\n\n**Alimentazione:**\n• Deficit 300-500 kcal/giorno\n• Proteina 1.8-2.2g/kg peso\n• Carb cycling (giorni high/low)\n• Acqua 3-4L/giorno\n\n**Risultato:** 0.5-1kg/grasso settimana in modo sostenibile!",
                    "🥗 **Piano Alimentare Dimagrimento**\n\n**Struttura pasti giornaliera:**\n\n**Colazione (400-500 kcal):**\n• Avena + frutta + yogurt greco\n• Uova + verdure + pane integrale\n\n**Spuntino (200 kcal):**\n• Frutta + mandorle\n• Yogurt + miele\n\n**Pranzo (500-600 kcal):**\n• Proteina magra + verdure + carb\n• Pesce + quinoa + broccoli\n\n**Cena (400-500 kcal):**\n• Proteina + verdure abbondanti\n• Zuppa + insalata + pesce\n\n**Regole:** Mangia ogni 3-4 ore, non saltare colazione, bevi acqua prima dei pasti!",
                    "🔬 **Dimagrimento Evidence-Based**\n\n**Cosa funziona davvero:**\n• Deficit 500 kcal/day = 0.5kg/week\n• Proteina 1.6g/kg preserva massa muscolare\n• HIIT + resistance training ottimale\n• Sonno cruciale per perdita grasso\n\n**Strategie chiave:** Track calorie, meal timing, habit formation, metabolism boost!"
                ];
                return {
                    text: weightLossResponses[Math.floor(Math.random() * weightLossResponses.length)]
                };
            }
            
            // Motivation and mindset category
            if (message.includes('motivazione') || message.includes('mentalità') || message.includes('discipline') || message.includes('costanza') || message.includes('motivation') || message.includes('mindset')) {
                const motivationResponses = [
                    "🔥 **Mentalità Vincente**\n\n**Principali abitudini per il successo:**\n\n**1. Visualizzazione giornaliera**\n• 10 min mattina: immagina il tuo corpo ideale\n• Usa tutti i sensi\n\n**2. Goal setting SMART**\n• Specific, Measurable, Achievable, Relevant, Time-bound\n\n**3. Abitudini**\n• Inizia piccolo (5 min/giorno)\n• 66 giorni per formare un'abitudine\n\n**4. Mindset shift**\n• Da 'devo' a 'voglio'\n• Focus su progresso\n\n**Ricorda:** Il 90% del successo è mentale!",
                    "🏆 **Disciplina Elite**\n\n**Routine campione giornaliera:**\n\n**5:00 - Sveglia**\n• Meditazione/visualizzazione\n• Allenamento mattutino\n\n**18:00 - Allenamento**\n• Sessione principale\n• Recupero nutrizionale\n\n**22:00 - Preparazione**\n• Cena leggera\n• Planning giorno successivo\n• Lettura 30 min\n\n**Sistema 5 secondi:** Conta 5-4-3-2-1, vai! Non pensare, agisci.\n\n**Accountability:** Partner o app per tracking progresso!",
                    "🌟 **Costanza nel Fitness**\n\n**La chiave del successo a lungo termine:**\n\n**Curva del successo:**\n1. Entusiasmo (prime 2 settimane)\n2. Realtà (settimane 3-8) - Qui molti mollano\n3. Trasformazione (mesi 3-6)\n4. Mastery (6+ mesi)\n\n**Strategie anti-abbandono:**\n• Ambiente motivazionale\n• Gruppo fitness\n• Reward system\n• 80/20 rule (80% consistent, 20% flexible)\n\n**Quando cala la motivazione:** Ricorda perché hai iniziato, focus sui benefici attuali!\n\nLa costanza è la differenza tra sogni e risultati!",
                ];
                return {
                    text: motivationResponses[Math.floor(Math.random() * motivationResponses.length)]
                };
            }
            
            if (message.includes('squat') && message.includes('tecnica')) {
                return {
                    text: "Ecco i punti chiave per un squat perfetto:\n\n\n🎯 **Setup**:\n• Piedi larghezza spalle, punte leggermente aperte\n• Bilanciere sui trapezi, non sul collo\n• Core attivato, petto in fuori\n\n\n🎯 **Esecuzione**:\n• Inizia spingendo i fianchi indietro\n• Scendi fino a quando le cosce sono parallele\n• Ginocchia in linea con le punte dei piedi\n• Risali spingendo attraverso i talloni\n\n\n⚠️ **Errori comuni da evitare**:\n• Ginocchia che cedono verso l'interno\n• Schiena che si incurva\n• Non scendere abbastanza\n• Peso sui talloni"
                };
            }
            
            // Exercise execution instructions
            if (message.includes('panca piana') || message.includes('bench press')) {
                return {
                    text: "Ecco come eseguire correttamente la Panca Piana:\n\n\n🎯 **Setup**:\n• Sdraiati sulla panca con i piedi ben piantati\n• Impugna il bilanciere con presa leggermente più larga delle spalle\n• Archi leggermente la schiena, spalle indietro\n\n\n🎯 **Esecuzione**:\n• Abbassa il bilanciere controllatamente fino al petto\n• Tocca il petto senza rimbalzare\n• Spingi verso l'alto esplosivamente\n• Blocca le braccia in alto senza iperestendere\n\n\n⚠️ **Errori comuni**:\n• Non abbassare abbastanza il bilanciere\n• Rimbalzare sul petto\n• Sollevare i glutei dalla panca\n• Non controllare la discesa"
                };
            }
            
            if (message.includes('trazioni') || message.includes('pull-ups')) {
                return {
                    text: "Guida completa alle Trazioni alla Sbarra:\n\n\n🎯 **Setup**:\n• Impugna la sbarra con presa prona (palmi in avanti)\n• Braccia completamente estese, spalle rilassate\n• Piedi uniti o leggermente divaricati\n\n\n🎯 **Esecuzione**:\n• Tira il corpo verso l'alto fino a quando il mento supera la sbarra\n• Abbassa controllatamente fino alle braccia tese\n• Mantieni il core contratto\n• Respira regolarmente\n\n\n💡 **Varianti**:\n• **Assisted**: Usa bande elastiche o macchina\n• **Negative**: Scendi lentamente, sali con aiuto\n• **Chin-ups**: Palmi verso di te per coinvolgere più bicipiti\n\n\n⚠️ **Errori comuni**:\n• Usare slancio (kipping)\n• Non completare il movimento\n• Oscillare il corpo"
                };
            }
            
            if (message.includes('squat') && !message.includes('tecnica')) {
                return {
                    text: "Lo Squat è uno dei fondamentali esercizi per le gambe. Ecco come eseguirlo:\n\n🎯 **Setup**:\n• Piedi larghezza spalle, punte leggermente aperte\n• Bilanciere sui trapezi posteriori\n• Guarda avanti, petto in fuori\n\n🎯 **Esecuzione**:\n• Inizia piegando anche e ginocchia contemporaneamente\n• Scendi fino a cosce parallele al suolo\n• Risali spingendo attraverso i talloni\n• Estendi completamente anche e ginocchia\n\n💡 **Varianti**:\n• **Front Squat**: Bilanciere sulle spalle anteriori\n• **Goblet Squat**: Manubrio al petto\n• **Bulgarian Split Squat**: Una gamba elevata\n\n⚠️ **Errori comuni**:\n• Ginocchia che collassano verso l'interno\n• Schiena che si incurva\n• Peso spostato sulle punte"
                };
            }
            
            if (message.includes('military press') || message.includes('shoulder press')) {
                return {
                    text: "Il Military Press per spalle potenti:\n\n🎯 **Setup**:\n• Siediti o stai in piedi con bilanciere al petto\n• Mani larghezza spalle, palmi in avanti\n• Gomiti sotto il bilanciere\n\n🎯 **Esecuzione**:\n• Spingi il bilanciere verso l'alto\n• Estendi completamente le braccia\n• Abbassa controllatamente al petto\n• Mantieni il core contratto\n\n💡 **Varianti**:\n• **Dumbbell Press**: Con manubri per maggiore range\n• **Arnold Press**: Rotazione durante il movimento\n• **Seated**: Più stabile per principianti\n\n⚠️ **Errori comuni**:\n• Inarcare eccessivamente la schiena\n• Usare slancio\n• Non completare il lockout"
                };
            }
            
            if (message.includes('rematore') || message.includes('row')) {
                return {
                    text: "Il Rematore con Bilanciere per una schiena forte:\n\n🎯 **Setup**:\n• Piedi larghezza spalle, ginocchia leggermente piegate\n• Impugna il bilanciere con presa prona\n• Schiena neutra, petto in fuori\n\n🎯 **Esecuzione**:\n• Tira il bilanciere verso l'addome\n• Contrai i dorsali, spingi indietro le spalle\n• Abbassa controllatamente\n• Mantieni la schiena dritta\n\n💡 **Varianti**:\n• **Dumbbell Row**: Singolo braccio per focus unilaterale\n• **Cable Row**: Macchina per tensione costante\n• **T-Bar Row**: Per maggiore isolamento\n\n⚠️ **Errori comuni**:\n• Usare slancio\n• Arrotondare la schiena\n• Non contrarre i dorsali"
                };
            }
            
            if (message.includes('panca inclinata') || message.includes('incline bench') || message.includes('petto inclinato')) {
                return {
                    text: "La Panca Inclinata per la parte superiore del petto:\n\n🎯 **Setup**:\n• Inclina la panca a 30-45 gradi\n• Sdraiati con i piedi ben piantati\n• Impugna il bilanciere più largo delle spalle\n\n🎯 **Esecuzione**:\n• Abbassa il bilanciere al petto controllatamente\n• Spingi verso l'alto esplosivamente\n• Blocca le braccia senza iperestendere\n• Mantieni le spalle indietro\n\n💡 **Benefici**:\n• Sviluppa la parte clavicolare del petto\n• Migliora la definizione superiore\n• Complementa la panca piana tradizionale\n\n⚠️ **Errori comuni**:\n• Inclinare troppo la panca\n• Non controllare la discesa\n• Sollevare i glutei"
                };
            }
            
            if (message.includes('spinte manubri') || message.includes('dumbbell press') || message.includes('petto manubri')) {
                return {
                    text: "Le Spinte con Manubri per un petto bilanciato:\n\n🎯 **Setup**:\n• Sdraiati sulla panca con manubri al petto\n• Palmi in avanti, gomiti a 45 gradi\n• Piedi ben piantati a terra\n\n🎯 **Esecuzione**:\n• Spingi i manubri verso l'alto simultaneamente\n• Estendi le braccia senza bloccare\n• Abbassa controllatamente fino al petto\n• Mantieni il core contratto\n\n💡 **Vantaggi**:\n• Maggiore range di movimento\n• Bilancia eventuali asimmetrie\n• Coinvolge stabilizzatori aggiuntivi\n\n⚠️ **Errori comuni**:\n• Lasciare cadere i manubri\n• Non controllare la discesa\n• Usare slancio"
                };
            }
            
            if (message.includes('dips') || message.includes('parallele')) {
                return {
                    text: "I Dips per tricipiti e petto inferiore:\n\n🎯 **Setup**:\n• Impugna le parallele con braccia tese\n• Gambe incrociate dietro o estese\n• Corpo leggermente inclinato in avanti\n\n🎯 **Esecuzione**:\n• Abbassa il corpo piegando i gomiti\n• Scendi fino a 90 gradi nei gomiti\n• Spingi verso l'alto senza bloccare\n• Mantieni le spalle basse\n\n💡 **Varianti**:\n• **Chest Dips**: Inclinato in avanti per più petto\n• **Tricep Dips**: Corpo verticale per più tricipiti\n• **Assisted**: Usa bande elastiche\n\n⚠️ **Errori comuni**:\n• Scendere troppo in basso\n• Usare slancio\n• Non controllare il movimento"
                };
            }
            
            if (message.includes('tricep pushdown') || message.includes('pushdown') || message.includes('tricipiti cavo')) {
                return {
                    text: "Il Tricep Pushdown per isolare i tricipiti:\n\n🎯 **Setup**:\n• Impugna la corda o barra del cavo\n• Gomiti fissi ai fianchi\n• Palmi in avanti o neutri\n\n🎯 **Esecuzione**:\n• Estendi le braccia verso il basso\n• Contrai i tricipiti completamente\n• Ritorna lentamente alla posizione iniziale\n• Mantieni i gomiti immobili\n\n💡 **Varianti**:\n• **Rope**: Per maggiore coinvolgimento\n• **Straight Bar**: Per focus centrale\n• **Reverse Grip**: Per diverso angolo\n\n⚠️ **Errori comuni**:\n• Muovere i gomiti\n• Usare slancio\n• Non completare l'estensione"
                };
            }
            
            if (message.includes('lat machine') || message.includes('lat pulldown') || message.includes('tirate machine')) {
                return {
                    text: "La Lat Machine per una schiena ampia:\n\n🎯 **Setup**:\n• Siediti con cosce sotto i supporti\n• Impugna la barra con presa larga\n• Schiena leggermente inclinata indietro\n\n🎯 **Esecuzione**:\n• Tira la barra verso il petto\n• Contrai i dorsali e le spalle indietro\n• Abbassa controllatamente\n• Mantieni il petto in fuori\n\n💡 **Varianti**:\n• **Wide Grip**: Per larghezza\n• **Narrow Grip**: Per spessore\n• **Behind Neck**: Per maggiore range (cautela)\n\n⚠️ **Errori comuni**:\n• Usare slancio\n• Non contrarre i dorsali\n• Arrotondare la schiena"
                };
            }
            
            if (message.includes('pulley') || message.includes('face pull') || message.includes('tirate faccia')) {
                return {
                    text: "Il Pulley (Face Pull) per spalle posteriori:\n\n🎯 **Setup**:\n• Impugna la corda del cavo all'altezza del viso\n• Fai un passo indietro per tensione\n• Gomiti alti, paralleli al suolo\n\n🎯 **Esecuzione**:\n• Tira la corda verso il viso\n• Separa le mani ai lati della testa\n• Contrai i posteriori delle spalle\n• Ritorna controllatamente\n\n💡 **Benefici**:\n• Migliora la postura\n• Previene infortuni alle spalle\n• Equilibra lo sviluppo deltoideo\n\n⚠️ **Errori comuni**:\n• Usare troppo peso\n• Non controllare il movimento\n• Abbassare i gomiti"
                };
            }
            
            if (message.includes('curl bilanciere') || message.includes('barbell curl') || message.includes('bicipiti bilanciere')) {
                return {
                    text: "Il Curl con Bilanciere per bicipiti:\n\n🎯 **Setup**:\n• Piedi larghezza spalle, bilanciere con presa supina\n• Braccia tese lungo i fianchi\n• Gomiti fissi ai fianchi\n\n🎯 **Esecuzione**:\n• Fletti i gomiti portando il bilanciere alle spalle\n• Contrai i bicipiti in alto\n• Abbassa controllatamente\n• Mantieni i gomiti immobili\n\n💡 **Varianti**:\n• **EZ Bar**: Riduce stress sui polsi\n• **Preacher Curl**: Per isolamento maggiore\n• **Hammer Curl**: Con manubri, presa neutra\n\n⚠️ **Errori comuni**:\n• Usare slancio\n• Muovere i gomiti\n• Non completare il movimento"
                };
            }
            
            if (message.includes('stacchi rumeni') || message.includes('romanian deadlift') || message.includes('stacco rumeno')) {
                return {
                    text: "Gli Stacchi Rumeni per hamstring e glutei:\n\n🎯 **Setup**:\n• Piedi larghezza spalle, bilanciere davanti\n• Presa prona, ginocchia leggermente piegate\n• Schiena neutra, petto in fuori\n\n🎯 **Esecuzione**:\n• Abbassa il bilanciere spingendo i glutei indietro\n• Mantieni le gambe quasi tese\n• Scendi fino a sentire tensione negli hamstring\n• Risali contraendo i glutei\n\n💡 **Benefici**:\n• Sviluppa catena posteriore\n• Migliora mobilità dell'anca\n• Complementa squat e stacchi\n\n⚠️ **Errori comuni**:\n• Arrotondare la schiena\n• Piegare troppo le ginocchia\n• Non controllare la discesa"
                };
            }
            
            if (message.includes('leg press') || message.includes('pressa gambe')) {
                return {
                    text: "Il Leg Press per quadricipiti e glutei:\n\n🎯 **Setup**:\n• Siediti con schiena appoggiata\n• Piedi larghezza spalle sulla pedana\n• Ginocchia a 90 gradi nella posizione iniziale\n\n🎯 **Esecuzione**:\n• Estendi le gambe senza bloccare le ginocchia\n• Abbassa controllatamente fino a 90 gradi\n• Mantieni i piedi piatti\n• Respira regolarmente\n\n💡 **Varianti**:\n• **Wide Stance**: Più glutei\n• **Narrow Stance**: Più quadricipiti\n• **Single Leg**: Per correzione asimmetrie\n\n⚠️ **Errori comuni**:\n• Rimuovere i glutei dal sedile\n• Non controllare la discesa\n• Piedi troppo in alto o basso"
                };
            }
            
            if (message.includes('leg extension') || message.includes('estensioni gambe')) {
                return {
                    text: "La Leg Extension per quadricipiti isolati:\n\n🎯 **Setup**:\n• Siediti con schiena appoggiata\n• Caviglie sotto i supporti\n• Ginocchia a 90 gradi\n\n🎯 **Esecuzione**:\n• Estendi le gambe completamente\n• Contrai i quadricipiti in alto\n• Abbassa controllatamente\n• Mantieni il controllo\n\n💡 **Consigli**:\n• Buon esercizio di isolamento\n• Da fare dopo esercizi composti\n• Non usare pesi troppo pesanti\n\n⚠️ **Errori comuni**:\n• Usare slancio\n• Non completare l'estensione\n• Muovere il busto"
                };
            }
            
            if (message.includes('leg curl') || message.includes('curl gambe')) {
                return {
                    text: "Il Leg Curl per hamstring isolati:\n\n🎯 **Setup**:\n• Sdraiati prono sulla macchina\n• Caviglie sotto i supporti\n• Anche rilassate\n\n🎯 **Esecuzione**:\n• Fletti le ginocchia portando i talloni ai glutei\n• Contrai gli hamstring\n• Estendi controllatamente\n• Mantieni il core contratto\n\n💡 **Varianti**:\n• **Seated**: Seduto per focus diverso\n• **Standing**: In piedi con cavo\n• **Single Leg**: Per correzione squilibri\n\n⚠️ **Errori comuni**:\n• Usare slancio\n• Non controllare l'estensione\n• Sollevare i glutei"
                };
            }
            
            if (message.includes('tapis roulant') || message.includes('treadmill') || message.includes('correre tapis')) {
                return {
                    text: "Il Tapis Roulant per cardio efficace:\n\n🎯 **Setup**:\n• Scegli velocità e inclinazione appropriate\n• Mantieni postura eretta\n• Guarda avanti, non giù\n\n🎯 **Esecuzione**:\n• Cammina/corri con ritmo costante\n• Usa le braccia per bilanciamento\n• Respira regolarmente\n• Monitora frequenza cardiaca\n\n💡 **Benefici**:\n• Migliora capacità cardiovascolare\n• Brucia calorie efficacemente\n• Adattabile a tutti i livelli\n\n⚠️ **Consigli di sicurezza**:\n• Inizia con riscaldamento\n• Non tenere i corrimano\n• Idratati regolarmente"
                };
            }
            
            if (message.includes('cyclette') || message.includes('stationary bike') || message.includes('bici stazionaria')) {
                return {
                    text: "La Cyclette per cardio a basso impatto:\n\n🎯 **Setup**:\n• Regola sella e manubrio\n• Scegli resistenza appropriata\n• Mantieni schiena dritta\n\n🎯 **Esecuzione**:\n• Pedala con ritmo costante\n• Mantieni core contratto\n• Respira regolarmente\n• Varia intensità se possibile\n\n💡 **Vantaggi**:\n• Basso impatto sulle articolazioni\n• Buono per riscaldamento\n• Facilita conversazione (se leggero)\n\n⚠️ **Errori comuni**:\n• Curvare la schiena\n• Usare resistenza troppo alta\n• Non scaldarsi prima"
                };
            }
            
            if (message.includes('ellittica') || message.includes('elliptical') || message.includes('ellittico')) {
                return {
                    text: "L'Ellittica per cardio completo:\n\n🎯 **Setup**:\n• Regola pedali e manubri\n• Scegli programma adatto\n• Mantieni postura eretta\n\n🎯 **Esecuzione**:\n• Muovi braccia e gambe simultaneamente\n• Mantieni ritmo costante\n• Respira regolarmente\n• Monitora resistenza e velocità\n\n💡 **Benefici**:\n• Movimento naturale\n• Coinvolge tutto il corpo\n• Basso impatto sulle articolazioni\n\n⚠️ **Consigli**:\n• Non aggrapparti ai manubri\n• Mantieni core attivo\n• Varia intensità per risultati migliori"
                };
            }
            
            // Additional muscle group suggestions
            if (message.includes('braccia') || message.includes('arms') || message.includes('bicipiti') || message.includes('tricipiti')) {
                const armResponses = [
                    "Per sviluppare le braccia, combina esercizi composti e di isolamento:\n\n💪 **Bicipiti**:\n• Curl con Bilanciere\n• Curl con Manubri\n• Hammer Curl\n• Trazioni (coinvolgono anche bicipiti)\n\n💪 **Tricipiti**:\n• Estensioni con Manubrio\n• Push-down al Cavo\n• Dips\n• French Press\n\n🔄 **Allenamento bilanciato**:\n• 2-3 esercizi per gruppo muscolare\n• 3-4 serie da 8-12 ripetizioni\n• Riposo 60-90 secondi tra serie\n\nRicorda: le braccia crescono con esercizi pesanti e buona alimentazione!",
                    "Ecco esercizi eccellenti per braccia potenti:\n\n🏋️ **Biceps**:\n• Barbell Curls\n• Dumbbell Curls\n• Concentration Curls\n• Chin-ups\n\n🏋️ **Triceps**:\n• Tricep Dips\n• Skull Crushers\n• Cable Pushdowns\n• Close-grip Bench\n\n💡 **Pro tip**: Finisci con esercizi di isolamento per la pump massima!",
                    "Per braccia da urlo:\n\n💥 **Bicipiti**:\n• EZ Bar Curls\n• Preacher Curls\n• Hammer Curls\n• 21s (metodo avanzato)\n\n💥 **Tricipiti**:\n• Overhead Extensions\n• Kickbacks\n• Rope Pushdowns\n• Diamond Push-ups\n\nCombina volume e intensità per risultati esplosivi!"
                ];
                return {
                    text: armResponses[Math.floor(Math.random() * armResponses.length)]
                };
            }
            
            if (message.includes('gambe') || message.includes('legs') || message.includes('quadricipiti') || message.includes('cosce') || message.includes('gambe inferiori')) {
                const legResponses = [
                    "🏆 **Sistema Gambe Olimpico - Protocollo da Powerlifter Elite:**\n\n\n🔬 **SCIENZA DELLE GAMBE:** Le gambe rappresentano il 50% della massa muscolare totale. Richiedono stimoli pesanti e volume elevato per ipertrofia massima.\n\n\n💪 **PROGRAMMAZIONE COMPETITION-READY - 4 Giorni/Settimana:**\n\n**GIORNO 1: SQUAT FOCUS (FORZA MASSIMALE)**\n• Squat 5x3 (85-90% 1RM) - King of exercises\n• Leg Press 4x10-12 - Accessory work\n• Walking Lunges 3x12/leg - Unilateral balance\n• Leg Extension 3x15 - Quad isolation\n\n**GIORNO 2: DEADLIFT SPECIALIZATION**\n• Romanian Deadlift 4x8-10 (75-80% 1RM) - Hamstring focus\n• Bulgarian Split Squat 4x10/leg - Single leg strength\n• Leg Curl 4x12-15 - Hamstring isolation\n• Calf Raises 4x15-20 - Posterior chain complete\n\n**GIORNO 3: VOLUME IPERTROFIA**\n• Front Squat 4x10-12 - Quad emphasis\n• Hack Squat 3x12-15 - Alternative angle\n• Glute Bridge 3x15 - Glute activation\n• Seated Calf Raise 3x20 - Calf burn\n\n**GIORNO 4: ACCESSORI AVANZATI**\n• Box Squat 4x8-10 - Explosive power\n• Nordic Hamstring Curl 3x8-12 - Eccentric strength\n• Sissy Squat 3x12-15 - Quad stretch\n• Farmer Walk 3x40m - Grip & core\n\n🔥 **NUTRIZIONE POWERLIFTING:**\n• 2.5-3.0g/kg proteina per sintesi muscolare\n• Surplus 500-700 kcal per crescita\n• Carb-loading 8-12g/kg pre-workout\n• Creatina 5g/die per forza esplosiva\n\n⚡ **SUPPLEMENTI ELITE:**\n• Beta-Alanine per endurance\n• Citrullina Malato per pomp\n• BCAAs intra-workout\n• ZMA per testosterone\n\n🎯 **TRACKING SCIENTIFICO:**\n• Misura circonferenza cosce ogni 4 settimane\n• Test forza (squat/deadlift) ogni 6-8 settimane\n• Body composition tracking\n• Performance metrics logging\n\n💡 **TECNICHE PRO:**\n• Pause squats (3 secondi in basso)\n• Deficit deadlifts per range aumentato\n• Accommodating resistance (bands/chains)\n• Westside Barbell conjugate method\n\n⚠️ **INFORTUNI PREVENZIONE:**\n• Mobility work pre/post\n• Corretta progressione carichi\n• Form check video settimanale\n• Deload ogni 6-8 settimane\n\n🚀 **RISULTATI ATTESI:** +5-10cm cosce in 12-16 settimane con consistenza!",
                    "🏋️‍♂️ **Protocollo Gambe Scientifico - Metodo Evidence-Based:**\n\n\n📊 **RICERCA MUSCOLARE:** Studi dimostrano che gambe allenate 2x/settimana con volume 15-25 set producono ipertrofia ottimale.\n\n\n🎯 **PROGRAMMA PERIODIZZATO:**\n\n**FASE 1: STRENGTH BUILDING (8 settimane)**\n• Squat: 4x6-8 @ 75-80% 1RM\n• Deadlift: 4x6-8 @ 70-75% 1RM\n• Leg Press: 3x10-12\n• Lunges: 3x10/leg\n\n**FASE 2: HYPERTROPHY FOCUS (6 settimane)**\n• Squat: 3x10-12 @ 65-70% 1RM\n• Romanian DL: 3x10-12\n• Bulgarian SS: 3x12/leg\n• Leg Curl: 3x12-15\n\n**FASE 3: STRENGTH PEAK (4 settimane)**\n• Squat: 5x3 @ 85% 1RM\n• Deadlift: 5x3 @ 80% 1RM\n• Front Squat: 4x6-8\n• Good Mornings: 4x8-10\n\n**FASE 4: DELoad & RECOVERY (2 settimane)**\n• Light Squat: 3x15 @ 50% 1RM\n• Mobility Work: 3x10\n• Core Work: 3x20\n• Active Recovery\n\n🔬 **BIOMECCANICA OTTIMALE:**\n• Squat: piedi 140% larghezza spalle\n• Deadlift: hinge da anche, non schiena\n• Lunges: ginocchio anteriore non oltre punta piede\n• Respirazione: brace durante movimento\n\n🛡️ **PROTOCOLLO SICUREZZA:**\n• Warm-up dinamico 10 minuti\n• Form check con coach/video\n• Progressione lineare 5-10% settimanale\n• Monitoraggio DOMS e fatigue\n\n💊 **RECUPERO STRATEGICO:**\n• Foam rolling gambe post-workout\n• Stretching statico 5-10 minuti\n• Ice bath 3x/settimana\n• Massaggio sportivo mensile\n\n📈 **METRICHE SUCCESSO:**\n• Squat 1RM +20-30kg/trimestre\n• Cosce +3-5cm circonferenza\n• Riduzione % grasso corporeo\n• Miglioramento endurance cardiovascolare\n\n🎖️ **MENTALITÀ CAMPIONE:**\n• Embrace the grind - gambe richiedono sacrificio\n• Track ogni sessione meticolosamente\n• Patience - risultati in 6-12 mesi\n• Celebrate PRs e progressi\n\n🏆 **GAMBE CHE SPOSTANO MONTAGNE!**",
                    "🌟 **Sistema Gambe Funzionale - Performance Athletica:**\n\n\n🔥 **FILOSOFIA ALLENAMENTO:** Gambe atletiche combinano forza, potenza, mobilità. Non solo estetica, ma performance reale.\n\n\n🏗️ **ARCHITETTURA PROGRAMMA:**\n\n**SESSIONE A: STRENGTH BASE**\n• Back Squat 5x5 @ 80% 1RM\n• Romanian Deadlift 4x8\n• Bulgarian Split Squat 4x10/leg\n• Calf Raises 3x15\n\n**SESSIONE B: POWER DEVELOPMENT**\n• Box Jumps 4x5 - Explosive power\n• Trap Bar Deadlift 4x6 - Alternative grip\n• Reverse Lunges 4x10/leg\n• Single Leg Calf Raise 3x12/leg\n\n**SESSIONE C: HYPERTROPHY VOLUME**\n• Front Squat 3x10-12\n• Lying Leg Curl 4x12-15\n• Walking Lunges 3x12/leg\n• Seated Calf Raise 4x20\n\n**SESSIONE D: SPEED & AGILITY**\n• Speed Squats 4x8 @ 60% 1RM\n• Kettlebell Swings 3x15\n• Hill Sprints 6x30s\n• Plyometric Lunges 3x8/leg\n\n⚡ **INTENSITÀ PROGRESSIVA:**\n• RPE 7-9 per crescita ottimale\n• Tempo sotto tensione 60-90 secondi\n• Tecniche avanzate: paused reps, eccentrics\n• Cluster sets per qualità\n\n🧬 **NUTRIZIONE PERFORMANCE:**\n• Timing pasti intorno allenamenti\n• Carb cycling per energia ottimale\n• Elettroliti per crampi prevenzione\n• Anti-infiammatori naturali\n\n🔧 **STRUMENTAZIONE:**\n• Force plates per power output\n• Video analisi biomeccanica\n• Wearable tech per recovery tracking\n• Strength testing periodico\n\n🛡️ **RISK MANAGEMENT:**\n• Pre-hab protocolli\n• Injury prevention screening\n• Load monitoring\n• Psychological readiness assessment\n\n🎯 **OBIETTIVI QUANTIFICABILI:**\n• Vertical jump +5-10cm\n• Sprint time miglioramento\n• Strength gains 15-25%\n• Injury-free training\n\n💎 **PSICOLOGIA ELITE:**\n• Mental toughness development\n• Visualization success\n• Peer accountability\n• Long-term vision\n\n🏅 **GAMBE CHE VINCONO COMPETIZIONI!**",
                    "🏋️‍♀️ **Gambe Femminili Armoniose - Forza & Bellezza:**\n\n\n💖 **APPROCCIO OLISTICO:** Per le donne, gambe toniche significano sicurezza e salute. Bilanciamento tra forza e forma femminile.\n\n\n🌸 **PROGRAMMA 3 GIORNI/SETTIMANA:**\n\n**GIORNO LOWER BODY A**\n• Goblet Squat 3x12-15\n• Romanian Deadlift 3x10-12\n• Bulgarian Split Squat 3x10/leg\n• Calf Raises 3x15-20\n\n**GIORNO LOWER BODY B**\n• Leg Press 3x12-15\n• Walking Lunges 3x12/leg\n• Leg Curl 3x12-15\n• Glute Bridge 3x15-20\n\n**GIORNO FULL BODY**\n• Front Squat 3x10-12\n• Deadlift Light 3x8-10\n• Step-ups 3x10/leg\n• Plank 3x30-60s\n\n🎨 **ESTETICA & FORMA:**\n• Focus su proporzioni armoniche\n• Glute activation per forma\n• Cellulite reduction attraverso movimento\n• Postura migliorata\n\n🌿 **RECUPERO DELICATO:**\n• Yoga per gambe\n• Stretching profondo\n• Massaggi drenanti\n• Alimentazione detox\n\n✨ **RISULTATI DONNA MODERNA:**\n• Gambe toniche e definite\n• Maggiore energia quotidiana\n• Miglior mobilità articolare\n• Fiducia aumentata\n\n👑 **POTENZIA LA TUA FORZA INTERIORE!**",
                    "🔬 **Ricerca Gambe 2025 - Protocollo Evidence-Based:**\n\n\n📚 **STUDI RIVOLUZIONARI:**\n• Meta-analysis: compound movements superiori per hypertrophy\n• EMG studies: squat attiva 80% quadricipiti\n• Longitudinal research: strength gains 0.5-1%/week optimal\n\n\n⚗️ **PROTOCOLLO SPERIMENTALE:**\n\n**WEEK 1-4: FOUNDATION**\n• Squat 3x12 @ 60% 1RM\n• Deadlift 3x10 @ 60% 1RM\n• Leg Press 3x15\n• Lunges 3x12/leg\n\n**WEEK 5-8: BUILDING**\n• Squat 4x10 @ 65% 1RM\n• Romanian DL 4x10\n• Bulgarian SS 4x10/leg\n• Leg Curl 3x12\n\n**WEEK 9-12: INTENSIFICATION**\n• Squat 4x8 @ 70% 1RM\n• Deadlift 4x8 @ 70% 1RM\n• Front Squat 3x10\n• Good Mornings 3x10\n\n**WEEK 13-16: PEAK**\n• Squat 5x5 @ 75% 1RM\n• Deadlift 5x5 @ 75% 1RM\n• Box Squat 4x8\n• Nordic Curl 3x8\n\n📊 **TRACKING SCIENTIFICO:**\n• Anthropometric measurements\n• Strength testing periodico\n• Body composition DEXA scans\n• Performance metrics\n\n🧪 **VARIABILI CONTROLLATE:**\n• Caloric intake standardized\n• Sleep duration monitored\n• Training frequency controlled\n• Recovery protocols uniform\n\n🎯 **CONCLUSIONI:**\n• Progressive overload essenziale\n• Compound lifts fondamentali\n• Recovery non negoziabile\n• Consistency vince sempre\n\n🔬 **SCIENCE DRIVES RESULTS!**"
                ];
                return {
                    text: legResponses[Math.floor(Math.random() * legResponses.length)]
                };
            }
            
            if (message.includes('spalle') || message.includes('shoulders') || message.includes('deltoidi') || message.includes('spalle larghe')) {
                const shoulderResponses = [
                    "🏆 **Protocollo Spalle Elite - Sistema 3D per Deltoidi Perfetti:**\n\n\n🔬 **ANATOMIA DELTOIDI:** I deltoidi hanno 3 teste (anteriore, laterale, posteriore) che richiedono stimoli specifici per crescita equilibrata.\n\n\n💪 **PROGRAMMAZIONE SCIENTIFICA - 4 Giorni/Settimana:**\n\n**GIORNO 1: ANTERIORE & LATERALE (PUSH)**\n• Military Press 4x8-10 (75-80% 1RM) - King of shoulders\n• Alzate Laterali Manubri 4x12-15 - Laterale focus\n• Alzate Frontali Manubri 3x12-15 - Anteriore isolation\n• Rear Delt Flyes 3x15 - Posteriore balance\n\n**GIORNO 2: POSTERIORE & STABILITÀ**\n• Alzate Laterali Incline 4x12-15 - Laterale angle variation\n• Face Pulls 4x15-20 - Posteriore & cuff\n• Rear Delt Machine 3x12-15 - Isolation posteriore\n• Lateral Raises Cable 3x15 - Constant tension\n\n**GIORNO 3: FORZA MASSIMALE**\n• Military Press 5x5 (80-85% 1RM) - Strength focus\n• Arnold Press 4x8-10 - Full range motion\n• Upright Rows 3x10-12 - Traps integration\n• Shrugs 4x12-15 - Upper traps\n\n**GIORNO 4: IPERTROFIA AVANZATA**\n• Lateral Raises Drop Set 3x12-8 - Burn technique\n• Front Raises Cable 3x15 - Anteriore burn\n• Bent Over Raises 3x15 - Posteriore burn\n• Shoulder Press Machine 3x12-15 - Controlled movement\n\n🔥 **PROTOCOLLO NUTRIZIONALE SPALLE:**\n• Proteina alta: 2.0-2.2g/kg peso corporeo\n• Carb-loading pre-workout per energia\n• Omega-3 per salute articolare\n• Vitamina D per forza ossea\n\n⚡ **SUPPLEMENTI SPECIALIZZATI:**\n• Glutammina per recupero articolare\n• Condroitina per cartilagine\n• Magnesio per funzione muscolare\n• Curcuma per riduzione infiammazione\n\n🎯 **TRACKING PROGRESSI:**\n• Misura circonferenza spalle ogni mese\n• Foto progress da lati diversi\n• Test mobilità spalla regolare\n• Monitoraggio dolore o disagio\n\n💡 **TECNICHE PRO:**\n• Usa pause isometriche in posizioni contratte\n• Varia velocità esecuzione (3-1-3 tempo)\n• Incorpora pre-esaurimento\n• Focus mentale sulla contrazione\n\n⚠️ **PREVENZIONE INFORTUNI:**\n• Riscaldamento con arm circles\n• Rotator cuff activation\n• Evita lockout completo se instabile\n• Monitora impingement signs\n\n🚀 **RISULTATI ATTESI:** Spalle più larghe del 15-25% in 12 settimane con costanza!",
                    "🏋️‍♂️ **Sistema Spalle Olimpico - Deltoidi da Statua Greca:**\n\n\n📊 **FISIOLOGIA AVANZATA:** Le spalle richiedono attenzione particolare alla cuffia rotatoria. Bilanciamento tra push/pull essenziale.\n\n\n🎯 **PROGRAMMA PERIODIZZATO:**\n\n**FASE 1: COSTRUZIONE BASE (6 settimane)**\n• Military Press: 4x10-12 @ 65-70% 1RM\n• Lateral Raises: 4x12-15\n• Face Pulls: 3x15-20\n• Front Raises: 3x12-15\n\n**FASE 2: SVILUPPO FORZA (4 settimane)**\n• Military Press: 5x5 @ 75-80% 1RM\n• Arnold Press: 4x8-10\n• Upright Rows: 4x8-10\n• Shrugs: 4x10-12\n\n**FASE 3: DEFINIZIONE (4 settimane)**\n• Lateral Raises: 4x15-20\n• Rear Delt Flyes: 4x15-20\n• Cable Raises: 3x20\n• Dumbbell Press: 3x12-15\n\n🔬 **BIOMECCANICA PRECISIONE:**\n• Scapole retratte durante press\n• Controllo eccentrico enfatizzato\n• Range motion completo ma sicuro\n• Respirazione coordinata\n\n🛡️ **PROTOCOLLO SICUREZZA:**\n• Assessment mobilità pre-sessione\n• Attivazione cuffia rotatoria\n• Correzione posture disallineate\n• Monitoraggio DOMS\n\n💊 **RECUPERO INTELLIGENTE:**\n• Foam rolling spalle e upper back\n• Stretching dinamico e statico\n• Ice bath per riduzione infiammazione\n• Massaggio sportivo settimanale\n\n📈 **METRICHE SUCCESSO:**\n• Aumento forza 5-8% ogni mese\n• Miglioramento mobilità articolare\n• Riduzione asimmetrie\n• Aumento circonferenza spalle\n\n🎖️ **MENTALITÀ VINCENTE:**\n• Visualizzazione crescita muscolare\n• Pazienza con progressione graduale\n• Focus qualità esecuzione\n• Celebrazione miglioramenti\n\n🏆 **SPALLE LEGGENDARIE IN ARRIVO!**",
                    "🌟 **Protocollo Spalle Funzionale - Performance & Estetica:**\n\n\n🔥 **FILOSOFIA ALLENAMENTO:** Spalle forti = corpo impressionante. Combiniamo estetica con funzionalità atletica.\n\n\n🏗️ **ARCHITETTURA PROGRAMMA:**\n\n**SESSIONE A: PRESS PRIORITY**\n• Military Press 5x3 @ 80-85% 1RM\n• Arnold Press 4x8-10\n• Lateral Raises 4x10-12\n• Face Pulls 3x15-20\n\n**SESSIONE B: RAISE SPECIALIZATION**\n• Lateral Raises Cable 4x12-15\n• Front Raises Cable 4x12-15\n• Rear Delt Machine 4x12-15\n• Shrugs Dumbbell 3x15\n\n**SESSIONE C: FULL SPECTRUM**\n• Shoulder Press Machine 3x12-15\n• Dumbbell Raises Mix 3x10-12\n• Upright Rows 3x10-12\n• Rotator Cuff Work 3x15\n\n⚡ **INTENSITÀ PROGRESSIVA:**\n• RPE 7-9 per crescita ottimale\n• Tempo sotto tensione 45-60 secondi\n• Tecniche avanzate: rest-pause, dropsets\n• Supersets per densità aumentata\n\n🧬 **NUTRIZIONE PRECISIONE:**\n• Finestra anabolica post-workout\n• Macro balance ottimale\n• Timing pasti strategico\n• Idratazione articolare\n\n🔧 **STRUMENTAZIONE:**\n• Video analisi tecnica\n• EMG feedback attivazione\n• Tracking forza progressione\n• Monitoraggio mobilità\n\n🛡️ **RISK MANAGEMENT:**\n• Pre-hab esercizi preventivi\n• Correzione disfunzioni\n• Monitoraggio overtraining\n• Protocollo recupero\n\n🎯 **OBIETTIVI MISURABILI:**\n• Guadagno forza 10-15%/ciclo\n• Aumento dimensione 1-2cm/mese\n• Miglioramento stabilità\n• Riduzione infortuni\n\n💎 **PSICOLOGIA PEAK:**\n• Mental rehearsal\n• Goal setting specifico\n• Accountability\n• Success celebration\n\n🏅 **SPALLE CHE COMANDANO RISPETTO!**",
                    "🏋️‍♀️ **Spalle Femminili Armoniose - Forza & Grazia:**\n\n\n💖 **APPROCCIO BILANCIATO:** Per le donne, le spalle devono essere toniche ma proporzionate. Forza funzionale con estetica.\n\n\n🌸 **PROGRAMMA 3 GIORNI:**\n\n**GIORNO PUSH**\n• Shoulder Press Dumbbell 3x10-12\n• Lateral Raises 3x12-15\n• Front Raises 3x12-15\n• Tricep Extensions 3x12-15\n\n**GIORNO PULL**\n• Face Pulls 3x15-20\n• Rear Delt Flyes 3x12-15\n• Rows 3x10-12\n• Bicep Curls 3x12-15\n\n**GIORNO FULL BODY**\n• Squat Variations 3x10-12\n• Deadlift Light 3x8-10\n• Plank Variations 3x30-60s\n• Cardio HIIT 20 min\n\n🎨 **ESTETICA & FORMA:**\n• Focus su proporzioni armoniose\n• Esercizi controllo posturali\n• Combinazione mobilità\n• Attenzione alla simmetria\n\n🌿 **RECUPERO GENTILE:**\n• Yoga per spalle\n• Stretching delicato\n• Alimentazione anti-infiammatoria\n• Sonno ristoratore\n\n✨ **RISULTATI:**\n• Spalle definite e toniche\n• Postura migliorata\n• Energia aumentata\n• Sicurezza personale\n\n👑 **ILLUMINA IL TUO POTENZIALE!**",
                    "🔬 **Ricerca Spalle 2025 - Protocollo Evidence-Based:**\n\n\n📚 **STUDI RIVOLUZIONARI:**\n• Meta-analisi: attivazione ottimale con esercizi multi-angolo\n• EMG research: lateral raises attivano 90% deltoidi laterali\n• Longitudinal studies: progressione 0.3-0.6% forza/settimana\n\n\n⚗️ **PROTOCOLLO SPERIMENTALE:**\n\n**WEEK 1-4: ADAPTATION**\n• Military Press 3x12 @ 60% 1RM\n• Lateral Raises 3x15\n• Face Pulls 3x20\n• Front Raises 3x15\n\n**WEEK 5-8: PROGRESSION**\n• Military Press 4x10 @ 65% 1RM\n• Lateral Raises 4x12\n• Face Pulls 4x15\n• Arnold Press 3x10\n\n**WEEK 9-12: INTENSIFICATION**\n• Military Press 4x8 @ 70% 1RM\n• Lateral Raises 4x10\n• Face Pulls 4x12\n• Upright Rows 3x10\n\n**WEEK 13-16: PEAK**\n• Military Press 5x5 @ 75% 1RM\n• Lateral Raises 4x8\n• Face Pulls 4x10\n• Shrugs 4x10\n\n📊 **TRACKING SCIENTIFICO:**\n• Antropometriche measurements\n• Strength testing periodico\n• Body composition analysis\n• Quality of life questionnaires\n\n🧪 **CONTROLLED VARIABLES:**\n• Standardized nutrition\n• Sleep monitoring\n• Stress assessment\n• Recovery quantification\n\n🎯 **CONCLUSIONS:**\n• Linear progression effective\n• Multi-angle exercises optimal\n• Recovery critical for results\n• Consistency key to success\n\n🔬 **SCIENCE WORKS!**"
                ];
                return {
                    text: shoulderResponses[Math.floor(Math.random() * shoulderResponses.length)]
                };
            }
            
            if (message.includes('addominali') || message.includes('abs') || message.includes('core') || message.includes('addome')) {
                const absResponses = [
                    "🏆 **Sistema Addominali Elite - Protocollo da Fitness Model Professionista:**\n\n\n🔬 **SCIENZA DEL CORE:** Gli addominali sono composti da 4 strati muscolari che richiedono stimoli specifici per definizione completa. Il 70% del risultato dipende dalla dieta.\n\n\n💪 **PROGRAMMAZIONE COMPETITION-READY - 4 Giorni/Settimana:**\n\n**GIORNO 1: UPPER ABS & OBLIQUES**\n• Crunch 4x15-20 - Base di tutto\n• Russian Twist 4x20/side - Obliques focus\n• Bicycle Crunch 3x20/side - Rotazione dinamica\n• Plank 3x60s - Core stability\n\n**GIORNO 2: LOWER ABS & DEEP CORE**\n• Hanging Leg Raises 4x10-15 - Lower abs king\n• Flutter Kicks 3x30s - Endurance lower\n• Reverse Crunch 3x15-20 - Isolation lower\n• Dead Bug 3x12/side - Deep core activation\n\n**GIORNO 3: FUNCTIONAL CORE & STABILITY**\n• Pallof Press 4x10/side - Anti-rotational strength\n• Woodchoppers 3x12/side - Obliques power\n• Side Plank 3x45s/side - Lateral stability\n• Bird Dog 3x12/side - Coordination\n\n**GIORNO 4: HIGH-INTENSITY CORE**\n• Ab Wheel Rollout 4x8-12 - Full core challenge\n• Dragon Flags 3x8-12 - Advanced strength\n• V-ups 3x12-15 - Power movement\n• Mountain Climbers 3x30s - Cardio core\n\n🔥 **NUTRIZIONE PRECISIONE:**\n• Deficit calorico 300-500 kcal per definizione\n• Proteina 1.6-2.0g/kg per preservare massa\n• Carb cycling: high/low days\n• Timing pasti strategico\n\n⚡ **SUPPLEMENTI SPECIALIZZATI:**\n• BCAAs per preservare massa muscolare\n• Termogenici naturali per grasso\n• Fibre per sazietà\n• Elettroliti per performance\n\n🎯 **TRACKING PROGRESSI:**\n• Misura circonferenza vita ogni settimana\n• Foto progress giornaliere\n• Test endurance plank mensile\n• Monitoraggio % grasso corporeo\n\n💡 **TECNICHE PRO:**\n• Slow eccentrics per time under tension\n• Peak contraction holds\n• Breath control (bracing)\n• Mind-muscle connection\n\n⚠️ **GESTIONE RECUPERO:**\n• Core non si allena daily per evitare overtraining\n• 48-72 ore recupero tra sessioni\n• Monitora DOMS e fatigue\n• Integra mobilità work\n\n🚀 **RISULTATI ATTESI:** Addominali visibili in 8-12 settimane con costanza!",
                    "🏋️‍♂️ **Protocollo Addominali Scientifico - Metodo Evidence-Based:**\n\n\n📊 **RICERCA MUSCOLARE:** Studi dimostrano che esercizi isometrici + dinamici producono 60% più attivazione rispetto a crunch soli.\n\n\n🎯 **PROGRAMMA PERIODIZZATO:**\n\n**FASE 1: FOUNDATION BUILDING (4 settimane)**\n• Plank: 3x30-45s\n• Crunch: 3x15-20\n• Russian Twist: 3x20/side\n• Leg Raises: 3x12-15\n\n**FASE 2: STRENGTH DEVELOPMENT (4 settimane)**\n• Hanging Leg Raises: 4x10-12\n• Ab Wheel: 4x8-10\n• Pallof Press: 3x12/side\n• Side Plank: 3x30-45s/side\n\n**FASE 3: HYPERTROPHY FOCUS (4 settimane)**\n• Weighted Crunch: 4x12-15\n• Dragon Flags: 3x8-12\n• Woodchoppers: 3x15/side\n• V-ups: 3x10-15\n\n**FASE 4: DEFINITION PEAK (4 settimane)**\n• Circuit Training: 4 rounds\n• High-intensity intervals\n• Endurance focus\n• Diet optimization\n\n🔬 **BIOMECCANICA OTTIMALE:**\n• Neutral spine maintenance\n• Proper bracing technique\n• Controlled movement patterns\n• Breathing coordination\n\n🛡️ **PROTOCOLLO SICUREZZA:**\n• Warm-up dinamico 5 minuti\n• Form check costante\n• Progressione graduale\n• Pain monitoring\n\n💊 **RECUPERO INTELLIGENTE:**\n• Active recovery days\n• Mobility work\n• Nutrition timing\n• Sleep optimization\n\n📈 **METRICHE SUCCESSO:**\n• Plank time +50% miglioramento\n• Waist circumference riduzione\n• Strength endurance aumentata\n• Body fat % diminuzione\n\n🎖️ **MENTALITÀ VINCENTE:**\n• Consistency over intensity\n• Diet 80% of results\n• Patience with process\n• Celebrate small wins\n\n🏆 **CORE CHE SOSTIENE IL MONDO!**",
                    "🌟 **Sistema Addominali Funzionale - Performance Athletica:**\n\n\n🔥 **FILOSOFIA ALLENAMENTO:** Core forte = atleta superiore. Funzionalità oltre estetica.\n\n\n🏗️ **ARCHITETTURA PROGRAMMA:**\n\n**SESSIONE A: ANTI-EXTENSION**\n• Plank Variations 4x45s - Base stability\n• Ab Wheel Rollout 4x8-12 - Strength challenge\n• Dead Bug 3x12/side - Coordination\n• Superman 3x15 - Back extension balance\n\n**SESSIONE B: ANTI-ROTATION**\n• Pallof Press 4x10/side - Anti-rotational strength\n• Russian Twist 3x20/side - Rotational power\n• Woodchoppers 3x12/side - Functional movement\n• Side Plank with Reach 3x12/side\n\n**SESSIONE C: ANTI-LATERAL FLEXION**\n• Side Plank 4x30-45s/side - Lateral stability\n• Heel Touches 3x20/side - Oblique endurance\n• Copenhagen Plank 3x20s/side - Advanced stability\n• Windshield Wipers 3x10/side\n\n**SESSIONE D: HIGH-INTENSITY CIRCUIT**\n• Mountain Climbers 4x30s - Cardio core\n• Bicycle Crunches 3x20/side - Dynamic work\n• Flutter Kicks 3x45s - Endurance\n• Burpee with Jump 3x10\n\n⚡ **INTENSITÀ PROGRESSIVA:**\n• RPE 7-9 per crescita ottimale\n• Tempo sotto tensione 30-60 secondi\n• Tecniche avanzate: pauses, eccentrics\n• Circuit training per densità\n\n🧬 **NUTRIZIONE PERFORMANCE:**\n• Peri-workout carbohydrate timing\n• Protein distribution\n• Micronutrient optimization\n• Hydration strategy\n\n🔧 **STRUMENTAZIONE:**\n• Core stability testing\n• EMG biofeedback\n• Video analysis\n• Recovery monitoring\n\n🛡️ **RISK MANAGEMENT:**\n• Pre-hab exercises\n• Load progression\n• Injury prevention\n• Overtraining monitoring\n\n🎯 **OBIETTIVI MISURABILI:**\n• Stability test improvements\n• Strength gains 15-25%\n• Endurance increases\n• Injury reduction\n\n💎 **PSICOLOGIA PEAK:**\n• Mental resilience training\n• Performance visualization\n• Goal setting systems\n• Success metrics\n\n🏅 **CORE CHE SUPERA LIMITI!**",
                    "🏋️‍♀️ **Addominali Femminili Armoniosi - Forza & Forma Elegante:**\n\n\n💖 **APPROCCIO OLISTICO:** Per le donne, addominali tonici significano salute e fiducia. Equilibrio tra forza e femminilità.\n\n\n🌸 **PROGRAMMA 3 GIORNI/SETTIMANA:**\n\n**GIORNO CORE A**\n• Plank 3x30-45s\n• Bicycle Crunch 3x15/side\n• Leg Raises 3x12-15\n• Russian Twist 3x20/side\n\n**GIORNO CORE B**\n• Side Plank 3x20-30s/side\n• Reverse Crunch 3x15\n• Flutter Kicks 3x30s\n• Dead Bug 3x10/side\n\n**GIORNO FULL BODY**\n• Mountain Climbers 3x30s\n• Pallof Press 3x10/side\n• Bird Dog 3x12/side\n• Woodchoppers Light 3x12/side\n\n🎨 **ESTETICA & FORMA:**\n• Focus su hourglass figure\n• Waist-to-hip ratio ottimale\n• Postura elegante\n• Core strength funzionale\n\n🌿 **RECUPERO DELICATO:**\n• Yoga per core\n• Stretching profondo\n• Gentle massage\n• Restorative sleep\n\n✨ **RISULTATI:**\n• Addominali tonici visibili\n• Miglior posture\n• Increased energy\n• Enhanced confidence\n\n👑 **POTENZIA LA TUA BELLEZZA INTERIORE!**",
                    "🔬 **Ricerca Addominali 2025 - Protocollo Evidence-Based:**\n\n\n📚 **STUDI RIVOLUZIONARI:**\n• Meta-analysis: planks superiori per endurance\n• EMG studies: leg raises attivano 90% lower abs\n• Longitudinal research: visible abs require 10-15% body fat\n\n\n⚗️ **PROTOCOLLO SPERIMENTALE:**\n\n**WEEK 1-4: ADAPTATION**\n• Plank 3x30s\n• Crunch 3x15\n• Russian Twist 3x20/side\n• Leg Raises 3x12\n\n**WEEK 5-8: PROGRESSION**\n• Plank 4x45s\n• Bicycle Crunch 4x15/side\n• Hanging Leg Raises 3x10\n• Pallof Press 3x12/side\n\n**WEEK 9-12: INTENSIFICATION**\n• Ab Wheel 4x8\n• Dragon Flags 3x8\n• Weighted Crunches 3x12\n• Side Plank 3x30s/side\n\n**WEEK 13-16: PEAK**\n• Circuit Training 4x4 min\n• High-intensity core work\n• Endurance focus\n• Diet optimization\n\n📊 **TRACKING SCIENTIFICO:**\n• Waist circumference\n• Plank time tests\n• Body composition\n• Strength measurements\n\n🧪 **CONTROLLED VARIABLES:**\n• Caloric intake\n• Training frequency\n• Recovery protocols\n• Sleep duration\n\n🎯 **CONCLUSIONS:**\n• Progressive overload works\n• Diet critical for visibility\n• Recovery essential\n• Consistency key\n\n🔬 **SCIENCE REVEALS ABS!**"
                ];
                return {
                    text: absResponses[Math.floor(Math.random() * absResponses.length)]
                };
            }
            
            // Home workout Schede with variety
            if (message.includes('casa') || message.includes('home') || message.includes('domicilio') || message.includes('senza attrezzi')) {
                const homeSchede = [
                    {
                        text: "Ecco una scheda efficace per allenarti a casa senza attrezzi:",
                        template: {
                            id: 'ai_home_' + Date.now(),
                            name: '🏠 Allenamento Casa Base',
                            exercises: [
                                { name: 'Push-up', sets: 3, reps: 15, weight: 0 },
                                { name: 'Squat a Corpo Libero', sets: 3, reps: 20, weight: 0 },
                                { name: 'Plank', sets: 3, reps: 60, weight: 0 },
                                { name: 'Burpees', sets: 3, reps: 10, weight: 0 },
                                { name: 'Mountain Climbers', sets: 3, reps: 30, weight: 0 },
                                { name: 'Jumping Jacks', sets: 3, reps: 30, weight: 0 }
                            ]
                        }
                    },
                    {
                        text: "Allenamento casalingo con focus su forza e resistenza:",
                        template: {
                            id: 'ai_home_' + Date.now(),
                            name: '🏠 Forza & Resistenza',
                            exercises: [
                                { name: 'Diamond Push-ups', sets: 4, reps: 12, weight: 0 },
                                { name: 'Bodyweight Squats', sets: 4, reps: 15, weight: 0 },
                                { name: 'Superman Holds', sets: 3, reps: 30, weight: 0 },
                                { name: 'Lunges', sets: 3, reps: 10, weight: 0 },
                                { name: 'Plank', sets: 3, reps: 45, weight: 0 },
                                { name: 'Burpees', sets: 3, reps: 8, weight: 0 }
                            ]
                        }
                    },
                    {
                        text: "Scheda HIIT per casa - alta intensità, risultati rapidi:",
                        template: {
                            id: 'ai_home_' + Date.now(),
                            name: '🏠 HIIT Explosion',
                            exercises: [
                                { name: 'Push-ups', sets: 4, reps: 20, weight: 0 },
                                { name: 'Jump Squats', sets: 4, reps: 15, weight: 0 },
                                { name: 'Mountain Climbers', sets: 4, reps: 40, weight: 0 },
                                { name: 'Burpees', sets: 4, reps: 12, weight: 0 },
                                { name: 'High Knees', sets: 4, reps: 30, weight: 0 },
                                { name: 'Plank Jacks', sets: 4, reps: 20, weight: 0 }
                            ]
                        }
                    }
                ];
                return homeTemplates[Math.floor(Math.random() * homeTemplates.length)];
            }
            
            // General advice responses
            if (message.includes('dieta') || message.includes('alimentazione') || message.includes('mangiare') || message.includes('nutrizione')) {
                const dietResponses = [
                    "L'alimentazione è fondamentale! Ecco i principi base:\n\n🥗 **Per la massa muscolare**:\n• Surplus calorico di 300-500 kcal\n• 1.6-2.2g di proteine per kg di peso\n• Carboidrati intorno agli allenamenti\n\n🔥 **Per la definizione**:\n• Deficit calorico di 300-500 kcal\n• Mantieni alte le proteine (2-2.5g/kg)\n• Riduci gradualmente carboidrati e grassi\n\n💡 **Consigli generali**:\n• Bevi almeno 2-3L di acqua al giorno\n• Mangia ogni 3-4 ore\n• Priorità a cibi integrali e non processati",
                    "Alimentazione per risultati ottimali:\n\n🏋️ **Bulk**:\n• 2500-3000 kcal giornaliere\n• Proteine: 2g/kg\n• Carboidrati: 4-5g/kg\n• Grassi: 1g/kg\n\n🔥 **Cut**:\n• 1800-2200 kcal giornaliere\n• Proteine: 2.2g/kg\n• Carboidrati: 2-3g/kg\n• Grassi: 0.8g/kg\n\n🍎 **Cibi consigliati**:\n• Pollo, tacchino, pesce\n• Riso, patate dolci, avena\n• Uova, latte, yogurt greco\n• Frutta, verdura, noci",
                    "Guida alimentare per bodybuilding:\n\n🥩 **Proteine**:\n• Carne magra, pesce, uova\n• Latticini, legumi, tofu\n• Proteine in polvere (whey/casein)\n\n🍚 **Carboidrati**:\n• Cereali integrali\n• Frutta e verdura\n• Tuberi (patate, riso)\n\n🥑 **Grassi**:\n• Avocado, noci, semi\n• Olio d'oliva, pesce grasso\n• Burro di arachidi\n\nRicorda: 80% dieta, 20% allenamento!"
                ];
                return {
                    text: dietResponses[Math.floor(Math.random() * dietResponses.length)]
                };
            }
            
            if (message.includes('recupero') || message.includes('riposo') || message.includes('recovery') || message.includes('stanchezza')) {
                const recoveryResponses = [
                    "Il recupero è quando cresci davvero! 💪\n\n😴 **Sonno**:\n• 7-9 ore per notte\n• Qualità del sonno > quantità\n• Routine serale costante\n\n⏰ **Riposo tra allenamenti**:\n• 48-72h per lo stesso gruppo muscolare\n• Giorni di riposo attivo (camminata, yoga)\n• Ascolta il tuo corpo\n\n🧘 **Gestione dello stress**:\n• Meditazione o tecniche di rilassamento\n• Hobby e attività piacevoli\n• Evita sovrallenamento\n\nRicorda: i muscoli crescono durante il riposo, non durante l'allenamento!",
                    "Recupero intelligente per risultati massimi:\n\n💤 **Sonno profondo**:\n• Orario fisso ogni notte\n• Stanza buia e fresca\n• Niente schermi 1h prima\n\n🛀 **Recupero attivo**:\n• Camminate leggere\n• Stretching e mobilità\n• Massaggi e foam rolling\n\n🍽️ **Nutrizione**:\n• Proteine post-allenamento\n• Carboidrati per ricaricare glicogeno\n• Anti-infiammatori naturali\n\nSegni di sovrallenamento: fatica cronica, dolori articolari, calo prestazioni!",
                    "Strategie di recupero avanzate:\n\n🔄 **Active Recovery**:\n• Allenamenti leggeri\n• Nuoto o bici facile\n• Yoga e pilates\n\n🧊 **Terapie**:\n• Bagni ghiacciati\n• Sauna infrarossi\n• Massaggi sportivi\n\n📊 **Monitoraggio**:\n• Frequenza cardiaca a riposo\n• Peso corporeo\n• Livelli di energia\n\nIl recupero ottimale = progressi costanti!"
                ];
                return {
                    text: recoveryResponses[Math.floor(Math.random() * recoveryResponses.length)]
                };
            }
            
            // Default responses
            const defaultResponses = [
                "Interessante domanda! Potresti essere più specifico? Sono qui per aiutarti con allenamenti, esercizi, tecnica e consigli fitness.",
                "Sono specializzato in fitness e allenamento. Puoi chiedermi di creare schede, suggerire esercizi o dare consigli sulla tecnica!",
                "Non sono sicuro di aver capito. Prova a chiedermi qualcosa come 'Crea una scheda per i pettorali' o 'Come migliorare lo squat'.",
                "Sono qui per aiutarti con tutto ciò che riguarda il fitness! Chiedi pure di schede, esercizi, tecnica o consigli nutrizionali."
            ];
            
            return {
                text: defaultResponses[Math.floor(Math.random() * defaultResponses.length)]
            };
        }

        function useAITemplate(templateId) {
            // Find the template in the AI messages
            const messages = document.querySelectorAll('.ai-template-preview');
            let templateData = null;
            
            messages.forEach(preview => {
                const button = preview.querySelector('.ai-use-template-btn');
                if (button && button.getAttribute('onclick').includes(templateId)) {
                    const name = preview.querySelector('h4').textContent.replace('🏋️ ', '');
                    const exercises = [];
                    
                    preview.querySelectorAll('.ai-template-exercises li').forEach(li => {
                        const text = li.textContent;
                        const parts = text.split(' - ');
                        const name = parts[0];
                        const details = parts[1];
                        
                        // Parse "3 serie × 10 reps @ 50kg"
                        const match = details.match(/(\d+) serie × (\d+) reps @ (\d+(?:\.\d+)?)kg/);
                        if (match) {
                            exercises.push({
                                name: name,
                                sets: parseInt(match[1]),
                                reps: parseInt(match[2]),
                                weight: parseFloat(match[3])
                            });
                        }
                    });
                    
                    templateData = { name, exercises };
                }
            });
            
            if (templateData) {
                // Add to custom Schede
                const newId = 'ai_Scheda_' + Date.now();
                customSchede[newId] = templateData;
                saveSchede();
                
                // Update UI
                renderSchedaButtons();
                renderSchedaEditors();
                
                // Switch to workout page and load the Scheda
                showPage('workout');
                loadScheda(newId);
                
                // Show success message
                addAIMessage(`✅ Scheda "${templateData.name}" aggiunto con successo! L'ho caricato nella tua pagina workout.`, 'assistant');
            }
        }

        // AUTOCOMPLETAMENTO
        function setupAutocomplete() {
            const exerciseInput = document.getElementById('exerciseNameInput');
            const SchedaInput = document.getElementById('SchedaExerciseNameInput');
            const exerciseSuggestions = document.getElementById('exerciseSuggestions');
            const Schedeuggestions = document.getElementById('SchedaExerciseSuggestions');

            setupInputAutocomplete(exerciseInput, exerciseSuggestions);
            setupInputAutocomplete(SchedaInput, Schedeuggestions);
        }

        function setupInputAutocomplete(input, suggestionsContainer) {
            input.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                if (query.length === 0) {
                    hideSuggestions(suggestionsContainer);
                    return;
                }

                const suggestions = getExerciseSuggestions(query);
                showSuggestions(suggestions, suggestionsContainer, input);
            });

            input.addEventListener('keydown', function(e) {
                handleKeyNavigation(e, suggestionsContainer, input);
            });

            input.addEventListener('blur', function() {
                setTimeout(() => hideSuggestions(suggestionsContainer), 150);
            });
        }

        function getExerciseSuggestions(query) {
            // Inizia con esercizi predefiniti
            let allExercises = Object.keys(PREDEFINED_EXERCISES);
            
            // Aggiungi esercizi dalla cronologia degli allenamenti
            workoutHistory.forEach(workout => {
                workout.exercises.forEach(exercise => {
                    if (!allExercises.includes(exercise.name)) {
                        allExercises.push(exercise.name);
                    }
                });
            });
            
            return allExercises
                .filter(exercise => exercise.toLowerCase().includes(query))
                .sort()
                .slice(0, 8); // Aumentato a 8 suggerimenti
        }

        function showSuggestions(suggestions, container, input) {
            if (suggestions.length === 0) {
                hideSuggestions(container);
                return;
            }

            container.innerHTML = suggestions.map((suggestion, index) => 
                `<div class="autocomplete-suggestion" data-index="${index}">${suggestion}</div>`
            ).join('');

            container.classList.add('show');
            selectedSuggestionIndex = -1;

            container.querySelectorAll('.autocomplete-suggestion').forEach((item, index) => {
                item.addEventListener('click', function() {
                    input.value = suggestions[index];
                    hideSuggestions(container);
                    input.focus();
                });
            });
        }

        function hideSuggestions(container) {
            container.classList.remove('show');
            selectedSuggestionIndex = -1;
        }

        function handleKeyNavigation(e, container, input) {
            const suggestions = container.querySelectorAll('.autocomplete-suggestion');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, suggestions.length - 1);
                updateSuggestionSelection(suggestions);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                updateSuggestionSelection(suggestions);
            } else if (e.key === 'Enter') {
                if (selectedSuggestionIndex >= 0 && suggestions[selectedSuggestionIndex]) {
                    e.preventDefault();
                    input.value = suggestions[selectedSuggestionIndex].textContent;
                    hideSuggestions(container);
                }
            } else if (e.key === 'Escape') {
                hideSuggestions(container);
            }
        }

        function updateSuggestionSelection(suggestions) {
            suggestions.forEach((item, index) => {
                item.classList.toggle('selected', index === selectedSuggestionIndex);
            });
        }

        // NAVIGATION
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(pageId + 'Page').classList.add('active');
            document.querySelector(`[data-page="${pageId}"]`).classList.add('active');
            
            // Update charts when showing progress page
            if (pageId === 'progress') {
                setTimeout(() => {
                    updateExerciseFilterOptions();
                    updateProgressCharts();
                }, 100);
            }
        }

        // WORKOUT FUNCTIONS
        function updateWorkoutDate() {
            const today = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            document.getElementById('workoutDate').textContent = today.toLocaleDateString('it-IT', options);
            
            // Set default date in save modal
            const dateInput = document.getElementById('workoutDateInput');
            dateInput.value = today.toISOString().split('T')[0];
        }

        function showAddExerciseModal() {
            document.getElementById('exerciseModal').classList.add('show');
            document.getElementById('exerciseNameInput').focus();
        }

        function confirmAddExercise() {
            const name = document.getElementById('exerciseNameInput').value.trim();
            if (!name) {
                alert('Inserisci il nome dell\'esercizio');
                return;
            }

            // Se è il primo esercizio aggiunto manualmente, resetta il nome scheda
            if (currentExercises.length === 0) {
                currentSchedaName = null;
            }

            // Controlla se l'esercizio è già nel database
            const normalizedName = name.toLowerCase();
            const isInDatabase = PREDEFINED_EXERCISES[normalizedName] !== undefined;
            const hasBeenUsed = workoutHistory.some(workout => 
                workout.exercises.some(ex => ex.name.toLowerCase() === normalizedName)
            );

            // Se l'esercizio non è mai stato usato e non è nel database, mostra la modale di configurazione
            if (!isInDatabase && !hasBeenUsed) {
                showMuscleSelectionModal(name);
                return;
            }

            // Procedi normalmente
            addExerciseToWorkout(name);
        }

        function addExerciseToWorkout(name, customParams = null, isCardioOverride = null) {
            const isCardio = isCardioOverride !== null ? isCardioOverride : isCardioExercise(name);
            const lastData = getLastExerciseData(name);

            let exercise;
            if (isCardio) {
                // Esercizio cardio: tempo e distanza
                const time = customParams?.time ?? lastData?.time ?? 30;
                const distance = customParams?.distance ?? lastData?.distance ?? 5;
                
                exercise = {
                    id: Date.now(),
                    name: name,
                    isCardio: true,
                    time: time,
                    distance: distance,
                    notes: lastData?.notes || '',
                    notesCollapsed: !(lastData?.notes)
                };
            } else {
                // Esercizio tradizionale: sets, reps, weight
                const sets = customParams?.sets ?? lastData?.sets ?? 3;
                const reps = customParams?.reps ?? lastData?.reps ?? 10;
                const weight = customParams?.weight ?? lastData?.weight ?? 0;
                
                exercise = {
                    id: Date.now(),
                    name: name,
                    isCardio: false,
                    sets: sets,
                    reps: reps,
                    weight: weight,
                    notes: lastData?.notes || '',
                    notesCollapsed: !(lastData?.notes)
                };
            }

            currentExercises.push(exercise);
            renderExercises();
            hideModal();
            
            // Clear input
            document.getElementById('exerciseNameInput').value = '';
        }

        function showMuscleSelectionModal(exerciseName) {
            // Salva il nome dell'esercizio per usarlo dopo
            window.pendingExerciseName = exerciseName;
            
            // Reset dei radio button e mostra input tradizionali di default
            document.querySelector('input[name="exerciseType"][value="traditional"]').checked = true;
            toggleExerciseInputs();
            
            // Mostra la modale
            document.getElementById('muscleSelectionModal').classList.add('show');
        }

        function toggleExerciseInputs() {
            const exerciseType = document.querySelector('input[name="exerciseType"]:checked').value;
            const traditionalInputs = document.getElementById('traditionalInputs');
            const cardioInputs = document.getElementById('cardioInputs');
            const inputsTitle = document.getElementById('inputsTitle');
            
            if (exerciseType === 'cardio') {
                traditionalInputs.style.display = 'none';
                cardioInputs.style.display = 'flex';
                inputsTitle.textContent = 'Specifica durata e distanza:';
            } else {
                traditionalInputs.style.display = 'flex';
                cardioInputs.style.display = 'none';
                inputsTitle.textContent = 'Specifica serie, reps e peso:';
            }
        }

        function confirmMuscleSelection() {
            const exerciseName = window.pendingExerciseName;
            if (!exerciseName) return;

            // Ottieni il tipo selezionato
            const exerciseType = document.querySelector('input[name="exerciseType"]:checked').value;
            const isCardio = exerciseType === 'cardio';

            // Ottieni i muscoli selezionati
            const selectedMuscles = [];
            document.querySelectorAll('.muscle-checkbox input[type="checkbox"]:checked').forEach(checkbox => {
                selectedMuscles.push(checkbox.value);
            });

            // Se è cardio, aggiungi 'cardio' ai muscoli
            if (isCardio) {
                selectedMuscles.push('cardio');
            }

            // Aggiungi al database predefinito
            PREDEFINED_EXERCISES[exerciseName.toLowerCase()] = selectedMuscles;

            // Salva nel localStorage per persistenza
            localStorage.setItem('customExercises', JSON.stringify(PREDEFINED_EXERCISES));

            // Ottieni i valori dei campi di input
            let exerciseParams = {};
            if (isCardio) {
                exerciseParams = {
                    time: parseInt(document.getElementById('exerciseTime').value) || 30,
                    distance: parseFloat(document.getElementById('exerciseDistance').value) || 5
                };
            } else {
                exerciseParams = {
                    sets: parseInt(document.getElementById('exerciseSets').value) || 3,
                    reps: parseInt(document.getElementById('exerciseReps').value) || 10,
                    weight: parseFloat(document.getElementById('exerciseWeight').value) || 0
                };
            }

            // Ora aggiungi l'esercizio al workout con i parametri specificati
            addExerciseToWorkout(exerciseName, exerciseParams, isCardio);
            
            // Chiudi la modale
            document.getElementById('muscleSelectionModal').classList.remove('show');
        }

        function cancelMuscleSelection() {
            document.getElementById('muscleSelectionModal').classList.remove('show');
            window.pendingExerciseName = null;
        }

        function hideModal() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('show');
            });
        }

        function getLastExerciseData(exerciseName) {
            if (!exerciseName || workoutHistory.length === 0) return null;
            const target = exerciseName.toLowerCase();

            for (let i = workoutHistory.length - 1; i >= 0; i--) {
                const workout = workoutHistory[i];
                if (!workout || !Array.isArray(workout.exercises)) continue;

                const match = workout.exercises.find(ex =>
                    ex && ex.name && ex.name.toLowerCase() === target
                );

                if (match) {
                    if (match.isCardio) {
                        // Esercizio cardio
                        const parsedTime = parseInt(match.time, 10);
                        const parsedDistance = parseFloat(match.distance);

                        return {
                            isCardio: true,
                            time: Number.isFinite(parsedTime) ? parsedTime : undefined,
                            distance: Number.isFinite(parsedDistance) ? parsedDistance : undefined,
                            notes: match.notes || ''
                        };
                    } else {
                        // Esercizio tradizionale
                        const parsedSets = parseInt(match.sets, 10);
                        const parsedReps = parseInt(match.reps, 10);
                        const parsedWeight = parseFloat(match.weight);

                        return {
                            isCardio: false,
                            sets: Number.isFinite(parsedSets) ? parsedSets : undefined,
                            reps: Number.isFinite(parsedReps) ? parsedReps : undefined,
                            weight: Number.isFinite(parsedWeight) ? parsedWeight : undefined,
                            notes: match.notes || ''
                        };
                    }
                }
            }

            return null;
        }

        function renderExercises() {
            const container = document.getElementById('exercisesList');
            
            if (currentExercises.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">💪</div>
                        <div class="empty-state-title">Nessun esercizio</div>
                        <div>Aggiungi un esercizio o carica un Scheda</div>
                    </div>
                `;
                document.getElementById('saveWorkoutBtn').style.display = 'none';
                document.getElementById('reorderExercisesBtn').style.display = 'none';
                return;
            }

            const baseId = Date.now();

            container.innerHTML = currentExercises.map((exercise, index) => {
                if (!exercise.id) {
                    exercise.id = baseId + index;
                }

                if (typeof exercise.notesCollapsed === 'undefined') {
                    exercise.notesCollapsed = true;
                }

                const isCollapsed = exercise.notesCollapsed !== false;
                const hasNotes = !!(exercise.notes && exercise.notes.trim().length);

                const notesToggleClasses = [
                    'control-btn',
                    'notes-toggle',
                    !isCollapsed ? 'open' : '',
                    hasNotes ? 'has-text' : ''
                ].filter(Boolean).join(' ');

                const notesSectionClasses = [
                    'notes-section',
                    isCollapsed ? 'collapsed' : ''
                ].filter(Boolean).join(' ');

                const notesToggleTitle = isCollapsed ? 'Mostra note' : 'Nascondi note';
                const notesToggleIcon = isCollapsed ? '📝' : '📄';

                return `
                    <div class="exercise-card">
                        <div class="exercise-header">
                            <div class="exercise-name">${exercise.name}</div>
                            <div class="exercise-controls">
                                <button class="control-btn video-btn" title="Video YouTube" onclick="openExerciseVideo(${index})">🎥</button>
                                <button class="${notesToggleClasses}" title="${notesToggleTitle}" onclick="toggleNotes(${index})">${notesToggleIcon}</button>
                                <button class="control-btn delete" title="Rimuovi" onclick="removeExercise(${index})">🗑️</button>
                            </div>
                        </div>
                        <div class="exercise-inputs">
                            ${exercise.isCardio ? `
                                <div class="input-group">
                                    <label class="input-label">Tempo</label>
                                    <input type="number" class="input-field" placeholder="Minuti" value="${exercise.time}" 
                                           onchange="updateExercise(${index}, 'time', this.value)" min="1">
                                    <small class="input-hint">Minuti</small>
                                </div>
                                <div class="input-group">
                                    <label class="input-label">Distanza</label>
                                    <input type="number" class="input-field" placeholder="Km" value="${exercise.distance}" 
                                           onchange="updateExercise(${index}, 'distance', this.value)" min="0" step="0.1">
                                    <small class="input-hint">Km</small>
                                </div>
                                <div class="input-group cardio-placeholder">
                                    <!-- Placeholder per mantenere l'allineamento -->
                                </div>
                            ` : `
                                <div class="input-group">
                                    <label class="input-label">Serie</label>
                                    <input type="number" class="input-field" placeholder="Serie" value="${exercise.sets}" 
                                           onchange="updateExercise(${index}, 'sets', this.value)" min="1">
                                    <small class="input-hint">Serie</small>
                                </div>
                                <div class="input-group">
                                    <label class="input-label">Reps</label>
                                    <input type="number" class="input-field" placeholder="Reps" value="${exercise.reps}" 
                                           onchange="updateExercise(${index}, 'reps', this.value)" min="1">
                                    <small class="input-hint">Reps</small>
                                </div>
                                <div class="input-group">
                                    <label class="input-label">Peso (kg)</label>
                                    <input type="number" class="input-field" placeholder="Kg" value="${exercise.weight}" 
                                           onchange="updateExercise(${index}, 'weight', this.value)" min="0" step="0.5">
                                    <small class="input-hint">Kg</small>
                                </div>
                            `}
                        </div>
                        <div class="${notesSectionClasses}">
                            <textarea class="notes-input" placeholder="Note per questo esercizio..." 
                                      onchange="updateExercise(${index}, 'notes', this.value)">${exercise.notes || ''}</textarea>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('saveWorkoutBtn').style.display = 'block';
            document.getElementById('reorderExercisesBtn').style.display = currentExercises.length > 1 ? 'inline-block' : 'none';
        }

        function updateExercise(index, field, value) {
            if (field === 'sets' || field === 'reps' || field === 'time') {
                currentExercises[index][field] = parseInt(value) || 1;
            } else if (field === 'weight' || field === 'distance') {
                currentExercises[index][field] = parseFloat(value) || 0;
            } else {
                currentExercises[index][field] = value;
            }
        }

        function toggleNotes(index) {
            if (!currentExercises[index]) return;
            const current = currentExercises[index].notesCollapsed !== false;
            currentExercises[index].notesCollapsed = !current;
            renderExercises();
        }

        function moveExercise(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= currentExercises.length) return;
            
            [currentExercises[index], currentExercises[newIndex]] = [currentExercises[newIndex], currentExercises[index]];
            renderExercises();
        }

        function duplicateExercise(index) {
            const exercise = { ...currentExercises[index] };
            exercise.id = Date.now();
            exercise.notesCollapsed = true;
            currentExercises.splice(index + 1, 0, exercise);
            renderExercises();
        }

        function showReorderModal() {
            const modal = document.getElementById('reorderModal');
            const list = document.getElementById('reorderList');
            
            list.innerHTML = currentExercises.map((ex, index) => `
                <div class="reorder-item" draggable="true" data-index="${index}">
                    <span class="reorder-handle">☰</span>
                    <span class="reorder-item-name">${ex.name}</span>
                </div>
            `).join('');
            
            // Add drag and drop functionality
            const items = list.querySelectorAll('.reorder-item');
            let draggedItem = null;
            
            items.forEach(item => {
                item.addEventListener('dragstart', function() {
                    draggedItem = this;
                    this.classList.add('dragging');
                });
                
                item.addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                });
                
                item.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(list, e.clientY);
                    if (afterElement == null) {
                        list.appendChild(draggedItem);
                    } else {
                        list.insertBefore(draggedItem, afterElement);
                    }
                });
            });
            
            modal.classList.add('show');
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.reorder-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
        function showReorderModal() {
            const modal = document.getElementById('reorderModal');
            const list = document.getElementById('reorderList');
            
            renderReorderList();
            modal.classList.add('show');
        }

        function renderReorderList() {
            const list = document.getElementById('reorderList');
            list.innerHTML = currentExercises.map((ex, index) => `
                <div class="reorder-item" data-index="${index}">
                    <span class="reorder-item-name">${ex.name}</span>
                    <div class="reorder-controls">
                        <button class="reorder-arrow-btn" onclick="moveItemInReorder(${index}, -1)" ${index === 0 ? 'disabled' : ''}>↑</button>
                        <button class="reorder-arrow-btn" onclick="moveItemInReorder(${index}, 1)" ${index === currentExercises.length - 1 ? 'disabled' : ''}>↓</button>
                    </div>
                </div>
            `).join('');
        }

        function moveItemInReorder(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= currentExercises.length) return;
            
            // Scambia gli esercizi
            [currentExercises[index], currentExercises[newIndex]] = [currentExercises[newIndex], currentExercises[index]];
            
            // Ri-renderizza la lista
            renderReorderList();
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.reorder-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function confirmReorder() {
            // Gli esercizi sono già stati riordinati in tempo reale
            renderExercises();
            document.getElementById('reorderModal').classList.remove('show');
        }

        function removeExercise(index) {
            currentExercises.splice(index, 1);
            renderExercises();
        }

        function openExerciseVideo(index) {
            const exerciseName = currentExercises[index].name;
            const searchQuery = 'how to do ' + exerciseName + ' properly';
            const youtubeUrl = 'https://www.youtube.com/results?search_query=' + encodeURIComponent(searchQuery);

            try {
                const newWindow = window.open(youtubeUrl, '_blank');
                if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                    // Popup bloccato, apri nella stessa finestra
                    if (confirm('Il popup è stato bloccato. Vuoi aprire YouTube in questa finestra? (perderai il workout corrente)')) {
                        window.location.href = youtubeUrl;
                    }
                }
            } catch (e) {
                // Fallback per browser che bloccano popup
                if (confirm('Impossibile aprire il video. Vuoi aprire YouTube in questa finestra? (perderai il workout corrente)')) {
                    window.location.href = youtubeUrl;
                }
            }
        }

        function showSaveWorkoutModal() {
            // Imposta valori di default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('workoutDateInput').value = today;
            document.getElementById('durationInput').value = 60;
            document.getElementById('notesInput').value = '';
            
            document.getElementById('saveModal').classList.add('show');
            document.getElementById('durationInput').focus();
        }

        function confirmSaveWorkout() {
            // CORREZIONE BUG 1: Gestione corretta della data
            const workoutDateInput = document.getElementById('workoutDateInput').value;
            if (!workoutDateInput) {
                alert('Seleziona una data per l\'allenamento');
                return;
            }
            
            const duration = parseInt(document.getElementById('durationInput').value) || 60;
            const notes = document.getElementById('notesInput').value.trim();

            if (currentExercises.length === 0) {
                alert('Aggiungi almeno un esercizio prima di salvare');
                return;
            }

            const workout = {
                id: Date.now() + Math.random(), // CORREZIONE BUG 2: ID univoco
                date: workoutDateInput, // Usa direttamente il valore dell'input (formato YYYY-MM-DD)
                exercises: currentExercises.map(ex => ({
                    name: ex.name,
                    sets: ex.sets,
                    reps: ex.reps,
                    weight: ex.weight,
                    notes: ex.notes || ''
                })),
                duration: duration,
                notes: notes,
                schedaName: currentSchedaName
            };

            workoutHistory.push(workout);
            localStorage.setItem('workoutHistory', JSON.stringify(workoutHistory));

            // Reset current workout
            currentExercises = [];
            currentSchedaName = null;
            renderExercises();
            
            // Update other views
            updateStats();
            renderHistory();
            renderProgress();
            renderCalendar();
            updateExerciseFilterOptions();

            hideModal();
        }

        // TEMPLATE FUNCTIONS
        function renderSchedaButtons() {
            const container = document.getElementById('SchedaButtons');

            const entriesMap = new Map();

            Object.entries(customSchede).forEach(([id, scheda]) => {
                const isProtected = id.startsWith('giulia24_') || id.startsWith('giovanna0_');
                if (!isProtected || unlockedCodes.some(code => codeMappings[code] && codeMappings[code].includes(id))) {
                    entriesMap.set(id, scheda);
                }
            });

            getUnlockedProtectedSchede().forEach(([id, scheda]) => {
                if (!entriesMap.has(id)) {
                    entriesMap.set(id, scheda);
                }
            });

            const entries = Array.from(entriesMap.entries());

            container.innerHTML = entries.map(([id, Scheda]) => {
                const isPersonal = id.startsWith('personal_');
                const isProtected = id.startsWith('giulia24_') || id.startsWith('giovanna0_');
                const isUnlocked = unlockedCodes.some(code => codeMappings[code] && codeMappings[code].includes(id));
                const showActions = !isPersonal && (!isProtected || isUnlocked);

                return `
                    <button class="template-btn" data-template="${id}">
                        ${Scheda.name}
                        ${showActions ? `<button class="template-edit-btn" onclick="event.stopPropagation(); editScheda('${id}')">✏️</button>` : ''}
                        ${showActions ? `<button class="template-delete-btn" onclick="event.stopPropagation(); deleteScheda('${id}')">🗑️</button>` : ''}
                    </button>
                `;
            }).join('');

            document.querySelectorAll('[data-template]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const templateId = this.getAttribute('data-template');
                    loadScheda(templateId);
                });
            });
        }

        function loadScheda(SchedaId) {
            let Scheda = customSchede[SchedaId];

            if (!Scheda) {
                const isProtected = unlockedCodes.some(code => codeMappings[code] && codeMappings[code].includes(SchedaId));
                if (isProtected && protectedSchedeData[SchedaId]) {
                    Scheda = protectedSchedeData[SchedaId];
                }
            }

            if (!Scheda) {
                alert('Scheda non disponibile. Inserisci il codice corretto per accedervi.');
                return;
            }

            currentSchedaName = Scheda.name;

            currentExercises = Scheda.exercises.map(ex => {
                const isCardio = isCardioExercise(ex.name);
                const lastData = getLastExerciseData(ex.name);
                
                if (isCardio) {
                    const defaultTime = Number.isFinite(parseInt(ex.time, 10)) ? parseInt(ex.time, 10) : (lastData?.time ?? 30);
                    const defaultDistance = Number.isFinite(parseFloat(ex.distance)) ? parseFloat(ex.distance) : (lastData?.distance ?? 5);
                    
                    return {
                        id: Date.now() + Math.random(),
                        name: ex.name,
                        isCardio: true,
                        time: defaultTime,
                        distance: defaultDistance,
                        notes: ex.notes || '',
                        notesCollapsed: true
                    };
                } else {
                    const defaultSets = Number.isFinite(parseInt(ex.sets, 10)) ? parseInt(ex.sets, 10) : (lastData?.sets ?? 3);
                    const defaultReps = Number.isFinite(parseInt(ex.reps, 10)) ? parseInt(ex.reps, 10) : (lastData?.reps ?? 10);
                    const defaultWeight = Number.isFinite(parseFloat(ex.weight)) ? parseFloat(ex.weight) : (lastData?.weight ?? 0);
                    
                    return {
                        id: Date.now() + Math.random(),
                        name: ex.name,
                        isCardio: false,
                        sets: defaultSets,
                        reps: defaultReps,
                        weight: defaultWeight,
                        notes: ex.notes || '',
                        notesCollapsed: true
                    };
                }
            });

            renderExercises();
        }

        function renderSchedaEditors() {
            const container = document.getElementById('SchedaEditorsList');
            
            // Filtra le schede: escludi personali e schede protette non sbloccate
            const editableSchede = Object.entries(customSchede).filter(([id]) => {
                if (id.startsWith('personal_')) return false;
                const isProtected = id.startsWith('giulia24_') || id.startsWith('giovanna0_');
                return !isProtected;
            });
            
            // Ottieni le schede protette sbloccate
            const unlockedProtectedSchede = getUnlockedProtectedSchede();
            
            container.innerHTML = editableSchede.map(([id, Scheda]) => `
                <div class="template-editor">
                    <h3>⚙️ ${Scheda.name}</h3>
                    <div class="template-info">
                        <input type="text" class="modal-input" value="${Scheda.name}" 
                               onchange="updateSchedaName('${id}', this.value)" 
                               placeholder="Nome Template">
                    </div>
                    <button class="add-template-exercise-btn" onclick="showAddSchedaExercise('${id}')">
                        ➕ Aggiungi Esercizio
                    </button>
                    <div class="template-exercises">
                        ${Scheda.exercises.map((exercise, index) => `
                            <div class="template-exercise-item">
                                <div class="template-exercise-info">
                                    <div class="template-exercise-name">${exercise.name}</div>
                                    <div class="template-exercise-details">${exercise.sets} serie × ${exercise.reps} reps @ ${exercise.weight}kg</div>
                                </div>
                                <div class="template-exercise-controls">
                                    <button class="template-exercise-btn" onclick="moveSchedaExercise('${id}', ${index}, -1)">↑</button>
                                    <button class="template-exercise-btn" onclick="moveSchedaExercise('${id}', ${index}, 1)">↓</button>
                                    <button class="template-exercise-btn delete" onclick="removeSchedaExercise('${id}', ${index})">🗑️</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('') + 
            // Aggiungi le schede protette sbloccate in sola lettura
            (unlockedProtectedSchede.length > 0 ? `
                <div class="template-editor">
                    <h3>🔒 Schede Sbloccate (Sola Lettura)</h3>
                    ${unlockedProtectedSchede.map(([id, Scheda]) => `
                        <div class="template-editor" style="border: 2px solid #48bb78; margin-bottom: 20px;">
                            <h3>✅ ${Scheda.name}</h3>
                            <div class="template-exercises">
                                ${Scheda.exercises.map((exercise, index) => `
                                    <div class="template-exercise-item">
                                        <div class="template-exercise-info">
                                            <div class="template-exercise-name">${exercise.name}</div>
                                            <div class="template-exercise-details">${exercise.sets} serie × ${exercise.reps} reps @ ${exercise.weight}kg</div>
                                        </div>
                                        <div class="template-exercise-controls">
                                            <span style="color: #718096; font-size: 0.8em;">🔒 Protetta</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            ` : '');
        }

        function editScheda(SchedaId) {
            showPage('Schede');
        }

        function deleteScheda(SchedaId) {
            if (SchedaId.startsWith('personal_')) {
                alert('Questa scheda è protetta e non può essere eliminata.');
                return;
            }
            if (confirm('Sei sicuro di voler eliminare questo Scheda?')) {
                if (customSchede[SchedaId]) {
                    delete customSchede[SchedaId];
                    saveSchede();
                } else {
                    // È una scheda sbloccata, rimuovi il codice
                    const codesToRemove = new Set();
                    Object.entries(codeMappings).forEach(([code, ids]) => {
                        if (ids.includes(SchedaId)) {
                            codesToRemove.add(code);
                        }
                    });
                    unlockedCodes = unlockedCodes.filter(code => !codesToRemove.has(code));
                    localStorage.setItem('unlockedCodes', JSON.stringify(unlockedCodes));
                }
                renderSchedaButtons();
                renderSchedaEditors();
            }
        }

        function showAddSchedaModal() {
            document.getElementById('newSchedaModal').classList.add('show');
            document.getElementById('newSchedaNameInput').focus();
        }

        function confirmAddScheda() {
            const name = document.getElementById('newSchedaNameInput').value.trim();
            if (!name) {
                alert('Inserisci il nome del Scheda');
                return;
            }

            const newId = 'Scheda_' + Date.now();
            customSchede[newId] = {
                name: name,
                exercises: []
            };

            saveSchede();
            renderSchedaButtons();
            renderSchedaEditors();
            hideModal();
        }

        function updateSchedaName(SchedaId, newName) {
            customSchede[SchedaId].name = newName;
            saveSchede();
            renderSchedaButtons();
        }

        function showAddSchedaExercise(SchedaId) {
            currentEditingScheda = SchedaId;
            document.getElementById('SchedaExerciseModal').classList.add('show');
        }

        function confirmAddSchedaExercise() {
            const name = document.getElementById('SchedaExerciseNameInput').value.trim();
            const sets = parseInt(document.getElementById('SchedaExerciseSetsInput').value) || 3;
            const reps = parseInt(document.getElementById('SchedaExerciseRepsInput').value) || 10;
            const weight = parseFloat(document.getElementById('SchedaExerciseWeightInput').value) || 20;

            if (!name || !currentEditingScheda) return;

            customSchede[currentEditingScheda].exercises.push({
                name: name,
                sets: sets,
                reps: reps,
                weight: weight
            });

            saveSchede();
            renderSchedaButtons();
            renderSchedaEditors();
            hideModal();

            // Clear inputs
            document.getElementById('SchedaExerciseNameInput').value = '';
            document.getElementById('SchedaExerciseSetsInput').value = '';
            document.getElementById('SchedaExerciseRepsInput').value = '';
            document.getElementById('SchedaExerciseWeightInput').value = '';
        }

        function moveSchedaExercise(SchedaId, index, direction) {
            const exercises = customSchede[SchedaId].exercises;
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= exercises.length) return;
            
            [exercises[index], exercises[newIndex]] = [exercises[newIndex], exercises[index]];
            saveSchede();
            renderSchedaButtons();
            renderSchedaEditors();
        }

        function removeSchedaExercise(SchedaId, index) {
            const exerciseName = customSchede[SchedaId].exercises[index].name;
            if (confirm(`Sei sicuro di voler eliminare l'esercizio "${exerciseName}"?`)) {
                customSchede[SchedaId].exercises.splice(index, 1);
                saveSchede();
                renderSchedaButtons();
                renderSchedaEditors();
            }
        }

        function saveSchede() {
            localStorage.setItem('customSchede', JSON.stringify(customSchede));
        }

        // PROGRESS FUNCTIONS
        function renderProgress() {
            const container = document.getElementById('progressList');
            let progressData = calculateProgressFromHistory();
            
            // Filtra per gruppo muscolare se selezionato
            if (selectedMuscleGroup !== null) {
                const filteredData = {};
                Object.entries(progressData).forEach(([exerciseName, data]) => {
                    const muscles = getMuscleGroupsForExercise(exerciseName);
                    if (muscles.includes(selectedMuscleGroup)) {
                        filteredData[exerciseName] = data;
                    }
                });
                progressData = filteredData;
            }
            
            if (Object.keys(progressData).length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📊</div>
                        <div class="empty-state-title">Nessun progresso</div>
                        <div>Salva alcuni allenamenti per vedere i tuoi progressi</div>
                    </div>
                `;
                return;
            }

            const cards = Object.entries(progressData).map(([exerciseName, data]) => {
                const latest = data[data.length - 1];
                const previous = data.length > 1 ? data[data.length - 2] : latest;
                const maxWeight = Math.max(...data.map(d => d.weight));
                const avgVolume = Math.round(data.reduce((sum, d) => sum + d.volume, 0) / data.length);
                
                let trend = 'stable';
                let trendText = 'Stabile';
                if (latest.weight > previous.weight) {
                    trend = 'up';
                    trendText = '+' + (latest.weight - previous.weight) + 'kg';
                } else if (latest.weight < previous.weight) {
                    trend = 'down';
                    trendText = '-' + (previous.weight - latest.weight) + 'kg';
                }

                return `
                    <div class="progress-card">
                        <div class="progress-header">
                            <div class="progress-title">${exerciseName}</div>
                            <div class="progress-trend trend-${trend}">${trendText}</div>
                        </div>
                        <div class="progress-stats">
                            <div>
                                <div class="stat-value">${latest.weight}kg</div>
                                <div class="stat-label">Ultimo peso</div>
                            </div>
                            <div>
                                <div class="stat-value">${maxWeight}kg</div>
                                <div class="stat-label">Peso massimo</div>
                            </div>
                            <div>
                                <div class="stat-value">${avgVolume}kg</div>
                                <div class="stat-label">Volume medio</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = cards;
        }

        function createWeightChart() {
            const ctx = document.getElementById('weightChart');
            if (!ctx) return;

            // Distruggi il grafico esistente se presente
            if (weightChart) {
                weightChart.destroy();
                weightChart = null;
            }

            const progressData = getFilteredProgressData();
            
            if (Object.keys(progressData).length === 0) {
                ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
                return;
            }

            const datasets = Object.entries(progressData).map(([exerciseName, data], index) => {
                const colors = ['#4a5568', '#48bb78', '#ed8936', '#9f7aea', '#38b2ac'];
                const color = colors[index % colors.length];
                
                return {
                    label: exerciseName,
                    data: data.map(session => ({
                        x: new Date(session.date).toLocaleDateString('it-IT', { month: 'short', day: 'numeric' }),
                        y: session.weight
                    })),
                    borderColor: color,
                    backgroundColor: color + '20',
                    tension: 0.4,
                    fill: false
                };
            });

            weightChart = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: Object.keys(progressData).length > 1,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                boxWidth: 12,
                                boxHeight: 12,
                                padding: 8,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Peso (kg)',
                                font: { size: 12, weight: 'bold' }
                            },
                            grid: { color: '#e2e8f0' }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Data',
                                font: { size: 12, weight: 'bold' }
                            },
                            grid: { color: '#e2e8f0' }
                        }
                    }
                }
            });
        }

        function createVolumeChart() {
            const ctx = document.getElementById('volumeChart');
            if (!ctx) return;

            // Distruggi il grafico esistente se presente
            if (volumeChart) {
                volumeChart.destroy();
                volumeChart = null;
            }

            const progressData = getFilteredProgressData();
            
            if (Object.keys(progressData).length === 0) {
                ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
                return;
            }
            
            // Aggrega volume per data E salva il nome dell'allenamento
            const volumeByDate = {};
            const workoutNamesByDate = {};
            
            // Mappa date ai nomi allenamenti
            workoutHistory.forEach(workout => {
                const dateKey = new Date(workout.date).toLocaleDateString('it-IT', { month: 'short', day: 'numeric' });
                workoutNamesByDate[dateKey] = workout.name || 'Allenamento';
            });
            
            Object.entries(progressData).forEach(([exerciseName, data]) => {
                data.forEach(session => {
                    const date = new Date(session.date).toLocaleDateString('it-IT', { month: 'short', day: 'numeric' });
                    if (!volumeByDate[date]) volumeByDate[date] = 0;
                    volumeByDate[date] += session.volume;
                });
            });

            const sortedDates = Object.keys(volumeByDate).sort((a, b) => {
                // Ordina per data effettiva
                const dateA = Object.values(progressData)[0]?.find(d => 
                    new Date(d.date).toLocaleDateString('it-IT', { month: 'short', day: 'numeric' }) === a
                )?.date || '2024-01-01';
                const dateB = Object.values(progressData)[0]?.find(d => 
                    new Date(d.date).toLocaleDateString('it-IT', { month: 'short', day: 'numeric' }) === b
                )?.date || '2024-01-01';
                return new Date(dateA) - new Date(dateB);
            });

            volumeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'Volume Totale (kg)',
                        data: sortedDates.map(date => volumeByDate[date]),
                        backgroundColor: '#48bb78',
                        borderColor: '#38a169',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    const date = tooltipItems[0].label;
                                    const workoutName = workoutNamesByDate[date] || 'Allenamento';
                                    return `${workoutName} (${date})`;
                                },
                                label: function(context) {
                                    return `Volume: ${context.parsed.y}kg`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Volume (kg)',
                                font: { size: 12, weight: 'bold' }
                            },
                            grid: { color: '#e2e8f0' }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Data',
                                font: { size: 12, weight: 'bold' }
                            },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // CORREZIONE BUG 3: Funzione di filtraggio migliorata
        function getFilteredProgressData() {
            const timeFilter = document.getElementById('timeFilter').value;
            const exerciseFilter = document.getElementById('exerciseFilter').value;
            
            let progressData = calculateProgressFromHistory();
            
            // Filtra per gruppo muscolare SE selezionato
            if (selectedMuscleGroup !== null) {
                const filteredData = {};
                Object.entries(progressData).forEach(([exerciseName, data]) => {
                    const muscles = getMuscleGroupsForExercise(exerciseName);
                    if (muscles.includes(selectedMuscleGroup)) {
                        filteredData[exerciseName] = data;
                    }
                });
                progressData = filteredData;
            }
            
            // Filtra per esercizio PRIMA del filtraggio temporale
            if (exerciseFilter && exerciseFilter !== '') {
                const filteredData = {};
                if (progressData[exerciseFilter]) {
                    filteredData[exerciseFilter] = progressData[exerciseFilter];
                }
                progressData = filteredData;
            }
            
            // Filtra per tempo
            if (timeFilter !== 'all') {
                let cutoffDate;
                
                if (timeFilter === 'custom') {
                    // Usa le date personalizzate
                    const startDateInput = document.getElementById('startDate').value;
                    const endDateInput = document.getElementById('endDate').value;
                    
                    if (startDateInput && endDateInput) {
                        const startDate = new Date(startDateInput);
                        const endDate = new Date(endDateInput);
                        endDate.setHours(23, 59, 59, 999); // Fine giornata
                        
                        Object.keys(progressData).forEach(exerciseName => {
                            progressData[exerciseName] = progressData[exerciseName].filter(session => {
                                const sessionDate = new Date(session.date);
                                return sessionDate >= startDate && sessionDate <= endDate;
                            });
                        });
                    }
                } else {
                    // Usa i giorni predefiniti
                    const daysBack = parseInt(timeFilter);
                    cutoffDate = new Date();
                    cutoffDate.setDate(cutoffDate.getDate() - daysBack);
                    cutoffDate.setHours(0, 0, 0, 0); // Normalizza a mezzanotte
                    
                    Object.keys(progressData).forEach(exerciseName => {
                        progressData[exerciseName] = progressData[exerciseName].filter(session => {
                            const sessionDate = new Date(session.date);
                            sessionDate.setHours(0, 0, 0, 0);
                            return sessionDate >= cutoffDate;
                        });
                    });
                }
            }
            
            return progressData;
        }

        // CORREZIONE BUG 3: Funzione di aggiornamento grafici migliorata
        function updateProgressCharts() {
            // Distruggi i grafici esistenti se presenti
            if (weightChart) {
                weightChart.destroy();
                weightChart = null;
            }
            if (volumeChart) {
                volumeChart.destroy();
                volumeChart = null;
            }
            
            // Ricrea i grafici con i dati filtrati
            createWeightChart();
            createVolumeChart();
            
            // Mostra i muscoli allenati nel periodo
            showMusclesWorked();
        }

        // Funzione per mappare esercizi ai muscoli (gruppi semplificati)
        function getMuscleGroupsForExercise(exerciseName) {
            const name = exerciseName.toLowerCase();
            
            // Prima controlla il database predefinito
            if (PREDEFINED_EXERCISES[name]) {
                return [...PREDEFINED_EXERCISES[name]];
            }
            
            // Fallback alla logica esistente per esercizi non nel database
            const muscles = [];
            
            // Petto
            if (name.includes('panca') || name.includes('bench') || name.includes('push') || name.includes('dips') || name.includes('petto') || name.includes('croci') || name.includes('flyes')) {
                muscles.push('petto');
            }
            
            // Dorso (schiena)
            if (name.includes('trazioni') || name.includes('pull-ups') || name.includes('chin-ups') || name.includes('rematore') || name.includes('row') || name.includes('stacco') || name.includes('deadlift') || name.includes('lat machine') || name.includes('tirate machine') || name.includes('pulley') || name.includes('lat pulldown') || name.includes('schiena')) {
                muscles.push('dorso');
            }
            
            // Quadricipiti
            if (name.includes('squat') || name.includes('leg press') || name.includes('pressa gambe') || name.includes('leg extension') || name.includes('estensioni gambe') || name.includes('affondi') || name.includes('lunges') || name.includes('quadricipiti')) {
                muscles.push('quadricipiti');
            }
            
            // Bicipiti femorali (ischiocrurali)
            if (name.includes('leg curl') || name.includes('curl gambe') || name.includes('stacchi rumeni') || name.includes('romanian deadlift') || name.includes('ischiocrurali') || name.includes('bicipiti femorali')) {
                muscles.push('bicipiti femorali');
            }
            
            // Polpacci
            if (name.includes('calf') || name.includes('polpacci') || name.includes('alzate punte')) {
                muscles.push('polpacci');
            }
            
            // Spalle
            if (name.includes('military press') || name.includes('shoulder press') || name.includes('lateral raises') || name.includes('alzate laterali') || name.includes('rear delt') || name.includes('spalle posteriori') || name.includes('face pull') || name.includes('spalle')) {
                muscles.push('spalle');
            }
            
            // Bicipiti
            if (name.includes('curl') || name.includes('bicipiti') || name.includes('hammer curl')) {
                muscles.push('bicipiti');
            }
            
            // Tricipiti
            if (name.includes('tricipiti') || name.includes('pushdown') || name.includes('french press') || name.includes('estensioni') || name.includes('overhead')) {
                muscles.push('tricipiti');
            }
            
            // Addome
            if (name.includes('plank') || name.includes('crunch') || name.includes('sit-up') || name.includes('addominali') || name.includes('core') || name.includes('abs')) {
                muscles.push('addome');
            }
            
            // Rimuovi duplicati
            return [...new Set(muscles)];
        }

        // Lista completa di tutti i muscoli possibili (gruppi semplificati)
        const ALL_MUSCLES = [
            'quadricipiti', 'bicipiti femorali', 'polpacci', 'dorso', 'petto', 'spalle', 'bicipiti', 'tricipiti', 'addome'
        ];

        // Database esaustivo di esercizi predefiniti con i relativi muscoli
        const PREDEFINED_EXERCISES = {
            // Petto
            'panca piana': ['petto'],
            'panca inclinata': ['petto', 'spalle'],
            'panca declinata': ['petto'],
            'croci con manubri': ['petto'],
            'croci ai cavi': ['petto'],
            'croci machine': ['petto'],
            'dips': ['petto', 'tricipiti'],
            'push-ups': ['petto', 'tricipiti'],
            'petto ai cavi': ['petto'],
            'butterfly machine': ['petto'],
            'pec deck': ['petto'],
            'panca piana con bilanciere': ['petto'],
            'panca piana con manubri': ['petto'],
            'panca inclinata con bilanciere': ['petto', 'spalle'],
            'panca inclinata con manubri': ['petto', 'spalle'],
            'panca declinata con bilanciere': ['petto'],
            'panca declinata con manubri': ['petto'],
            'floor press': ['petto', 'tricipiti'],
            'svenson press': ['petto'],
            'chest press machine': ['petto'],
            'hammer strength chest press': ['petto'],
            'isometric chest squeeze': ['petto'],

            // Dorso (schiena)
            'stacco da terra': ['dorso', 'bicipiti femorali'],
            'stacco rumeno': ['dorso', 'bicipiti femorali'],
            'stacco sumo': ['dorso', 'bicipiti femorali', 'quadricipiti'],
            'trazioni alla sbarra': ['dorso', 'bicipiti'],
            'trazioni alla sbarra presa larga': ['dorso'],
            'trazioni alla sbarra presa stretta': ['dorso', 'bicipiti'],
            'rematore con bilanciere': ['dorso'],
            'rematore con manubrio': ['dorso'],
            'rematore con cavi': ['dorso'],
            'rematore machine': ['dorso'],
            'hammer strength row': ['dorso'],
            'lat machine': ['dorso'],
            'pulley': ['dorso'],
            'tirate al petto': ['dorso'],
            'tirate al petto presa larga': ['dorso'],
            'tirate al petto presa stretta': ['dorso', 'bicipiti'],
            'face pull': ['dorso', 'spalle'],
            'rear delt fly': ['dorso', 'spalle'],
            'hyperextension': ['dorso'],
            'good morning': ['dorso'],
            'shrugs': ['dorso', 'spalle'],
            'barbell shrugs': ['dorso', 'spalle'],
            'dumbbell shrugs': ['dorso', 'spalle'],
            'rack pull': ['dorso'],
            'deadlift deficit': ['dorso', 'bicipiti femorali'],
            'snatch grip deadlift': ['dorso', 'spalle'],
            'clean grip deadlift': ['dorso', 'spalle'],

            // Quadricipiti
            'squat': ['quadricipiti', 'bicipiti femorali'],
            'front squat': ['quadricipiti', 'bicipiti femorali'],
            'hack squat': ['quadricipiti'],
            'leg press': ['quadricipiti'],
            'leg press 45°': ['quadricipiti'],
            'leg press orizzontale': ['quadricipiti'],
            'walking lunges': ['quadricipiti', 'bicipiti femorali'],
            'stationary lunges': ['quadricipiti', 'bicipiti femorali'],
            'reverse lunges': ['quadricipiti', 'bicipiti femorali'],
            'bulgarian split squat': ['quadricipiti', 'bicipiti femorali'],
            'step up': ['quadricipiti', 'bicipiti femorali'],
            'leg extension': ['quadricipiti'],
            'sissy squat': ['quadricipiti'],
            'wall sit': ['quadricipiti'],
            'box squat': ['quadricipiti', 'bicipiti femorali'],
            'pause squat': ['quadricipiti', 'bicipiti femorali'],
            'zercher squat': ['quadricipiti', 'bicipiti femorali'],
            'anderson squat': ['quadricipiti', 'bicipiti femorali'],
            'jefferson squat': ['quadricipiti', 'bicipiti femorali'],

            // Bicipiti femorali (ischiocrurali)
            'leg curl': ['bicipiti femorali'],
            'lying leg curl': ['bicipiti femorali'],
            'seated leg curl': ['bicipiti femorali'],
            'standing leg curl': ['bicipiti femorali'],
            'romanian deadlift': ['bicipiti femorali', 'dorso'],
            'single leg romanian deadlift': ['bicipiti femorali', 'dorso'],
            'glute ham raise': ['bicipiti femorali'],
            'nordic hamstring curl': ['bicipiti femorali'],
            'stiff leg deadlift': ['bicipiti femorali', 'dorso'],
            'deficit deadlift': ['bicipiti femorali', 'dorso'],
            'good morning': ['bicipiti femorali', 'dorso'],
            'hyperextension': ['bicipiti femorali', 'dorso'],

            // Polpacci
            'calf raise': ['polpacci'],
            'standing calf raise': ['polpacci'],
            'seated calf raise': ['polpacci'],
            'donkey calf raise': ['polpacci'],
            'single leg calf raise': ['polpacci'],
            'leg press calf raise': ['polpacci'],
            'smith machine calf raise': ['polpacci'],
            'dumbbell calf raise': ['polpacci'],
            'barbell calf raise': ['polpacci'],
            'toe press': ['polpacci'],

            // Spalle
            'military press': ['spalle'],
            'shoulder press': ['spalle'],
            'dumbbell shoulder press': ['spalle'],
            'barbell shoulder press': ['spalle'],
            'arnold press': ['spalle'],
            'lateral raises': ['spalle'],
            'dumbbell lateral raises': ['spalle'],
            'cable lateral raises': ['spalle'],
            'machine lateral raises': ['spalle'],
            'front raises': ['spalle'],
            'dumbbell front raises': ['spalle'],
            'cable front raises': ['spalle'],
            'rear delt fly': ['spalle', 'dorso'],
            'face pull': ['spalle', 'dorso'],
            'rear delt machine': ['spalle', 'dorso'],
            'upright row': ['spalle'],
            'barbell upright row': ['spalle'],
            'dumbbell upright row': ['spalle'],
            'shrug': ['spalle', 'dorso'],
            'barbell shrug': ['spalle', 'dorso'],
            'dumbbell shrug': ['spalle', 'dorso'],
            'clean and press': ['spalle', 'quadricipiti'],
            'push press': ['spalle', 'quadricipiti'],
            'jerk': ['spalle', 'quadricipiti'],

            // Bicipiti
            'curl': ['bicipiti'],
            'barbell curl': ['bicipiti'],
            'dumbbell curl': ['bicipiti'],
            'hammer curl': ['bicipiti'],
            'preacher curl': ['bicipiti'],
            'concentration curl': ['bicipiti'],
            'cable curl': ['bicipiti'],
            'machine curl': ['bicipiti'],
            'zottman curl': ['bicipiti'],
            'spider curl': ['bicipiti'],
            'drag curl': ['bicipiti'],
            'reverse curl': ['bicipiti'],
            'wrist curl': ['bicipiti'],

            // Tricipiti
            'triceps extension': ['tricipiti'],
            'overhead triceps extension': ['tricipiti'],
            'dumbbell overhead extension': ['tricipiti'],
            'cable overhead extension': ['tricipiti'],
            'skull crushers': ['tricipiti'],
            'lying triceps extension': ['tricipiti'],
            'close grip bench press': ['tricipiti', 'petto'],
            'triceps pushdown': ['tricipiti'],
            'cable pushdown': ['tricipiti'],
            'rope pushdown': ['tricipiti'],
            'overhead rope extension': ['tricipiti'],
            'diamond push-ups': ['tricipiti', 'petto'],
            'kickbacks': ['tricipiti'],
            'dumbbell kickbacks': ['tricipiti'],
            'cable kickbacks': ['tricipiti'],
            'french press': ['tricipiti'],

            // Addome
            'crunch': ['addome'],
            'sit-up': ['addome'],
            'leg raise': ['addome'],
            'hanging leg raise': ['addome'],
            'plank': ['addome'],
            'side plank': ['addome'],
            'russian twist': ['addome'],
            'bicycle crunch': ['addome'],
            'mountain climber': ['addome'],
            'flutter kick': ['addome'],
            'heel touch': ['addome'],
            'v-up': ['addome'],
            'dragon flag': ['addome'],
            'ab wheel rollout': ['addome'],
            'cable crunch': ['addome'],
            'machine crunch': ['addome'],
            'decline crunch': ['addome'],
            'reverse crunch': ['addome'],
            'windshield wiper': ['addome'],
            'l-sit': ['addome'],
            'hollow body hold': ['addome'],

            // VERSIONI ITALIANE DEGLI ESERCIZI
            
            // Petto italiano
            'panca piana': ['petto'],
            'panca inclinata': ['petto', 'spalle'],
            'panca declinata': ['petto'],
            'croci con manubri': ['petto'],
            'croci ai cavi': ['petto'],
            'petto ai cavi': ['petto'],
            'petto butterfly': ['petto'],
            'petto pec deck': ['petto'],
            'petto press machine': ['petto'],
            'petto hammer strength': ['petto'],
            'petto isometric squeeze': ['petto'],

            // Dorso italiano
            'stacco da terra': ['dorso', 'bicipiti femorali'],
            'stacco rumeno': ['dorso', 'bicipiti femorali'],
            'stacco sumo': ['dorso', 'bicipiti femorali', 'quadricipiti'],
            'trazioni alla sbarra': ['dorso', 'bicipiti'],
            'trazioni alla sbarra presa larga': ['dorso'],
            'trazioni alla sbarra presa stretta': ['dorso', 'bicipiti'],
            'rematore con bilanciere': ['dorso'],
            'rematore con manubrio': ['dorso'],
            'rematore con cavi': ['dorso'],
            'rematore machine': ['dorso'],
            'hammer strength row': ['dorso'],
            'lat machine': ['dorso'],
            'tirate al petto': ['dorso'],
            'tirate al petto presa larga': ['dorso'],
            'tirate al petto presa stretta': ['dorso', 'bicipiti'],
            'face pull': ['dorso', 'spalle'],
            'rear delt fly': ['dorso', 'spalle'],
            'iperextension': ['dorso'],
            'good morning': ['dorso'],
            'shrugs': ['dorso', 'spalle'],
            'shrugs con bilanciere': ['dorso', 'spalle'],
            'shrugs con manubri': ['dorso', 'spalle'],
            'rack pull': ['dorso'],
            'stacco da deficit': ['dorso', 'bicipiti femorali'],
            'stacco presa snatch': ['dorso', 'spalle'],
            'stacco presa clean': ['dorso', 'spalle'],

            // Quadricipiti italiano
            'squat': ['quadricipiti', 'bicipiti femorali'],
            'squat frontale': ['quadricipiti', 'bicipiti femorali'],
            'hack squat': ['quadricipiti'],
            'leg press': ['quadricipiti'],
            'leg press 45°': ['quadricipiti'],
            'leg press orizzontale': ['quadricipiti'],
            'affondi camminando': ['quadricipiti', 'bicipiti femorali'],
            'affondi stazionari': ['quadricipiti', 'bicipiti femorali'],
            'affondi inversi': ['quadricipiti', 'bicipiti femorali'],
            'split squat bulgaro': ['quadricipiti', 'bicipiti femorali'],
            'step up': ['quadricipiti', 'bicipiti femorali'],
            'leg extension': ['quadricipiti'],
            'sissy squat': ['quadricipiti'],
            'wall sit': ['quadricipiti'],
            'box squat': ['quadricipiti', 'bicipiti femorali'],
            'pause squat': ['quadricipiti', 'bicipiti femorali'],
            'zercher squat': ['quadricipiti', 'bicipiti femorali'],
            'jefferson squat': ['quadricipiti', 'bicipiti femorali'],

            // Bicipiti femorali italiano
            'leg curl': ['bicipiti femorali'],
            'leg curl sdraiato': ['bicipiti femorali'],
            'leg curl seduto': ['bicipiti femorali'],
            'leg curl in piedi': ['bicipiti femorali'],
            'stacco rumeno': ['bicipiti femorali', 'dorso'],
            'stacco rumeno monopodalico': ['bicipiti femorali', 'dorso'],
            'glute ham raise': ['bicipiti femorali'],
            'nordic hamstring curl': ['bicipiti femorali'],
            'stacco gambe rigide': ['bicipiti femorali', 'dorso'],
            'stacco da deficit': ['bicipiti femorali', 'dorso'],
            'good morning': ['bicipiti femorali', 'dorso'],
            'iperextension': ['bicipiti femorali', 'dorso'],

            // Polpacci italiano
            'calf raise': ['polpacci'],
            'calf raise in piedi': ['polpacci'],
            'calf raise seduto': ['polpacci'],
            'calf raise asino': ['polpacci'],
            'calf raise monopodalico': ['polpacci'],
            'calf raise al leg press': ['polpacci'],
            'calf raise alla smith': ['polpacci'],
            'calf raise con manubri': ['polpacci'],
            'calf raise con bilanciere': ['polpacci'],
            'toe press': ['polpacci'],

            // Spalle italiano
            'military press': ['spalle'],
            'shoulder press': ['spalle'],
            'shoulder press con manubri': ['spalle'],
            'shoulder press con bilanciere': ['spalle'],
            'arnold press': ['spalle'],
            'alzate laterali': ['spalle'],
            'alzate laterali con manubri': ['spalle'],
            'alzate laterali ai cavi': ['spalle'],
            'alzate laterali alla macchina': ['spalle'],
            'alzate frontali': ['spalle'],
            'alzate frontali con manubri': ['spalle'],
            'alzate frontali ai cavi': ['spalle'],
            'rear delt fly': ['spalle', 'dorso'],
            'face pull': ['spalle', 'dorso'],
            'rear delt alla macchina': ['spalle', 'dorso'],
            'upright row': ['spalle'],
            'upright row con bilanciere': ['spalle'],
            'upright row con manubri': ['spalle'],
            'shrug': ['spalle', 'dorso'],
            'shrug con bilanciere': ['spalle', 'dorso'],
            'shrug con manubri': ['spalle', 'dorso'],
            'clean and press': ['spalle', 'quadricipiti'],
            'push press': ['spalle', 'quadricipiti'],
            'jerk': ['spalle', 'quadricipiti'],

            // Bicipiti italiano
            'curl': ['bicipiti'],
            'curl con bilanciere': ['bicipiti'],
            'curl con manubri': ['bicipiti'],
            'hammer curl': ['bicipiti'],
            'preacher curl': ['bicipiti'],
            'concentration curl': ['bicipiti'],
            'curl ai cavi': ['bicipiti'],
            'curl alla macchina': ['bicipiti'],
            'zottman curl': ['bicipiti'],
            'spider curl': ['bicipiti'],
            'drag curl': ['bicipiti'],
            'reverse curl': ['bicipiti'],
            'wrist curl': ['bicipiti'],

            // Tricipiti italiano
            'estensioni tricipiti': ['tricipiti'],
            'estensioni tricipiti sopra la testa': ['tricipiti'],
            'estensioni sopra la testa con manubri': ['tricipiti'],
            'estensioni sopra la testa ai cavi': ['tricipiti'],
            'skull crushers': ['tricipiti'],
            'estensioni tricipiti sdraiato': ['tricipiti'],
            'panca presa stretta': ['tricipiti', 'petto'],
            'pushdown tricipiti': ['tricipiti'],
            'pushdown ai cavi': ['tricipiti'],
            'pushdown con corda': ['tricipiti'],
            'estensioni sopra la testa con corda': ['tricipiti'],
            'piegamenti a diamante': ['tricipiti', 'petto'],
            'kickbacks': ['tricipiti'],
            'kickbacks con manubri': ['tricipiti'],
            'kickbacks ai cavi': ['tricipiti'],
            'french press': ['tricipiti'],

            // Addome italiano
            'crunch': ['addome'],
            'sit-up': ['addome'],
            'alzate gambe': ['addome'],
            'alzate gambe appesi': ['addome'],
            'plank': ['addome'],
            'plank laterale': ['addome'],
            'russian twist': ['addome'],
            'bicycle crunch': ['addome'],
            'mountain climber': ['addome'],
            'flutter kick': ['addome'],
            'heel touch': ['addome'],
            'v-up': ['addome'],
            'dragon flag': ['addome'],
            'ab wheel rollout': ['addome'],
            'crunch ai cavi': ['addome'],
            'crunch alla macchina': ['addome'],
            'crunch in declino': ['addome'],
            'reverse crunch': ['addome'],
            'windshield wiper': ['addome'],
            'l-sit': ['addome'],
            'hollow body hold': ['addome'],

            // ESERCIZI CARDIO (usano tempo e distanza invece di ripetizioni e peso)
            'corsa': ['cardio'],
            'running': ['cardio'],
            'jogging': ['cardio'],
            'camminata veloce': ['cardio'],
            'brisk walking': ['cardio'],
            'ciclismo': ['cardio'],
            'cycling': ['cardio'],
            'bici': ['cardio'],
            'bike': ['cardio'],
            'nuoto': ['cardio'],
            'swimming': ['cardio'],
            'crawl': ['cardio'],
            'dorso nuoto': ['cardio'],
            'backstroke': ['cardio'],
            'rana': ['cardio'],
            'breaststroke': ['cardio'],
            'farfalla': ['cardio'],
            'butterfly': ['cardio'],
            'ellittica': ['cardio'],
            'elliptical': ['cardio'],
            'tapis roulant': ['cardio'],
            'treadmill': ['cardio'],
            'cyclette': ['cardio'],
            'stationary bike': ['cardio'],
            'remoergometro': ['cardio'],
            'rowing machine': ['cardio'],
            'ski erg': ['cardio'],
            'sci di fondo': ['cardio'],
            'cross country skiing': ['cardio'],
            'step machine': ['cardio'],
            'stepper': ['cardio'],
            'salto della corda': ['cardio'],
            'jump rope': ['cardio'],
            'burpees': ['cardio'],
            'mountain climbers': ['cardio'],
            'high knees': ['cardio'],
            'butt kicks': ['cardio'],
            'sprint': ['cardio'],
            'allenamento a intervalli': ['cardio'],
            'hiit': ['cardio'],
            'tabata': ['cardio'],
            'circuit training': ['cardio']
        };

        // Funzione helper per verificare se un esercizio è cardio
        function isCardioExercise(exerciseName) {
            // Controlla se il nome contiene indicazioni di cardio
            const nameLower = exerciseName.toLowerCase();
            if (nameLower.includes('(cardio)') || nameLower.includes('cardio') || 
                nameLower.includes('cyclette') || nameLower.includes('ellittica') || 
                nameLower.includes('tapis roulant') || nameLower.includes('camminata') ||
                nameLower.includes('elliptical') || nameLower.includes('treadmill')) {
                return true;
            }
            
            // Altrimenti controlla i muscoli dal database
            const muscles = getMuscleGroupsForExercise(exerciseName);
            return muscles.includes('cardio');
        }

        // Mostra i muscoli allenati nel periodo selezionato

        // Mostra i muscoli allenati nel periodo selezionato
        function showMusclesWorked() {
            const container = document.getElementById('muscleGroupButtons');
            if (!container) return;

            const timeFilter = document.getElementById('timeFilter').value;
            const exerciseFilter = document.getElementById('exerciseFilter').value;
            
            // Filtra i workout per periodo
            let filteredWorkouts = [...workoutHistory];
            
            if (timeFilter !== 'all') {
                if (timeFilter === 'custom') {
                    const startDateInput = document.getElementById('startDate').value;
                    const endDateInput = document.getElementById('endDate').value;
                    
                    if (startDateInput && endDateInput) {
                        const startDate = new Date(startDateInput);
                        const endDate = new Date(endDateInput);
                        endDate.setHours(23, 59, 59, 999);
                        
                        filteredWorkouts = filteredWorkouts.filter(workout => {
                            const workoutDate = new Date(workout.date);
                            return workoutDate >= startDate && workoutDate <= endDate;
                        });
                    }
                } else {
                    const daysBack = parseInt(timeFilter);
                    const cutoffDate = new Date();
                    cutoffDate.setDate(cutoffDate.getDate() - daysBack);
                    
                    filteredWorkouts = filteredWorkouts.filter(workout => {
                        const workoutDate = new Date(workout.date);
                        return workoutDate >= cutoffDate;
                    });
                }
            }
            
            // Conta la frequenza di ogni muscolo allenato
            const muscleCounts = {};
            ALL_MUSCLES.forEach(muscle => muscleCounts[muscle] = 0);
            
            filteredWorkouts.forEach(workout => {
                if (workout.exercises) {
                    workout.exercises.forEach(exercise => {
                        const muscles = getMuscleGroupsForExercise(exercise.name);
                        muscles.forEach(muscle => {
                            muscleCounts[muscle]++;
                        });
                    });
                }
            });
            
            // Ordina i muscoli per frequenza
            const sortedMuscles = Object.entries(muscleCounts)
                .filter(([_, count]) => count > 0)
                .sort((a, b) => b[1] - a[1]);
            
            // Renderizza i pulsanti
            const allButton = `
                <button class="muscle-group-btn ${selectedMuscleGroup === null ? 'active' : ''}" 
                        onclick="selectMuscleGroup(null)">
                    🎯 Tutti (${sortedMuscles.reduce((sum, [_, count]) => sum + count, 0)})
                </button>
            `;
            
            const muscleButtons = sortedMuscles.map(([muscle, count]) => `
                <button class="muscle-group-btn ${selectedMuscleGroup === muscle ? 'active' : ''}" 
                        onclick="selectMuscleGroup('${muscle}')">
                    ${getMuscleEmoji(muscle)} ${capitalizeFirst(muscle)} (${count})
                </button>
            `).join('');
            
            container.innerHTML = allButton + muscleButtons;
        }

        function getMuscleEmoji(muscle) {
            const emojis = {
                'petto': '💪',
                'dorso': '🦾',
                'quadricipiti': '🦵',
                'bicipiti femorali': '🦿',
                'polpacci': '👟',
                'spalle': '🤷',
                'bicipiti': '💪',
                'tricipiti': '💪',
                'addominali': '🏋️',
                'avambracci': '🤜',
                'glutei': '🍑',
                'adduttori': '🦵',
                'trapezio': '🦾'
            };
            return emojis[muscle] || '💪';
        }

        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function selectMuscleGroup(muscle) {
            selectedMuscleGroup = muscle;
            showMusclesWorked(); // Aggiorna i pulsanti
            updateExerciseFilterOptions(); // Aggiorna la lista a tendina esercizi
            updateProgressCharts(); // Aggiorna grafici e lista
            renderProgress(); // Aggiorna la lista esercizi
        }

        // CORREZIONE BUG 3: Aggiorna opzioni filtro esercizi
        function updateExerciseFilterOptions() {
            const exerciseFilter = document.getElementById('exerciseFilter');
            const currentValue = exerciseFilter.value;
            
            // Ottieni tutti gli esercizi unici dalla cronologia
            const allExercises = new Set();
            workoutHistory.forEach(workout => {
                workout.exercises.forEach(exercise => {
                    allExercises.add(exercise.name);
                });
            });
            
            // Filtra esercizi per gruppo muscolare selezionato
            let filteredExercises = Array.from(allExercises);
            if (selectedMuscleGroup !== null) {
                filteredExercises = filteredExercises.filter(exerciseName => {
                    const muscles = getMuscleGroupsForExercise(exerciseName);
                    return muscles.includes(selectedMuscleGroup);
                });
            }
            
            // Ricostruisci le opzioni
            exerciseFilter.innerHTML = '<option value="">Tutti gli esercizi</option>' +
                filteredExercises.sort().map(exercise => 
                    `<option value="${exercise}">${exercise}</option>`
                ).join('');
            
            // Ripristina il valore selezionato se ancora valido
            if (currentValue && filteredExercises.includes(currentValue)) {
                exerciseFilter.value = currentValue;
            } else {
                exerciseFilter.value = '';
            }
        }

        function calculateProgressFromHistory() {
            const exerciseProgress = {};
            
            workoutHistory.forEach(workout => {
                workout.exercises.forEach(exercise => {
                    if (!exerciseProgress[exercise.name]) {
                        exerciseProgress[exercise.name] = [];
                    }
                    
                    exerciseProgress[exercise.name].push({
                        date: workout.date,
                        sets: exercise.sets,
                        reps: exercise.reps,
                        weight: exercise.weight,
                        volume: exercise.sets * exercise.reps * exercise.weight
                    });
                });
            });
            
            Object.keys(exerciseProgress).forEach(exerciseName => {
                exerciseProgress[exerciseName].sort((a, b) => new Date(a.date) - new Date(b.date));
            });
            
            return exerciseProgress;
        }

        // STATS FUNCTIONS
        function updateStats() {
            calculateWeeklyStreak();
        }

        function calculateWeeklyStreak() {
            if (workoutHistory.length === 0) {
                document.getElementById('weeklyStreak').textContent = '0 settimane consecutive';
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Funzione per ottenere il numero della settimana (ISO week)
            function getWeekNumber(date) {
                const d = new Date(date);
                d.setHours(0, 0, 0, 0);
                d.setDate(d.getDate() + 4 - (d.getDay() || 7));
                const yearStart = new Date(d.getFullYear(), 0, 1);
                const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
                return d.getFullYear() + '-W' + weekNo;
            }

            // Raggruppa allenamenti per settimana
            const weeksSet = new Set();
            workoutHistory.forEach(workout => {
                const workoutDate = new Date(workout.date);
                weeksSet.add(getWeekNumber(workoutDate));
            });

            // Calcola streak di settimane consecutive
            let streak = 0;
            let checkDate = new Date(today);
            
            while (true) {
                const weekNum = getWeekNumber(checkDate);
                if (weeksSet.has(weekNum)) {
                    streak++;
                    // Vai alla settimana precedente
                    checkDate.setDate(checkDate.getDate() - 7);
                } else {
                    // Se siamo nella settimana corrente e non ci sono allenamenti, prova la settimana precedente
                    if (streak === 0 && getWeekNumber(today) === weekNum) {
                        checkDate.setDate(checkDate.getDate() - 7);
                        continue;
                    }
                    break;
                }
            }

            const text = streak === 1 ? '🔥 1 settimana consecutiva' : `🔥 ${streak} settimane consecutive`;
            document.getElementById('weeklyStreak').textContent = text;
        }

        // BACK TO TOP BUTTON
        window.addEventListener('scroll', function() {
            const backToTop = document.getElementById('backToTop');
            if (window.pageYOffset > 300) {
                backToTop.classList.add('show');
            } else {
                backToTop.classList.remove('show');
            }
        });

        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        function renderHistory() {
            const container = document.getElementById('historyList');
            if (workoutHistory.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📭</div>
                        <div class="empty-state-title">Nessuna cronologia</div>
                        <div>Salva i tuoi allenamenti per visualizzarli qui</div>
                    </div>
                `;
                return;
            }

            // Controlla se ci sono allenamenti di esempio
            const hasSamples = workoutHistory.some(w => w.isSample);

            // Header per allenamenti di esempio
            let headerHtml = '';
            if (hasSamples) {
                headerHtml = `
                    <div class="sample-workouts-header" style="background:#e3f2fd;border:1px solid #2196f3;border-radius:8px;padding:15px;margin-bottom:15px;text-align:center;">
                        <div style="font-size:1.1em;font-weight:bold;color:#1976d2;margin-bottom:8px;">🎯 Allenamenti di Esempio</div>
                        <div style="color:#666;margin-bottom:10px;">Questi sono allenamenti dimostrativi per mostrarti come funziona l'app</div>
                        <button onclick="deleteAllSampleWorkouts()" style="background:#f44336;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-size:0.9em;">
                            🗑️ Cancella Tutti gli Esempi
                        </button>
                    </div>
                `;
            }

            // mostra dall'ultimo al primo
            const items = [...workoutHistory].reverse().map(w => {
                const totalExercises = w.exercises.length;
                // Calcola volume solo per esercizi non cardio
                const totalVolume = w.exercises.reduce((s, e) => {
                    if (e.isCardio) return s; // Salta esercizi cardio per il volume
                    return s + (e.sets * e.reps * (e.weight || 0));
                }, 0);

                // Genera nome workout se non presente
                const workoutName = w.schedaName || (w.exercises.length > 0 ? `${w.exercises[0].name} Workout` : 'Allenamento Personalizzato');

                // CORREZIONE BUG 1: Gestione corretta della data per la visualizzazione
                const workoutDate = new Date(w.date + 'T00:00:00'); // Forza il fuso orario locale

                // Stile speciale per allenamenti di esempio
                const isSample = w.isSample;
                const sampleStyle = isSample ? 'border-left:4px solid #2196f3;background:#f8f9fa;' : '';
                const sampleBadge = isSample ? '<span style="background:#2196f3;color:white;padding:2px 6px;border-radius:3px;font-size:0.7em;margin-left:8px;">ESEMPIO</span>' : '';

                return `
                    <div class="history-item" data-id="${w.id}" style="${sampleStyle}">
                        <div class="history-content">
                            <h3>${workoutDate.toLocaleDateString('it-IT', { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric' })}${sampleBadge}</h3>
                            <div class="history-workout-name">${workoutName}</div>
                            <div class="history-summary">${totalExercises} esercizi • ${w.duration || 0} min • Volume ${Math.round(totalVolume)}kg</div>
                        </div>
                        <div style="display:flex;align-items:center;">
                            <div class="history-duration">${w.duration || 0}m</div>
                            <button class="history-delete-btn" onclick="deleteHistoryItem('${w.id}'); event.stopPropagation();">🗑️</button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = headerHtml + items;
        }

        // CORREZIONE BUG 2: Eliminazione basata su ID univoco con event.stopPropagation()
        function deleteHistoryItem(id) {
            if (!confirm('Eliminare questa voce dalla cronologia?')) return;
            
            const index = workoutHistory.findIndex(workout => workout.id == id);
            if (index !== -1) {
                workoutHistory.splice(index, 1);
                localStorage.setItem('workoutHistory', JSON.stringify(workoutHistory));
                updateStats();
                renderHistory();
                renderProgress();
                updateExerciseFilterOptions();
                if (weightChart || volumeChart) {
                    updateProgressCharts();
                }
                renderCalendar();
            }
        }

        // CANCELLA TUTTI GLI ALLENAMENTI DI ESEMPIO
        function deleteAllSampleWorkouts() {
            if (!confirm('Sei sicuro di voler cancellare tutti gli allenamenti di esempio? Questa azione non può essere annullata.')) return;

            // Filtra per rimuovere solo gli allenamenti di esempio
            const originalLength = workoutHistory.length;
            workoutHistory = workoutHistory.filter(workout => !workout.isSample);

            if (workoutHistory.length < originalLength) {
                localStorage.setItem('workoutHistory', JSON.stringify(workoutHistory));
                updateStats();
                renderHistory();
                renderProgress();
                updateExerciseFilterOptions();
                if (weightChart || volumeChart) {
                    updateProgressCharts();
                }
                renderCalendar();
                alert('Allenamenti di esempio cancellati con successo!');
            }
        }

        // CALENDAR - CORREZIONE BUG 1: Gestione corretta delle date nel calendario
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const title = document.getElementById('calendarTitle');

            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);

            title.textContent = firstDay.toLocaleDateString('it-IT', { month: 'long', year: 'numeric' });

            // giorni della settimana header
            const dayHeaders = ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'];
            const headerHtml = dayHeaders.map(d => `<div class="calendar-day-header">${d}</div>`).join('');

            // calcola offset (coerente con lunedì come primo giorno)
            const startOffset = (firstDay.getDay() + 6) % 7; // converti domenica(0)->6, lunedì(1)->0

            let cells = '';
            // giorni del mese precedente
            const prevMonthDays = startOffset;
            const prevMonthLastDate = new Date(year, month, 0).getDate();
            for (let i = prevMonthDays - 1; i >= 0; i--) {
                const d = prevMonthLastDate - i;
                cells += `<div class="calendar-day other-month">${d}</div>`;
            }

            // giorni del mese corrente
            for (let d = 1; d <= lastDay.getDate(); d++) {
                const dayDate = new Date(year, month, d);
                // CORREZIONE CALENDARIO: Usa il formato locale per il confronto
                const iso = dayDate.getFullYear() + '-' + 
                           String(dayDate.getMonth() + 1).padStart(2, '0') + '-' + 
                           String(dayDate.getDate()).padStart(2, '0');
                const classes = ['calendar-day'];
                
                // CORREZIONE: Confronto date normalizzate
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                dayDate.setHours(0, 0, 0, 0);
                
                if (dayDate.getTime() === today.getTime()) {
                    classes.push('today');
                }
                
                // check if has workout
                const hasWorkout = workoutHistory.some(w => w.date === iso);
                if (hasWorkout) classes.push('has-workout');

                cells += `<div class="${classes.join(' ')}" onclick="openHistoryForDate('${iso}')">${d}</div>`;
            }

            // fill remaining cells to complete the grid
            const remaining = (Math.ceil((startOffset + lastDay.getDate()) / 7) * 7) - (startOffset + lastDay.getDate());
            for (let i = 1; i <= remaining; i++) {
                cells += `<div class="calendar-day other-month">${i}</div>`;
            }

            grid.innerHTML = headerHtml + cells;
        }

        function changeMonth(offset) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + offset);
            renderCalendar();
        }

        function openHistoryForDate(isoDate) {
            // mostra i workout di quel giorno nella sezione history (o finestra)
            const workouts = workoutHistory.filter(w => w.date === isoDate);
            if (workouts.length === 0) {
                alert('Nessun allenamento per questa data');
                return;
            }

            // scorri i workout per quella data (primo)
            const w = workouts[0];
            // CORREZIONE BUG 1: Gestione corretta della data per la visualizzazione
            const workoutDate = new Date(w.date + 'T00:00:00');
            let msg = `Data: ${workoutDate.toLocaleDateString('it-IT')}\nDurata: ${w.duration || 0} min\n\nEsercizi:\n`;
            w.exercises.forEach(e => {
                msg += `• ${e.name} — ${e.sets}x${e.reps} @ ${e.weight}kg\n`;
            });
            if (w.notes) msg += `\nNote: ${w.notes}`;
            alert(msg);
        }

        // SCHEDE PERSONALI
        function showPersonalSchedeModal() {
            const code = prompt('Inserisci il codice per sbloccare schede personali:');
            if (!code) return;

            // Controlla se il codice è valido
            if (!codeMappings[code]) {
                alert('Codice non valido. Riprova con un codice corretto.');
                return;
            }

            // Sblocca il codice per la sessione corrente (anche se già sbloccato)
            if (!unlockedCodes.includes(code)) {
                unlockedCodes.push(code);
                localStorage.setItem('unlockedCodes', JSON.stringify(unlockedCodes));
            }

            renderSchedaButtons();
            renderSchedaEditors();
            alert(`Codice "${code}" sbloccato con successo! Ora puoi vedere le schede corrispondenti.`);
        }

        // SCARICA PDF
        function downloadSchedePdf() {
            if (!confirm('Vuoi scaricare tutte le schede in PDF?')) return;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Funzione per rimuovere emoticon e caratteri speciali
            function cleanText(text) {
                // Rimuovi emoticon e caratteri Unicode speciali
                return text.replace(/[^\x20-\x7E]/g, '').trim();
            }

            // Header elegante
            doc.setFillColor(30, 58, 138); // Blu scuro
            doc.rect(0, 0, 210, 40, 'F');

            // Titolo principale con stile
            doc.setFontSize(28);
            doc.setTextColor(255, 255, 255); // Bianco
            doc.setFont('helvetica', 'bold');
            doc.text('APP PALESTRA 3', 20, 20);

            doc.setFontSize(14);
            doc.setFont('helvetica', 'normal');
            doc.text('Le Tue Schede di Allenamento', 20, 30);

            // Data di generazione
            doc.setFontSize(10);
            doc.setTextColor(200, 200, 200);
            const today = new Date().toLocaleDateString('it-IT', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            doc.text(`Generato il ${today}`, 150, 35);

            let y = 60;
            let schedaCount = 0;

            Object.entries(customSchede).forEach(([id, scheda]) => {
                schedaCount++;
                if (y > 220) {
                    doc.addPage();

                    // Header su ogni pagina
                    doc.setFillColor(30, 58, 138);
                    doc.rect(0, 0, 210, 30, 'F');
                    doc.setFontSize(18);
                    doc.setTextColor(255, 255, 255);
                    doc.setFont('helvetica', 'bold');
                    doc.text('APP PALESTRA 3 - Continuazione', 20, 20);
                    y = 50;
                }

                // Box per ogni scheda
                doc.setFillColor(240, 240, 240);
                doc.rect(15, y - 5, 180, 35, 'F');

                // Numero scheda
                doc.setFontSize(12);
                doc.setTextColor(30, 58, 138);
                doc.setFont('helvetica', 'bold');
                doc.text(`SCHEDA ${schedaCount}`, 20, y);

                // Nome scheda pulito
                const cleanName = cleanText(scheda.name);
                doc.setFontSize(16);
                doc.setTextColor(34, 139, 34); // Verde scuro
                doc.setFont('helvetica', 'bold');
                doc.text(cleanName, 20, y + 8);

                y += 20;

                // Linea decorativa
                doc.setDrawColor(30, 58, 138);
                doc.setLineWidth(0.5);
                doc.line(20, y - 2, 190, y - 2);

                y += 8;

                // Esercizi con stile migliorato
                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0); // Nero
                doc.setFont('helvetica', 'normal');

                scheda.exercises.forEach((exercise, index) => {
                    const cleanExerciseName = cleanText(exercise.name);
                    let exerciseText = `${index + 1}. ${cleanExerciseName}`;

                    if (exercise.isCardio) {
                        exerciseText += ` - ${exercise.duration || 'N/A'}`;
                    } else {
                        exerciseText += ` - ${exercise.sets}×${exercise.reps}`;
                        if (exercise.weight > 0) exerciseText += ` @ ${exercise.weight}kg`;
                    }

                    doc.text(exerciseText, 25, y);
                    y += 6;
                });

                y += 15; // Spazio extra tra schede
            });

            // Footer elegante
            const pageCount = doc.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.setFont('helvetica', 'italic');
                doc.text(`App Palestra 3 - Pagina ${i} di ${pageCount}`, 20, 285);
            }

            doc.save('le_mie_schede_palestra.pdf');
        }

        // CANCELLA TUTTE LE SCHEDE
        function deleteAllSchede() {
            showDeleteSchedeModal();
        }

        function showDeleteSchedeModal() {
            const container = document.getElementById('schedeSelectionList');
            container.innerHTML = '';

            // Aggiungi schede normali
            Object.keys(customSchede).forEach(key => {
                if (key !== 'push' && key !== 'pull' && key !== 'legs' && key !== 'cardio') {
                    const scheda = customSchede[key];
                    const exerciseCount = scheda.exercises ? scheda.exercises.length : 0;
                    
                    container.innerHTML += `
                        <div class="scheda-selection-item" onclick="toggleSchedaCheckbox('${key}')">
                            <input type="checkbox" id="checkbox-${key}" value="${key}" data-type="normal" onclick="event.stopPropagation()">
                            <div class="scheda-info">
                                <div class="scheda-name">${scheda.name}</div>
                                <div class="scheda-details">${exerciseCount} esercizi</div>
                            </div>
                        </div>
                    `;
                }
            });

            // Aggiungi schede protette (quelle di default)
            const protectedSchede = ['push', 'pull', 'legs', 'cardio'];
            protectedSchede.forEach(key => {
                if (customSchede[key]) {
                    const scheda = customSchede[key];
                    const exerciseCount = scheda.exercises ? scheda.exercises.length : 0;
                    
                    container.innerHTML += `
                        <div class="scheda-selection-item" onclick="toggleSchedaCheckbox('${key}')">
                            <input type="checkbox" id="checkbox-${key}" value="${key}" data-type="protected" onclick="event.stopPropagation()">
                            <div class="scheda-info">
                                <div class="scheda-name">${scheda.name} (Protetta)</div>
                                <div class="scheda-details">${exerciseCount} esercizi</div>
                            </div>
                        </div>
                    `;
                }
            });

            // Aggiungi schede sbloccate
            getUnlockedProtectedSchede().forEach(([key, scheda]) => {
                const exerciseCount = scheda.exercises ? scheda.exercises.length : 0;
                
                container.innerHTML += `
                    <div class="scheda-selection-item" onclick="toggleSchedaCheckbox('${key}')">
                        <input type="checkbox" id="checkbox-${key}" value="${key}" data-type="unlocked" onclick="event.stopPropagation()">
                        <div class="scheda-info">
                            <div class="scheda-name">${scheda.name} (Sbloccata)</div>
                            <div class="scheda-details">${exerciseCount} esercizi</div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('deleteSchedeModal').classList.add('show');
        }

        function toggleSchedaCheckbox(key) {
            const checkbox = document.getElementById('checkbox-' + key);
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
            }
        }

        function confirmDeleteSelectedSchede() {
            const selectedSchede = [];
            document.querySelectorAll('#schedeSelectionList input[type="checkbox"]:checked').forEach(checkbox => {
                selectedSchede.push({
                    key: checkbox.value,
                    type: checkbox.dataset.type
                });
            });

            if (selectedSchede.length === 0) {
                alert('Seleziona almeno una scheda da eliminare.');
                return;
            }

            const confirmMessage = `Conferma eliminazione di ${selectedSchede.length} scheda(e)?`;
            if (!confirm(confirmMessage)) return;

            selectedSchede.forEach(scheda => {
                if (scheda.type === 'unlocked') {
                    // Rimuovi il codice che sblocca questa scheda
                    const codesToRemove = new Set();
                    Object.entries(codeMappings).forEach(([code, ids]) => {
                        if (ids.includes(scheda.key)) {
                            codesToRemove.add(code);
                        }
                    });
                    unlockedCodes = unlockedCodes.filter(code => !codesToRemove.has(code));
                    localStorage.setItem('unlockedCodes', JSON.stringify(unlockedCodes));
                } else {
                    delete customSchede[scheda.key];
                }
            });

            saveSchede();
            renderSchedaButtons();
            renderSchedaEditors();
            
            document.getElementById('deleteSchedeModal').classList.remove('show');
            alert(`${selectedSchede.length} scheda(e) eliminata(e) con successo.`);
        }

        function cancelDeleteSchede() {
            document.getElementById('deleteSchedeModal').classList.remove('show');
        }

        // INIZIALIZZAZIONE FINALE
        updateStats();
        renderProgress();
        renderHistory();
        renderCalendar();
    </script>

</body>
</html>

